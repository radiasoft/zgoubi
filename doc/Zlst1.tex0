% \part{Description of software contents}{Description of software contents}

\section{INTRODUCTION} 

The computer code \zgou\  calculates trajectories of
charged particles in magnetic and electric fields.  At the origin specially adapted to the definition and adjustment of 
beam lines and magnetic spectrometers, it has so evolved that it allows the study of systems including complex
 sequences of optical elements such as dipoles, quadrupoles, 
 arbitrary multipoles and other magnetic or electric
 devices, and is able as well to handle periodic structures.  Compared to other codes, it presents several peculiarities: 
\begin{itemize}
\item a numerical method for integrating the Lorentz equation, based on Taylor series,
	which optimizes computing time and provides high accuracy and strong symplecticity,
\item spin tracking, using the same numerical method as for the Lorentz equation,
\item calculation of the synchrotron radiation electric field and 
spectra in arbitrary magnetic fields, from the ray-tracing outcomes,
\item the possibility of using a mesh, which allows ray-tracing from
	simulated or measured (1-D, 2-D or 3-D) field maps, 
\item Monte Carlo procedures: unlimited number of trajectories, in-flight decay, etc. 
\item a built-in fitting procedure,
\item multiturn tracking in circular accelerators including many features proper to machine parameter 
calculation and survey, and also the simulation of time-varying 
	power  supplies. 
\end{itemize}

\noindent The initial  version of the Code, dedicated to the ray-tracing in magnetic fields,
 was developed  by D.~Garreta and J.C.~Faivre  at CEN-Saclay in the early 1970's.
 It was perfected for the purpose of studying the four spectrometers (SPES I, II, III, IV) 
at the  Laboratoire National Saturne (CEA-Saclay, France), and SPEG at Ganil 
(Caen, France). It is now in use in several national and foreign laboratories.
\\
\\
\noindent The first manual was in French~\cite{Biblio1}. %%%%biblio  [1]
 Since then many improvements have been implemented.  In order to facilitate access to 
the program an English version of the manual was written at TRIUMF with the assistance of 
J.~Doornbos. P.~Stewart prepared the manuscript for publication~\cite{Biblio2}%biblio[2]
\\
\\
\noindent  An updating was necessary for accompanying the third version of the code which featured 
 spin tracking and ray-tracing in combined electric and magnetic fields; 
 this was done with the help of 
D.~Bunel for the preparation of the document and lead to the third 
release \cite{Biblio2b}.
\\
\\
\noindent Lately, provisions were introduced for the computation of 
synchrotron radiation electromagnetic impulse and spectra. In the mean 
time, several new optical elements were added, such as 
electro-magnetic and other electrostatic lenses. Used since several years for special studies in periodic
machines (e.g., SATURNE at Saclay, COSY at Julich, LEP and LHC at Cern),  \zgou\  has also benefited from extensive development of storage ring related features.
\\
\\
The graphic  interface to \zgou\ (Part D) has also undergone concomitent extended 
developments, which make it a performant tool for post-processing \zgou\  outputs.
\\
\\
\noindent These recent developments of \zgou\ 
\cite[and the present version of the guide]{Biblio1,Biblio2,Biblio2b}   
              %%[1, 2 and thepresent version of the guide]  %%%%biblio
 have strongly benefited of the environment of the Groupe Th\'eorie, 
Laboratoire National SATURNE, CEA/DSM-Saclay. 
\\
\\
\noindent  This manual is intended only to describe the details of the most
recent version of \zgou, which is far from being a ``finished product''.

\newpage
\clearemptydoublepage

\section{NUMERICAL CALCULATION OF MOTION AND FIELDS}\label{sec2} %%2
\subsection{Zgoubi Frame} \label{sec2.1}   %%2.1

The reference frame of \zgou\  is presented in Fig~\ref{fig1}.  
Its origin is in the median plane on a reference curve which coincides with the optical 
axis of optical elements. 

\subsection{Integration of Lorentz Equation} \label{sec2.2}%%%2.2

The Lorentz equation, which governs the motion of a particle of charge $q$,  
mass $m$ and velocity $\vec  v$ in electric and magnetic fields $\vec  e$ and $\vec  b$, is written 
\begin{equation}
\frac{d(m\vec  v)}{dt} = q\, (\vec  e + \vec  v \times  \vec  b)  \label{eq2-2-1}
\end{equation}

%%%%%%%%%%%%%%figure%%%%%%%%%%%%%%
\vspace{.5cm}
\begin{figure}[H]
%\vspace{11 truecm}
%%%Figure 1
\centerline{\includegraphics[width=14cm]{Fig1.ps}}
\hangcaption[Fig 1]{\label{fig1}Reference frame and coordinates ($Y$, 
$T$, $Z$, $P$) in \zgou.\\
$ OX$:  in the plane of the reference curve in the direction of motion,\\										  %
$ OY$:  in the plane of the reference curve, normal to $OX$,\\
$ OZ$:  orthogonal to the $(X, Y)$ plane,\\				  
$ \vec{W}$:  projection of the velocity, $ \vec	v $, in	the	$(X, Y)$ plane,\\									  %
$ T$  =	 angle between $\vec{W}$ and the  $X$-axis,\\
$ P$  =	 angle between $\vec{W}$ and $	\vec  v	$. } 
\end{figure}
\vspace{.3cm}



Taking
\begin{equation}
\vec  u = \frac{\vec  v }{v},\quad
    	ds = v\,dt,\quad
		\vec  u^{\,\prime}  =\frac{d\vec  u }{ds},\quad
			 m\vec  v = mv\vec  u = q\, B\rho \, \vec  u \label{eq2-2-2}
\end{equation}
 where $ B\rho $ is the rigidity of the particle, this equation can be rewritten 

\begin{equation}
(B\rho )^\prime  \vec  u+B\rho \,\vec  u^{\,\prime}  
	=  \frac{\vec  e }{v}  + \vec  u  \times   \vec  b   \label{eq2-2-3}
\end{equation}

\noindent From position $ \vec  R(M_0) $ and unit velocity $ \vec  u(M_0) $ at
point $ M_0 $, position $ \vec  R(M_1) $ and unit velocity $ \vec  u(M_1) $ 
at point $ M_1 $ following a 
displacement  $ \Delta s $, are given by Taylor expansions (Fig.~\ref{fig2})  

\begin{equation}
\begin{aligned}
\vec  R(M_1)  &  =  \vec  R(M_0) + \vec  u(M_0)\, \Delta s+ \vec  u^{\,\prime} (M_0)\,
	\dfrac{\Delta s^2 }{2!}  +  ...+ \vec  u^{\cinqprime} (M_0)\,
	\dfrac{\Delta s^6 }{6!} \\
\vec  u(M_1) & =  \vec u(M_0)  + \vec  u^{\,\prime} (M_0)\,\Delta s  + \vec  u^{\,\prime\prime} (M_0)\,
	\dfrac{\Delta s^2 }{2!}  +   ...+ \vec  u^{\cinqprime} (M_0)\,
	\dfrac{\Delta s^5 }{5!} 
\end{aligned}\label{eq2-2-4}
\end{equation}

\noindent The rigidity at $ M_1 $ is obtained in the same way from
\begin{equation}
 (B\rho )(M_1) = (B\rho )(M_0)+(B\rho )^\prime (M_0)\Delta s+...+
	(B\rho)^{\quaprime} (M_0) \frac{\Delta s^4 }{4!}   	\label{eq2-2-5}
\end{equation}

\noindent The derivatives $\vec  u^{(n)} = \dfrac{d^n\vec  u}{ds^n}$ and 
$ (B\rho )^{(n)} = \dfrac{d^n(B\rho )}{ds^n} $
involved in these expressions are calculated as described in the next sections. 
For the sake of computing speed, three distinct software procedures are involved, depending on 
whether $\vec e$ or $\vec  b$ is zero, or $ \vec e$ and $ \vec b$ are 
both non-zero.

%%%%%%%%%%%%%%%%%%%%figure%%%%%%%%%%%%%%%%%%%%%
\begin{figure}[H]
%\vspace{10 truecm}
%%%Figure 2: 
\centerline{\includegraphics[width=14cm]{Fig2.ps}}
\caption{\label{fig2}Position and velocity of a particle in the reference frame.}
\end{figure}

\subsubsection{Integration in magnetic fields} \label{sec2.2.1}  %% 2.2.1.

Admitting that $ \vec  e=0, $ and noting $ \vec B=\dfrac{\vec  b}{B\rho} $, 
eq.~(\ref{eq2-2-3}) 
reduces to 
$$ \vec  u^{\,\prime}  = \vec  u  \times  \vec  B $$

\noindent The successive derivatives $\vec  u^{(n)} = \dfrac{d^n\vec  u }{ds^n} $ of 
$ \vec  u $ needed in the Taylor expansions (Eqs.~\ref{eq2-2-4}) are calculated by differentiating 
$ \vec  u^{\,\prime}            =\vec  u  \times  \vec  B$ 

\begin{equation}
	\begin{aligned}
		\vec  u^{\,\prime\prime}
		         &   =   \vec  u^{\,\prime}   \times   \vec  B + \vec  u  \times  
		         \vec B^{\,\prime} \\
		\vec u^{\,\prime\prime\prime}
		         & = \vec  u^{\,\prime\prime}   \times   \vec  B 
		         + 2\vec  u^{\,\prime}  \times   \vec  B^{\,\prime}  
		         + \vec  u \times  \vec  B^{\,\prime\prime} \\
		\vec u^{\quaprime} 
		         &   =  \vec u^{\,\prime\prime\prime}  \times   \vec  B 
		         + 3\vec  u^{\,\prime\prime}   \times  \vec  B^{\,\prime}  
		         + 3\vec  u^{\,\prime}   \times   \vec  B^{\,\prime\prime}   
		         +\vec	u  \times  \vec  B^{\,\prime\prime\prime} \\
		\vec  u^{\cinqprime}
		         &  =  \vec u^{\quaprime}  \times \vec  B 
		         + 4\vec u^{\,\prime\prime\prime}  \times  \vec  B^{\,\prime}  
		         + 6\vec  u^{\,\prime\prime} \times   \vec  B^{\,\prime\prime}  
		         + 4\vec  u^{\,\prime}   \times   \vec B^{\,\prime\prime\prime} 
		         + \vec  u  \times   \vec  B^{\quaprime}
	\end{aligned}
	\label{eq2-2-6}
\end{equation}
%
 where $ \vec  B^{(n)} = \dfrac{d^n\vec  B}{ds^n}$. 

\noindent From $ d\vec  B = \dfrac{\partial\vec  B}{\partial X}\, dX
     +\dfrac{\partial\vec  B}{\partial Y}\, dY+
     \dfrac{\partial\vec  B}{\partial Z}\, dZ
     = \sum_{i=1,3}\dfrac{\partial\vec  B}{\partial X_i}\, dX_i$,  
and by successive differentiation, we get 

 \begin{equation}
	 \begin{aligned}
		 \vec  B^{\,\prime} =
		        &   \sum_i  \dfrac{\partial\vec  B}{\partial X_i}\, u_i \\
		 \vec  B^{\,\prime\prime} =
		        &  \sum_{ij}\dfrac{\partial^2\vec  B}{\partial X_i\partial X_j} 
		        \, u_i u_j+ \sum_i \dfrac{\partial\vec  B}{\partial X_i} \,u^{\,\prime}_i\\
		\vec  B^{\,\prime\prime\prime}  =
		        &  \sum_{ijk} \dfrac{\partial^3\vec  B}{\partial X_i\partial X_j\partial X_k}
		           \, u_i u_j u_k 
		           + 3 \sum_{ij} \dfrac{\partial^ 2\vec  B}{\partial X_i\partial X_j} \,u^{\prime}_i
		           u_j 
		           + \sum_i\frac{\partial\vec  B}{\partial X_i} \, u^{\prime\prime}_i \\
		\vec B^{\quaprime}  = 
		        & \sum_{ijkl} \dfrac{\partial^ 4\vec  B}{\partial X_i\partial X_j\partial
		           X_k\partial X_l} \,u_i u_j u_k u_l 
		           + 6 \sum_{ijk}  \dfrac{\partial^ 3\vec  B}{\partial X_i\partial X_j\partial X_k} \,
		           u^{\prime}_i u_j u_k \\
		 %
		        &
		        +  4 \sum_{ij} \dfrac{\partial^ 2\vec  B}{\partial X_i\partial X_j}\,
		         u^{\prime\prime}_i u_j
		         + 3 \sum_{ij} \dfrac{\partial^ 2\vec  B}{\partial X_i\partial X_j}\,
		         u^{\prime}_i u^{\prime}_j 
		         + \sum_i \dfrac{\partial\vec  B}{\partial X_i}\, u^{\prime\prime \prime}_i 
	 \end{aligned}
 	\label{eq2-2-7}
 \end{equation} 
 
 \noindent From the knowledge of $ \vec  u(M_0) $ and $ \vec  B(M_0) $ at point
$ M_0 $ of the 
trajectory, we calculate alternately the derivatives of $ \vec  u(M_0) $ and 
$ \vec  B(M_0) $, by means of Eqs.~(\ref{eq2-2-6}) and (\ref{eq2-2-7}), and inject it in 
Eq.~(\ref{eq2-2-4}) to get 
$ \vec  R(M_1) $ and $ \vec  u(M_1) $.

\subsubsection[Integration in electric fields]%
       {Integration in electric fields \protect\cite{Biblio6}}
        \label{sec2.2.2} %%%% 2.2.2.[3]

Admitting that $ \vec  b=0, $ eq.~(\ref{eq2-2-3}) reduces to 

\begin{equation}
	(B\rho )^\prime\vec  u + B\rho\vec  u^{\,\prime} = \dfrac{\vec  e}{ v}
	\label{eq2-2-8}
\end{equation} 
%
which, by successive differentiations, gives the recursive relations

\begin{equation}
	\begin{array}{l}
		(B\rho )^\prime\vec  u + B\rho\vec  u^{\,\prime}   = \dfrac{\vec e}{ v}\\
		 (B\rho )^{\prime\prime}\vec  u + 2 (B\rho)^\prime \vec  u^{\,\prime} 
		     +B\rho\vec  u^{\,\prime\prime}   = \left(\dfrac{1}{v}\right)^\prime\vec  e 
		         + \dfrac{\vec  e^{\,\prime}}{v} \\
		(B\rho)^{\prime\prime\prime}\vec  u + 3(B\rho)^{\prime\prime}\vec  u^{\,\prime}
		      + 3(B\rho)^\prime \vec  u^{\,\prime\prime} 
		      +B \rho\vec  u^{\prime\prime\prime}   =
		      \left(\dfrac{1}{ v}\right)^{\prime\prime}\vec  e +
		      2\left( \dfrac{1}{v}\right)^\prime \vec  e^{\,\prime} 
		      +\left(\dfrac{1}{v}\right)\, \vec  e^{\,\prime\prime}\\
		(B\rho )^{\quaprime} \vec u + 4(B\rho)^{\prime\prime\prime} \vec  u^{\,\prime} 
		      + 6(B\rho)^{\prime\prime}\vec  u^{\,\prime\prime} 
		      +4 (B\rho)^\prime\vec  u^{\,\prime\prime\prime} 
		      +B\rho\vec  u^{\quaprime} = \\
		%
		\hphantom{(B\rho )^{\quaprime} \vec u}
		\left(\dfrac{1}{v}\right)^{\prime\prime\prime}\vec e
		      +3\left(\dfrac{1}{v}\right)^{\prime\prime}\vec  e^{\,\prime} 
		      +3\left(\dfrac{1}{ v}\right)^\prime\vec e^{\,\prime\prime} +
		      \dfrac{1}{v} \,\vec  e^{\,\prime\prime\prime}
	\end{array}
	\label{eq2-2-9}
\end{equation} 
%
that provide the derivatives $ \dfrac{d^n\vec  u}{ds^n}$ needed in the Taylor 
expansions~(\ref{eq2-2-4})

\begin{equation}
	\begin{aligned}
		\vec  u^{\,\prime} 
		       & =  \left(\dfrac{1}{v}\right)\, \vec  E 
		             - \dfrac{(B\rho )^\prime}{B\rho} \, \vec  u\\
		\vec u^{\,\prime\prime} 
		       & =  \left(\dfrac{1}{v}\right)^\prime \vec  E 
		            + \left(\dfrac{1}{v}\right)\, \vec  E^{\,\prime} 
		            \mid_{ B\rho}  -2 \dfrac{(B\rho )^\prime }{ B\rho} 
		             \vec  u^{\,\prime} -
		             \dfrac{(B\rho)^{\prime\prime}}{B\rho}  \vec  u \\
	    \vec  u^{\,\prime\prime\prime} 
	           &  = \left( \dfrac{1}{v}\right)^{\prime\prime}\vec  E
	               +2\left(\dfrac{1}{v}\right)^\prime \vec  E^{\,\prime} 
	               \mid_{ B\rho} +\dfrac{1}{v} \vec  E^{\,\prime\prime} 
	               \mid_{ B\rho} -3 \dfrac{(B\rho )^\prime }{B\rho}  \vec  u^{\,\prime\prime} 
	               -3 \dfrac{(B\rho )^{\prime\prime}}{B\rho}  \vec u^{\,\prime} 
	               - \dfrac{(B\rho )^{\prime\prime\prime} }{B\rho}  \vec  u \\
		\vec  u^{\quaprime}
		      & =  \left(\dfrac{1}{v}\right)^{\prime\prime\prime}  \vec  E 
		           +3\left(\dfrac{1}{v}\right)^{\prime\prime}\vec E^{\,\prime} \mid_{ B\rho} 
		           +3\left( \dfrac{1}{v}\right)^\prime \vec  E^{\,\prime\prime} \mid_{B\rho} 
		           +\left(\dfrac{1}{v}\right)\,\vec  E^{\,\prime\prime\prime} \mid_{B\rho} \\
		%
		      &  \qquad -4 \dfrac{(B\rho )^\prime }{B\rho}  \vec  u^{\,\prime\prime\prime} 
		           -6 \dfrac{(B\rho )^{\prime\prime}}{B\rho}  \vec  u^{\,\prime\prime} 
		           -4 \dfrac{(B\rho )^{\prime\prime\prime} }{B\rho}  \vec  u^{\,\prime} 
		           - \dfrac{(B\rho )^{\quaprime}}{B\rho}  \vec  u
	\end{aligned}
	\label{eq2-2-10}
\end{equation}
%
where $ \vec  E=\dfrac{\vec  e}{B\rho} $, and $^{(n)}\mid_{ B\rho} $ 
denotes differentiation at constant $ B\rho$:  
$ \vec E^{(n)}\mid_{ B\rho} =   \dfrac{ 1}{B\rho} \dfrac{d^n\vec  e }{ds^n}$.  
These derivatives of the electric field are obtained from the total 
derivative

 \begin{equation}
	 d\vec  E = \dfrac{\partial\vec  E}{\partial X}\, dX + 
	 \dfrac{\partial\vec  E }{\partial Y} \, dY + 
	 \dfrac{\partial\vec  E }{ \partial Z} \, dZ
 	\label{eq2-2-11}
 \end{equation} 
%
 by successive differentiations

\begin{equation}
	\begin{aligned}
		\vec  E^{\,\prime} 
		     & =   \sum_ i \dfrac{\partial\vec  E}{\partial X_i} \,u_i \\
		\vec  E^{\,\prime\prime} 
		     & =  \sum_{ij} \dfrac{\partial^ 2\vec  E}{\partial X_i\partial X_j}\, u_i u_j 
		       +\sum_i \dfrac{\partial\vec  E}{\partial X_i} \,u^{\prime}_i \\
		\vec  E^{\,\prime\prime\prime} 
		     & =  \sum_{ijk} \dfrac{\partial^ 3\vec  E }{\partial X_i\partial X_j\partial X_k}\,
		        u_i u_j u_k 
		        + 3 \sum_{ij} \dfrac{\partial^ 2\vec  E}{\partial X_i\partial X_j} \,u^{\prime}_i u_j 
		        + \sum_i \dfrac{\partial\vec  E}{\partial X_i} \,u^{\prime\prime}_i 
	\end{aligned}
	\label{eq2-2-12}
\end{equation}

\noindent These eq.~(\ref{eq2-2-10}), as well as the calculation of the rigidity, following 
eq.~(\ref{eq2-2-5}), involve 
derivatives $ (B\rho)^{(n)} =  \dfrac{ d^n(B\rho )}{ds^n} $, which
are obtained in the following way. 
Considering that 

\begin{equation}
	\dfrac{dp^2 }{dt} = \dfrac{d\vec  p^{2} }{ dt}
	\quad \text{\emph{i.e.,}} \quad 
	\dfrac{dp}{dt}\, p = \dfrac{d\vec  p}{dt} \vec  p
	\label{eq2-2-13}
\end{equation}
%
with $ \dfrac{ d\vec  p }{ dt} = q\,(\vec  e +\vec v\times\vec  b) $ 
(eq.~\ref{eq2-2-1}), we obtain

\begin{equation}
	\dfrac{dp }{ dt} \,p =  q\,(\vec  e + v\times\vec  b)\cdot \vec  p =q\vec  e \cdot \vec  p
	\label{eq2-2-14}
\end{equation}
%
since $ (\vec  v\times\vec  b) \cdot \vec  p=0$.  Normalizing as
previously with $ \vec  p=p\vec  u=qB\rho\vec  u $ and $ ds=vdt$,  and 
by successive differentiations, eq.~(\ref{eq2-2-14}) leads to the $ (B\rho )^{(n)} $

\begin{equation}
	\begin{aligned}
		(B\rho )^\prime 
		      & =  \dfrac{ 1 }{ v}\, (\vec  e \cdot \vec  u) \\
		(B\rho)^{\prime\prime}
		      & =  \left(\dfrac{1 }{ v}\right)^\prime
		        (\vec  e \cdot \vec  u) +
		        \dfrac{1 }{ v}\, (\vec  e\cdot\vec  u)^\prime \\
		(B\rho )^{\prime\prime\prime}
		      & =  \left(\dfrac{1 }{ v}\right)^{\prime\prime} (\vec  e\cdot\vec  u)
		        +2\left(\dfrac{1 }{v}\right)^\prime (\vec  e\cdot\vec  u)^\prime 
		        +\dfrac{1 }{ v}\, (\vec  e\cdot\vec u)^{\prime\prime} \\
	    (B\rho )^{\quaprime} 
	          & =  \left(\dfrac{1 }{v}\right)^{\prime\prime\prime} (\vec  e\cdot\vec  u)
	            +3\left(\dfrac{1 }{ v}\right)^{\prime\prime}(\vec  e\cdot\vec  u)^\prime 
	            +3\left(\dfrac{1 }{ v}\right)^\prime (\vec  e\cdot\vec u)^{\prime\prime} 
	            + \dfrac{1 }{ v}\, (\vec  e\cdot\vec  u)^{\prime\prime\prime}
	\end{aligned}
	\label{eq2-2-15}
\end{equation}

\noindent Note that the derivatives $ (\vec  e \cdot \vec  u)^{(n)} = 
\dfrac{ d^n(\vec e\cdot\vec  u) }{ ds^n} $ can be related to the derivatives of the 
kinetic energy $ W $ by $dW = \dfrac{d\vec  p }{ dt} \cdot\vec  v\, dt = q\vec  e\cdot\vec  v\, dt $
which leads to

\begin{equation}
	\dfrac{ d^{n+1}W }{ds^{n+1}} = q \dfrac{ d^n (\vec  e\cdot\vec  u) }{ ds^n}
	\label{eq2-2-16}
\end{equation}


\noindent Finally, the derivatives $ \left(\dfrac{ 1 }{ v}\right)^{(n)} =
\dfrac{ d^n \left(\dfrac{1 }{ v}\right) }{ ds^n} $ involved in 
eqs~(\ref{eq2-2-10},\ref{eq2-2-15}) are 
obtained from $ p=\dfrac{ v }{ c} \dfrac{ W+mc^2 }{ c} $,
by successive 
differentiations, that give the recursive relations

\begin{equation}
	\begin{aligned}
		 \left(\dfrac{1}{ v}\right) 
		   & =   \dfrac{ 1 }{ c^2} \, 
		     \dfrac{W+mc^2 }{ qB\rho}\\
		 \left(\dfrac{1 }{ v}\right)^\prime 
		   & =  \dfrac{ 1 }{ c^2}\,
		     \dfrac{(\vec  e\cdot\vec  u) }{ B\rho} 
		      - \dfrac{1 }{ v} \dfrac{(B\rho )^\prime }{ B\rho}\\
		 \left(\dfrac{1 }{ v}\right)^{\prime\prime}
		   & = 	\dfrac{ 1 }{ c^2} \,
		     \dfrac{(\vec  e\cdot\vec  u)^\prime }{ B\rho}  
		     - 2\left(\dfrac{1}{v}\right)^\prime \dfrac{ (B\rho )^\prime }{ B\rho}  
		     - \dfrac{1 }{ v}\, \dfrac{(B\rho)^{\prime\prime} }{ B\rho}\\
		 \left(\dfrac{1 }{v}\right)^{\prime\prime\prime} 
		   & = \dfrac{ 1 }{c^2}\, \dfrac{(\vec  e\cdot\vec  u)^{\prime\prime} }{ B\rho}  
		     -3\left(\dfrac{1 }{v}\right)^{\prime\prime}  \dfrac{(B\rho )^\prime }{ B\rho}  
		     -3\left(\dfrac{1 }{v}\right)^\prime \dfrac{(B\rho )^{\prime\prime} }{ B\rho}  
		     - \dfrac{1 }{ v}\, \dfrac{(B\rho)^{\prime\prime\prime} }{ B\rho}
	\end{aligned}
	\label{eq2-2-17}
\end{equation}



 \subsubsection{Integration in combined electric and magnetic fields} \label{sec2.2.3}%%%% 2.2.3.

 When both $ \vec  e $ and $ \vec  b $ are non-zero, the complete 
 eq.~(\ref{eq2-2-3}) must 
be considered. Successive differentiations give the following 
recursive relations

\begin{equation}
	\begin{array}{l}
		(B\rho )^\prime\vec  u+B\rho\vec  u^{\,\prime} 
		     =  \dfrac{\vec e }{ v} + \vec  u \times  \vec  b \\
		(B\rho)^{\prime\prime}\vec  u+ 2(B\rho )^\prime\vec  u^{\,\prime} 
		  +B\rho\vec u^{\,\prime\prime} 
		     = \left(\dfrac{1 }{ v}\right)^\prime\vec  e + \left(\dfrac{1 }{ v}\right)\,\vec  e^{\,\prime}
		       +(\vec  u\times\vec  b)^\prime \\
		(B\rho)^{\prime\prime\prime}\vec  u +3(B\rho )^{\prime\prime}\vec  u^{\,\prime}
		  +3 (B\rho )^\prime\vec  u^{\,\prime\prime} +B\rho\vec  u^{\,\prime\prime\prime}
		     =  \left(\dfrac{1 }{ v}\right)^{\prime\prime}\vec  e
		     + 2\left(\dfrac{1 }{ v}\right)^\prime\vec  e^{\,\prime}
		     +\left(\dfrac{1 }{ v}\right)\, \vec  e^{\,\prime\prime} 
		     +(\vec  u\times\vec  b)^{\prime\prime} \\
		(B\rho )^{\quaprime}\vec  u + 4(B\rho )^{\prime\prime\prime}\vec  u^{\,\prime} 
		  +6 (B\rho )^{\prime\prime}\vec u^{\,\prime\prime} +4(B\rho )^\prime
		  \vec  u^{\,\prime\prime\prime} +B\rho\vec u^{\quaprime} = \\
		%
		\hphantom{(B\rho )^{\quaprime}\vec  u}
		 \left(\dfrac{1 }{ v}\right)^{\prime\prime\prime}\vec  e 
		   + 3\left(\dfrac{1 }{ v}\right)^{\prime\prime}\vec e^{\,\prime} 
		   +3\left(\dfrac{1 }{ v}\right)^\prime\vec  e^{\,\prime\prime} 
		   +\dfrac{1 }{ v} \vec e^{\,\prime\prime\prime} +(\vec  u\times\vec  b)^{\prime\prime\prime}
	\end{array} 
	\label{eq2-2-18}
\end{equation}
%
 that provide the derivatives $ \dfrac{ d^n\vec  u }{ ds^n}$ needed in the Taylor 
 expansions~(\ref{eq2-2-4})  

\begin{equation}
	\begin{aligned}
		\vec  u^{\,\prime}    
		   & =  \left(\dfrac{1 }{ v}\right)\, \vec  E
		      + (\vec  u\times\vec  B) - 
		      \dfrac{(B\rho )^\prime }{ B\rho}  \vec  u \\
		\vec  u^{\,\prime\prime}  
		   &   =  \left(\dfrac{1 }{ v}\right)^\prime\vec  E 
		      + \left(\dfrac{1 }{ v}\right)\,\vec  E{^{\,\prime}} \mid_{ B\rho} 
		      +(\vec u\times\vec  B^{\,\prime} )^\prime \mid_{ B\rho}
		      -2 \dfrac{(B\rho )^\prime }{ B\rho} \vec  u^{\,\prime} 
		      - \dfrac{(B\rho )^{\prime\prime} }{ B\rho}  \vec  u \\
		\vec  u^{\,\prime\prime\prime} 
		   &  =   \left(\dfrac{1 }{v}\right)^{\prime\prime}\vec  E
		      +2 \left(\dfrac{1 }{ v}\right)^\prime\vec  E^{\,\prime} \mid_{ B\rho}
		      +\dfrac{1 }{ v} \vec  E^{\,\prime\prime} \mid_{ B\rho} 
		      +(\vec  u\times\vec B)^{\prime\prime} \mid_{ B\rho}  
		      -3 \dfrac{(B\rho )^\prime }{ B\rho}  \vec u^{\,\prime\prime} 
		      -3 \dfrac{(B\rho )^{\prime\prime} }{ B\rho}  \vec  u^{\,\prime}
		      - \dfrac{(B\rho )^{\prime\prime\prime} }{ B\rho}  \vec  u \\
		\vec  u^{\quaprime}  
		   & =    \left(\dfrac{1}{ v}\right)^{\prime\prime\prime}  \vec  E
		      +3 \left(\dfrac{1 }{ v}\right)^{\prime\prime}\vec E^{\,\prime} \mid_{ B\rho} 
		      +3( \dfrac{1 }{ v})^\prime\vec  E^{\,\prime\prime} \mid_{B\rho} 
		      +\left(\dfrac{1 }{ v}\right)\, \vec  E^{\,\prime\prime\prime} \mid_{ B\rho} \\
		%
		  &  \quad + (\vec  u\times\vec B)^{\prime\prime\prime} \mid_{ B\rho} 
		      -4 \dfrac{(B\rho )^\prime }{ B\rho}  \vec u^{\,\prime\prime\prime} 
		      -6 \dfrac{(B\rho )^{\prime\prime} }{ B\rho}  \vec u^{\,\prime\prime} 
		      -4 \dfrac{(B\rho )^{\prime\prime\prime} }{ B\rho}  \vec  u^{\,\prime} 
		      - \dfrac{(B\rho )^{\quaprime} }{ B\rho}  \vec  u
	\end{aligned}
	\label{eq2-2-19}
\end{equation}
%
where $ \vec  E =  \dfrac{\vec  e }{ B\rho} $, 
$ \vec  B =\dfrac{\vec  b }{ B\rho} $, and $^{(n)}\mid_{ B\rho} $ denotes
differentiation at constant $ B\rho$ 

 \begin{equation}
	 \vec  E^{(n)}\mid_{ B\rho} = \dfrac{1 }{ B\rho}  \dfrac{d^n\vec  e }{ ds^n}
	 \quad \text{and} \quad 
	 (\vec  u\times\vec  B)^{(n)}\mid_{ B\rho} = \dfrac{1}{B\rho}  (\vec  u\times\vec  b)^{(n)}.
 	\label{eq2-2-20}
 \end{equation}

\noindent These derivatives $ \vec  E^{(n)} $ and $ \vec  B^{(n)} $ of the
electric and magnetic fields are 
calculated from the vector fields $ \vec  E(X,Y,Z)$,  $ \vec  B(X,Y,Z) $ and
their derivatives  
$ \dfrac{ \partial^{i+j+k} \vec  E }{ \partial X^i \partial Y^j\partial Z^k} $ 
and 
$ \dfrac{ \partial^{ i+j+k} \vec  B }{ \partial X^i \partial Y^j \partial Z^k}$, 
following eqs.~(\ref{eq2-2-7}) and (\ref{eq2-2-12}).


\subsection{Calculation of  $ \vec B $ and its Derivatives}\label{sec2.3}    %%%%%  2.3.

\noindent\zgou\  calculates $ \vec  B(X,Y,Z) $ and its
derivatives in several different ways, depending on whether field maps or analytic
 representations of optical elements are  used. The five basic means are the following. 
 
\subsubsection[Extrapolation from a 1-D axial field map]%
      {Extrapolation from a 1-D axial field map \protect\cite{Biblio3}}  
       \label{sec2.3.1} %%%%%  2.3.1.  [3]


 A cylindrically symmetric field (e.g., using \textsl{BREVOL}\index{BREVOL}) can be described
by an axial 1-D field map of its longitudinal component $ B_X(X,r=0) $
 $(r=(Y^2+Z^2)^{1/2})$,  
while the radial component on axis $ B_r(X,r=0) $ is assumed to be zero. $ B_X(X,r=0) $ is obtained at any point along the $ X$-axis by a 
polynomial interpolation from the map mesh (see section \ref{sec2.4.1}).  %%% ref 
Then the field components $ B_X(X,r)$,  $ B_r(X,r) $ at the position of the particle, 
$(X,r) $ are obtained from Taylor expansions to the fifth order in $ r $ (hence, up to 
the fifth order derivative $ \dfrac{ \partial^ 5B_X }{ \partial X^5} \,(X,0)$),  
assuming cylindrical symmetry 

 \begin{equation}
	 \begin{aligned}
		 B_X(X,r) 
		   &   =  B_X(X,0) -
		       \dfrac{r^2 }{ 4} \dfrac{\partial^ 2B_X }{ \partial X^2}\, (X,0)
		       + \dfrac{r^4 }{64} \dfrac{\partial^ 4B_X }{ \partial X^4} \,(X,0) \\
		 B_r(X,r)
		   & =    - \dfrac{r }{ 2} \dfrac{\partial B_X }{ \partial X} \, (X,0) 
		       + \dfrac{r^3 }{ 16} \dfrac{\partial^ 3B_X }{ \partial X^3}\, (X,0)
		       - \dfrac{r^5 }{384} \dfrac{\partial^ 5B_X }{ \partial X^5}\, (X,0) 
	 \end{aligned}
 	\label{eq2-3-1}
 \end{equation}
 
\noindent By differentiation with respect to $ X $ and $ r$,  up to the second
order, these expressions provide the derivatives of $ \vec  B(X,r)$.  Finally a conversion
from the $ (X,r) $ coordinates to the $ (X,Y,Z) $ Cartesian coordinates of \zgou\ is 
performed, thus providing the expressions 
$ \dfrac{ \partial^{i+j+k} \vec  B }{\partial X^i\partial Y^j\partial Z^k} $ needed in the 
eqs.~(\ref{eq2-2-7}). 

\subsubsection{Extrapolation from Median Plane Fields} \label{sec2.3.2} %%%%%%  2.3.2.  

In the median plane, $ B_Z(X,Y,0)$, and its 
derivatives with respect to $ X $ or $ Y$, may be calculated  from analytical
models (e.g.\ in Venus magnet - \textsl{VENUS\index{VENUS}}, and sharp edge 
multipoles  \textsl{SEXQUAD\index{SEXQUAD}}   and \textsl{QUADISEX\index{QUADISEX}}) or numerically by
polynomial interpolation from 2-D field maps (e.g.\ \textsl{CARTEMES\index{CARTEMES}, 
TOSCA\index{TOSCA}}).  
\bigskip

\noindent Median plane antisymmetry is assumed, which results in 

\begin{equation}
	\begin{aligned}
		B_X(X,Y,0)  &  =   0 \\
		B_Y(X,Y,0) & =  0 \\
		B_X(X,Y,Z)  & =  -B_X(X,Y,-Z) \\
		B_Y(X,Y,Z)  &  =  -B_Y(X,Y,-Z) \\
		B_Z(X,Y,Z) & =   B_Z(X,Y,-Z) 
	\end{aligned}
	\label{eq2-3-2}
\end{equation}


\noindent Together with Maxwell's equations, this results out of the median
plane in the following Taylor expansions,  for the three components of $ \vec  B $ (here, 
$ B $ stands for $ B_Z(X,Y,0)$) 

\begin{equation}
	\begin{aligned}
		B_X(X,Y,Z) 
		      & =   Z \dfrac{\partial B }{ \partial X} - \dfrac{Z^3 }{ 6} 
		        \left(  \dfrac{\partial^ 3B }{\partial X^3} 
		           + \dfrac{\partial^ 3B }{ \partial X\partial Y^2} \right) \\
		B_Y(X,Y,Z)
		      & =  Z \dfrac{\partial B }{ \partial Y} - \dfrac{Z^3}{ 6} 
		        \left(\dfrac{\partial^ 3B }{\partial X^2\partial Y} 
		           + \dfrac{\partial^ 3B}{ \partial Y^3} \right) \\
		B_Z(X,Y,Z) 
		      & =  B - \dfrac{Z^2 }{ 2} 
		        \left(  \dfrac{\partial^ 2B }{ \partial X^2} 
		           + \dfrac{\partial^ 2B}{\partial Y^2} \right) 
		        + \dfrac{Z^4 }{ 24} 
		        \left( \dfrac{\partial^ 4B }{\partial X^4} 
		           + 2 \dfrac{\partial^ 4B }{ \partial X^2\partial Y^2} 
		           + \dfrac{\partial^4B }{ \partial Y^4} \right)
	\end{aligned}
	\label{eq2-3-3}
\end{equation}
%
 which are then differentiated one by one with respect to $ X$, $Y$, 
or $ Z$, up to second or fourth order (depending on optical element or 
\textsl{IORDRE\index{IORDRE}} option, see section \ref{sec2.4.2}) so as to get the expressions
 involved in eq.~(\ref{eq2-2-7}). 
 
\subsubsection{Extrapolation from arbitrary 2-D Field Maps}\label{sec2.3.3}

2-D field maps that give the three components $ B_X(X,Y,Z_0)$,  
$B_Y(X,Y,Z_0) $ and $ B_Z(X,Y,Z_0) $ 
at each node $ (X,Y) $ of a $ Z_0 $ $ Z$-elevation map may be used. 
$ \vec  B$ and its derivatives at any point $ (X,Y,Z) $ are calculated by polynomial 
interpolation  followed by Taylor expansions in $ Z$,
without any hypothesis of symmetries (see section~\ref{sec2.4.3} and keyword \textsl{MAP2D}).

\subsubsection[Interpolation in 3-D Field Maps]%
        {Interpolation in 3-D Field Maps \protect\cite{Biblio4}}
           \label{sec2.3.4} %%%% 2.3.4.  [4]

In 3-D field maps $ \vec  B $ and its derivatives up to the second
order with respect to $ X$, $Y$,  or $ Z $ are calculated by means of a second order polynomial 
interpolation,  from a 3-D  $ 3  \times  3 
 \times $ 3-point grid (see section~\ref{sec2.4.4}). 
 
\subsubsection{3-D Analytical Models of Fields} \label{sec2.3.5} 

In analytical optical elements (such as \textsl{QUADRUPO\index{QUADRUPO}, MULTIPOL\index{MULTIPOL},
SEXTUPOL\index{SEXTUPOL}, EBMULT\index{EBMULT}},  etc.) the three 
components of $ \vec  B $  and their derivatives with respect to $ X$, $Y $ 
or $ Z $ are derived at any step along trajectories from the analytical 
expression of the scalar potential $ V(X,Y,Z) $ starting, for instance,  
with 

 \begin{equation}
	 \begin{alignedat}{3}
	 	 B_X &= \dfrac{\partial V}{\partial X}, 
	 	   & \quad B_Y &= \dfrac{\partial V }{ \partial Y}, 
	 	   &  \quad B_Z &= \dfrac{\partial V }{ \partial Z}  \\
	 	 \dfrac{\partial B_X }{ \partial X} &= \dfrac{\partial^2V}{\partial X^2},
	 	   &  \quad \dfrac{\partial B_X}{\partial Y} &
	 	               = \dfrac{\partial^2V}{\partial X\partial Y},
	 	   & \quad\text{etc.}
	 \end{alignedat}
 	\label{eq2-3-4}
 \end{equation}

\paragraph{Multipoles}

\noindent The scalar potential used for the calculation of the derivatives 
$ \dfrac{\partial^{i+j+k} \vec B_{n,X,Y,Z}}{ \partial X^i\partial Y^i\partial 
Z^k}$ ($i+j+k= 0 \text{ to } 4$)
for the magnetic and electromagnetic multipoles with $2n$ poles
(namely, \textsl{QUADRUPO}\index{QUADRUPO} ($n = 2$) to  
\textsl{DODECAPO}\index{DODECAPO} ($n=6$),   
\textsl{MULTIPOL}\index{MULTIPOL} ($n = 1$ to 6), 
\textsl{EBMULT}\index{EBMULT} ($n=1$ to 6))   is~\cite{Biblio5}              %%%%% [5] 

\begin{equation}
	V_n(X,Y,Z)=(n!)^2 
	  \left( \sum^{ \infty}_{ q=0}(-1)^q \,
	        \dfrac{G^{(2q)}(X)(Y^2+Z^2)^q }{ 4^q q!(n+q)!} \right) 
	  \left( \sum^ n_{m=0}\dfrac{sin \left(m \dfrac{\pi }{ 2} \right) Y^{n-m} Z^m }{ m!(n-m)!} \right) 
	\label{eq2-3-5}
\end{equation}
%
 where $ G(X) $ is the longitudinal gradient, defined at the entrance 
 or exit of the optical element by

 \begin{equation}
	 G(s) = \dfrac{G_0 }{ 1+ \exp(P(s))} , \quad G_0 = \dfrac{B_0 }{R^n_0} 
 	\label{eq2-3-6}
 \end{equation}
%
 and $s$ is the distance to the EFB.
 
\paragraph{Skewed multipoles}

\noindent Any multipole component $n$ can be rotated independently by an 
angle $A_n$ around the $X$-axis. If so, the calculation of the field and derivatives in the 
rotated axis $ (X,Y_R,Z_R) $ is done in two steps. First, they are 
calculated at the rotated position $ X,Y_R,Z_R)$,  in the $ (X,Y,Z) $ 
frame, as derived from the expression (\ref{eq2-3-5}) above. Second, $ \vec  B $ and 
its derivatives at $ (X,Y_R,Z_R) $ in the $ (X,Y,Z) $ frame are transformed 
to the rotated $ (X,Y_R,Z_R) $ frame by a rotation of the same angle 
$A_n$. A skewed $2n$-pole component is thus obtained by taking 
$A_n = \pi/2n$.

\subsection{Calculation of $ \vec B $ from Field Maps}  \label{seq2.4}

\subsubsection{1-D Axial Map, with Cylindrical Symmetry}  \label{sec2.4.1}

 Let $ B_i $ be the value of the longitudinal component $ B_X(X,r=0)$ of the 
field $ \vec  B$, at a node $ i $ of the uniform mesh, which defines a 1-D
field map along the symmetry $ X$-axis, while $ B_r(X,r=0) $ is assumed to be zero 
$(r=(Y^2+Z^2)^{1/2})$. The field component $B_X(X,r=0) $ 
is calculated by a polynomial interpolation of the fifth degree in $ X$,  
using a 5~points grid centered at the node of the 1-D map which is closest 
to the actual coordinate $ X $ of the particle. 

\noindent The interpolation polynomial is

 \begin{equation}
	 B(X,0)=A_0 + A_1 X + A_2 X^2 + A_3 X^3 + A_4 X^4 + A_5 X^5 
 	\label{eq2-4-1}
 \end{equation}
 %
and the coefficients $ A_i $ are calculated by expressions that
minimize the quadratic sum
\medskip
 \begin{equation}
     S = \sum_i \left(B(X,0)-B_i \right)^2  
 	\label{eq2-4-2}
 \end{equation}

\noindent Namely, the source code contains the explicit analytical 
expressions of the coefficients $A_i$ solutions of the normal 
equations $\partial S / \partial A_i = 0$.

\noindent The derivatives $  \dfrac{ \partial^n B }{ \partial X^n}
(X,0) $ at the actual position $ X$,  as involved 
in eqs.~(\ref{eq2-3-1}), are then obtained by differentiation of the polynomial 
(\ref{eq2-4-1}), giving

\begin{equation}
	\begin{aligned}
		\dfrac{ \partial B }{ \partial X}\, (X,0) 
		  &  =  A_1 + 2 A_2 X + 3 A_3 X^2 + 4 A_4 X^3 + 5 A_5 X^4 \\
		\dfrac{\partial^2 B }{ \partial X^2}\, (X,0)  
		  & = 2 A_2 + 6 A_3 X + 12 A_4 X^2 + 20 A_5 X^3 \\
		\ldots & \\
		 \dfrac{\partial^5 B }{ \partial X^5}\, (X,0) 
		  & = 120 A_5 
	\end{aligned}
	\label{eq2-4-3}
\end{equation}
  
  
\subsubsection{2-D Median Plane Map, with Median Plane Antisymmetry} \label{sec2.4.2}

Let $ B_{ij} $ be the value of $ B_Z(X,Y,0) $ at the nodes of a mesh
which defines a 2-D field map in the ($ X,Y) $ plane while $ B_X(X,Y,0) $ and $ B_Y(X,Y,0) $
are assumed to be zero.  Such a map may have been built or measured 
in either Cartesian or polar coordinates.  Whenever polar coordinates are used, a
change to Cartesian coordinates (described below) provides the expression of 
$ \vec  B $ and its derivatives as involved in eq.~(\ref{eq2-2-7}). 

\noindent\zgou\ provides three types of polynomial
interpolation from the mesh (option \textsl{IORDRE\index{IORDRE}}); namely, a second order interpolation, 
with either a 9- or a 25-point grid, or a fourth 
order interpolation with a 25-point  grid (Fig.~\ref{fig3}).  

\noindent If the 2-D field map is built up from a simulation, the grid simply
aims at interpolating the field at a given point from its 9 or 25~neighbors.  If 
the map results from measurements, the grid also smoothes field measurement 
fluctuations. 

\noindent The mesh may be defined in Cartesian coordinates, 
(Figs.~3A and 3B) or in polar coordinates (Fig.~~\ref{fig3}C).   

\noindent The interpolation grid is centered on the node which is closest to
the projection in  the ($ X,Y) $ plane of the actual point of the trajectory. 

\noindent The interpolation polynomial is 

 \begin{equation}
	 B(X,Y,0) = A_{00} + A_{10}X + A_{01}Y + A_{20}X^2 + A_{11}XY + A_{02}Y^2
 	\label{eq2-4-4}
 \end{equation}
 %
 in second order, or 

 \begin{equation}
	 \begin{aligned}
		 B(X,Y,0)  = 
		    & A_{00}+A_{10}X+A_{01}Y + A_{20}X^2 + A_{11}XY + A_{02}Y^2 \\
		%
		    & +  A_{30}X^3+A_{21}X^2Y + A_{12}XY^2 + A_{03}Y^3 \\
		%
		    & +  A_{40}X^4 + A_{31}X^3Y + A_{22}X^2Y^2 +A_{13}XY^3 + A_{04}Y^4 
	 \end{aligned}
 	\label{eq2-4-5}
 \end{equation}
%
in fourth order.  The coefficients $ A_{ij} $ are calculated by
expressions that 
minimize, with respect to $ A_{ij}$, the quadratic sum 

\begin{equation}
	S = \sum_{ij}(B(X,Y,0)-B_{ij})^2 
	\label{eq2-4-5b} %% 2-4-6
\end{equation}
%
The source code contains the explicit analytical 
expressions of the coefficients $A_{ij}$ solutions of the normal 
equations $\partial S / \partial A_{ij} = 0$.

\noindent The $ A_{ij} $ may then be identified with  the derivatives of 
$B(X,Y,0) $ at the central node of the grid 

\begin{equation}
	A_{ij} = \dfrac{1 }{ i!j!}\, \dfrac{\partial^{ i+j}B }{ \partial X^i\partial Y^j} \,(0,0,0) 
	\label{eq2-4-6}
\end{equation}

\noindent The derivatives of $ B(X,Y,0) $ with respect to $ X $ and $ Y$, at
the actual point 
$ (X,Y,0) $ are obtained by differentiation of the interpolation polynomial, 
which gives (e.g.~from (\ref{eq2-4-4}) in the case of second order interpolation)

\begin{equation}
	\begin{aligned}
		\dfrac{ \partial B }{ \partial X} \,(X,Y,0)  
		   & =   A_{10}+2A_{20}X+A_{11}Y \\
		 \dfrac{\partial B }{ \partial Y}\, (X,Y,0) 
		   & =  A_{01}+A_{11}X+2A_{02}Y \\
		\text{etc.} 
	\end{aligned}
	\label{eq2-4-7}
\end{equation}


\noindent This allows stepping to the calculation of $ \vec  B(X,Y,Z) $ and its derivatives
as described in subsection~\ref{sec2.3.2} (eq.~\ref{eq2-3-3}).

\paragraph{The special case of polar maps} 
 
 \noindent It is necessary to change from polar to Cartesian coordinates.  This
is done as  follows. 

\noindent In second order calculations the correspondence is 

 \begin{equation}
{\renewcommand{\arraystretch}{2}
	 \begin{array}{ll}
		 \dfrac{ \partial B }{ \partial X} 
		      &  = \dfrac{ 1 }{ R} \dfrac{\partial B }{ \partial \alpha} \\
		 \dfrac{ \partial B }{ \partial Y}
		      & = \dfrac{ \partial B }{ \partial R}\\
		\dfrac{\partial^2 B }{ \partial X^2} 
		      & =   \dfrac{ 1}{ R^2} \dfrac{\partial^2 B }{ \partial \alpha^ 2} 
		         + \dfrac{1 }{ R} \dfrac{\partial B}{\partial R}\\
		 \dfrac{ \partial^2 B }{ \partial X\partial Y}
		      & =  \dfrac{ 1 }{ R} \dfrac{\partial^ 2 B}{\partial \alpha \partial R}
		         - \dfrac{1 }{ R^2} \dfrac{\partial B }{ \partial\alpha}\\
		\dfrac{ \partial^2 B }{\partial Y^2}   
		      & =  \dfrac{ \partial^2 B }{ \partial R^2} \\
		 \dfrac{ \partial^3 B }{ \partial X^3} 
		      & = \dfrac{ 3 }{ R^2} \dfrac{\partial^2 B }{ \partial \alpha \partial R} 
		        - \dfrac{2 }{ R^3} \dfrac{\partial B }{ \partial \alpha}\\
		\dfrac{\partial^3 B }{ \partial X^2\partial Y} 
		      & = \dfrac{ -2 }{ R^3} \dfrac{\partial^2 B }{ \partial \alpha^2} 
		        - \dfrac{1}{ R^2} \dfrac{\partial B }{ \partial R} 
		        + \dfrac{1 }{ R} \dfrac{\partial^2 B }{\partial R^2}\\
		 \dfrac{ \partial^3 B }{ \partial X\partial Y^2} 
		      & =  \dfrac{ 2 }{ R^3} \dfrac{\partial B}{\partial \alpha} 
		         - \dfrac{2 }{ R^2} \dfrac{\partial^2 B }{ \partial \alpha\partial R}\\
		\dfrac{ \partial^3 B }{ \partial Y^3} 
		      &  =  0
	 \end{array} 
 	\label{eq2-4-8}}
 \end{equation}
 

%\newpage
  \noindent In fourth order calculations the relations are the same up to second
order, and then  

{\renewcommand{\arraystretch}{2}
 \begin{equation}
	 \begin{array}{ll}
		 \dfrac{ \partial^3 B }{ \partial X^3} 
		     & =  \dfrac{ 1}{R^3} \, \dfrac{\partial^3 B}{\partial \alpha^3} 
		       + \dfrac{3 }{R^2} \, \dfrac{\partial^2 B }{\partial \alpha \partial R} 
		       - \dfrac{2 }{ R^3} \, \dfrac{\partial B }{ \partial \alpha}\\  %%
		 \dfrac{\partial^3 B }{ \partial X^2\partial Y} 
		     & =  \dfrac{1 }{ R^2} \, \dfrac{\partial^3 B }{\partial \alpha^ 2\partial R}
		       - \dfrac{2 }{ R^3} \, \dfrac{\partial^2 B }{ \partial \alpha^2} 
		       - \dfrac{1}{R^2} \, \dfrac{\partial B }{ \partial R} 
		       + \dfrac{1 }{ R} \, \dfrac{\partial^2 B }{ \partial R^2} \\  %%
		 \dfrac{ \partial^3 B }{ \partial X\partial Y^2} 
		     & =  \dfrac{ 1 }{ R} \, \dfrac{\partial^3 B }{ \partial \alpha \partial R^2} 
		       + \dfrac{2 }{ R^3} \, \dfrac{\partial B }{\partial \alpha}  
		       - \dfrac{2 }{R^2} \, \dfrac{\partial^ 2B }{ \partial \alpha \partial R} \\ %%
		 \dfrac{ \partial^3 B }{ \partial Y^3}
		     & =  \dfrac{ \partial^3 B }{ \partial R^3} \\ %%
		\dfrac{\partial^4 B }{ \partial X^4}
		     & = \dfrac{ 1}{ R^4} \, \dfrac{\partial^4 B }{ \partial \alpha^4} 
		       - \dfrac{8 }{ R^4} \, \dfrac{\partial^2 B }{ \partial \alpha^2} 
		       + \dfrac{6 }{ R^3} \, \dfrac{\partial^3 B }{ \partial\alpha^2\partial R} 
		       + \dfrac{3 }{ R^2} \, \dfrac{\partial^2 B }{ \partial R^2} 
		       - \dfrac{3}{ R^3} \, \dfrac{\partial B }{ \partial R} \\ %%
	     \dfrac{ \partial^4 B }{ \partial X^3\partial Y}
	         & =   \dfrac{ 1 }{ R^3} \, \dfrac{\partial^ 4B }{\partial \alpha^ 3\partial R} 
	           - \dfrac{3 }{ R^4} \, \dfrac{\partial^ 3B }{ \partial\alpha^ 3} 
	           + \dfrac{3 }{ R^2} \, \dfrac{\partial^3 B }{ \partial \alpha \partial R^2} 
	           - \dfrac{8 }{ R^3} \, \dfrac{\partial^2 B }{ \partial \alpha \partial R} 
	           + \dfrac{6 }{ R^4} \, \dfrac{\partial B }{ \partial \alpha} \\   %%
	    \dfrac{ \partial^4 B}{ \partial X^22 Y^2} 
	         & =  \dfrac{ 1 }{ R^4} \, \dfrac{\partial^2 B }{ \partial \alpha^ 2} 
	           - \dfrac{4 }{ R^3} \, \dfrac{\partial^3 B }{ \partial \alpha^ 2\partial R} 
	           - \dfrac{2 }{ R^2} \, \dfrac{\partial^2 B }{ \partial R^2} 
	           + \dfrac{2 }{ R^3} \, \dfrac{\partial B }{ \partial R} 
	           + \dfrac{1 }{ R^2} \, \dfrac{\partial^4 B }{ \partial \alpha^2\partial R^2} 
	           + \dfrac{1 }{ R} \, \dfrac{\partial^3 B }{ \partial R^3}\\     %%
	     \dfrac{ \partial^4 B }{ \partial X\partial Y^3} 
	         & = \dfrac{ 1 }{ R} \, \dfrac{\partial^4 B }{\partial \alpha \partial R^3} 
	           - \dfrac{3 }{ R^2} \, \dfrac{\partial^3 B }{ \partial \alpha \partial R^2} 
	           + \dfrac{6 }{ R^3} \, \dfrac{\partial^2 B }{ \partial \alpha\partial R} 
	           - \dfrac{6 }{ R^4} \, \dfrac{\partial^4 B }{ \partial \alpha^ 4} \\  %%
	     \dfrac{ \partial^4 B }{ \partial Y^4}
	         & =   \dfrac{ \partial^4 B }{ \partial R^4}
	 \end{array} 
	\label{eq2-4-9}
\end{equation}  }
 

\noindent \textbf{NOTE:} If a particle goes beyond the limits of the 
 field map, the field and its derivatives will be extrapolated by means of the same calculations, 
from the border grid which is the closest to the actual position of the 
particle. Its flag \textsl{IEX\index{IEX}} is given the value $-1$ (see section~\ref{sec4.6.6}). 


%%%%%%%%%%%%%%figure%%%%%%%%%%%%%%
\begin{figure}[H]  %% [H]
%\vspace{17 truecm}
%%%Figure 3
\centerline{\includegraphics[width=15.5cm]{Fig3.ps}}
\hangcaption[Fig3]{\label{fig3}Mesh in the $ (X,Y) $ plane in Cartesian coordinates.
The grid is centered \\
on the node which is closest to the actual position of the particle.\\
A: 9-point interpolation  grid.\\
B: 25-point interpolation grid.\\ 
C: Mesh in the $ (X,Y) $ plane in polar coordinates. }
	\end{figure}

\subsubsection{Arbitrary 2-D Map, no Symmetries} \label{sec2.4.3}

The map is supposed to describe the field $ \vec  B(B_X,B_Y,B_Z) $
in the $ (X,Y) $ 
plane at elevation $ Z_0 $. It provides the components $ B_{X,ij}$, $
B_{Y,ij}$,  $ B_{Z,ij} $ at 
each node $ (i,j) $ of a 2-D mesh. 

\noindent The value of $ \vec  B $ and its derivatives at the projection $
(X,Y,Z_0) $ of the actual position $ (X,Y,Z) $ 
of a particle is obtained by means of a polynomial interpolation from a 
$3 \times 3$~points grid centered at the node $(i,j) $
which is closest to the position $ (X,Y)$

 \begin{equation}
	 B_{\ell} (X,Y,Z_0)=A_{00} +A_{10} X +A_{01} Y +A_{20} X^2 +A_{11} X Y +A_{02} Y^2
 	\label{eq2-4-10}
 \end{equation}
 %
where $ B_{\ell} $ stands for any of the three components $ B_X$, 
$B_Y $ or $ B_Z $. 
Differentiating then gives the derivatives

\begin{equation}
	\begin{aligned}
		 \dfrac{ \partial B_{\ell} }{ \partial X} \,(X,Y,Z_0)
		     & =   A_{10} +2 A_{20} X + A_{11} Y  \\
		\dfrac{ \partial^2 B_{\ell} }{ \partial X\partial Y}\, (X,Y,Z_0)
		     & =  A_{11} \\
		\text{etc.}
	\end{aligned}
	\label{eq2-4-11}
\end{equation}


\noindent Then follows the procedure of extrapolation from $ (X,Y,Z_0) $ to
the actual position $ (X,Y,Z)$, as described in section~\ref{sec2.3.3} 

\noindent No special symmetries are assumed, which allows the treatment of any
type of magnet.

\subsubsection{Calculation of $\vec B $ from a 3-D Field Map} \label{sec2.4.4}

The vector field $ \vec  B(X,Y,Z) $ and its derivatives necessary
for the calculation of position and velocity of the particle are now defined by means 
of a 3-D field map, through second order polynomial interpolation

\begin{equation}
\!\!	B_{\ell} (X,Y,Z) = A_{000} + A_{100} X + A_{010} Y + A_{001} Z + 
	A_{200} X^2 + A_{020} Y^2  
	+     A_{002} Z^2 + A_{110} X Y + A_{101} X Z + A_{011} Y Z
	\label{eq2-4-12}
\end{equation}

\noindent$ B_{\ell} $ stands for any of the three components, $ B_X, $ $ B_Y $
or $ B_Z $.  By 
differentiation of $ B_{\ell} $ one gets 

\begin{equation}
	\begin{aligned}
		 \dfrac{ \partial B_{\ell} }{ \partial X} 
		    & =  A_{100} + 2 A_{200} X + A_{110} Y + A_{101} Z\\
		\dfrac{\partial^2 B_{\ell}}{ \partial X^2} 
		    & =  2 A_{200} 
	\end{aligned}
	\label{eq2-4-13}
\end{equation}
%
 and so on for first and second order derivatives with respect to 
 $X$, $ Y $ or $ Z $. 
 
\noindent The interpolation involves a $ 3  \times   3  \times   3$-point 
parallelipipedic grid (Fig.~\ref{fig4}),   
the origin of which is positioned at the node of the 3-D field map which is 
closest to the actual position of the particle. 
\medskip

\noindent Let $ B^{\ell}_{ijk} $ be the value of the --- measured or computed ---
magnetic field at each one of the 27~nodes of the 3-D grid ($ B^{\ell} $ stands for  
$ B_X$, $ B_Y $ or $ B_Z $), and $ B_{\ell} (X,Y,Z) $ be the value at a
position $ (X,Y,Z) $ 
with respect to the central node of the 3-D grid. Thus, any 
coefficient $ A_i $ of the polynomial expansion of $ B_{\ell} $ is obtained by
means of expressions that minimize, with respect to $ A_i $, the sum
%
\begin{equation}
	S = \sum_{ijk} \left(B_{\ell} (X,Y,Z)-B^{\ell}_{ijk} \right)^2 
	\label{eq2-4-14} %% reel : 2-4-15
\end{equation}
%
 where the indices $ i$, $j $ and $ k $ take the values -1, 0 or +1 so as
to sweep the 3-D grid. The source code contains the explicit analytical 
expressions of the coefficients $A_{ijk}$ solutions of the normal 
equations $\partial S / \partial A_{ijk} = 0$.


%%%%%%%%%%%%%%figure%%%%%%%%%%%%%%
\begin{figure}[H]
%\vspace{11 truecm}
%%%Figure 4
\centerline{\includegraphics[width=14cm]{Fig4.ps}}
\hangcaption{\label{fig4}A 3-D 27-point  grid is used for
interpolation of $ \vec  B $ and its 
derivatives up to second order.  The central node of the grid $ (i=j=k=0) $ is
at the closest vicinity of the actual position of the particle.} 
\end{figure}

\subsection{Calculation of  $ \vec E $ and its derivatives} \label{sec2.5}

\zgou\ calculates $ \vec  E(X,Y,Z) $ and its derivatives in
several different ways, depending on whether field maps or analytical 
representations of optical elements are used. The three basic 
means are the following~\cite{Biblio6}.     %%% [6]. 

\subsubsection{Extrapolation from a 1-D axial field map} \label{sec2.5.1}

 A cylindrically symmetric field can be described by an 
axial 1-D field map of its longitudinal component $ E_X(X,r=0)$ 
$(r=(Y^2+Z^2)^{1/2})$,  
while the radial component $ E_r(X,r=0) $ is assumed to be zero 
(e.g.~in \textsl{ELREVOL\index{ELREVOL}}). $ E_X(X,r=0) $ is obtained at any point along the $ X$-axis by
a polynomial interpolation from the map mesh (see section~\ref{sec2.4.1}). Then the 
field components $ E_X(X,r)$,  $ E_r(X,r) $ at the position of the particle, 
$(X,r) $ are obtained from Taylor expansions to the fifth order in $ r $ (hence, up to 
the fifth order derivative 
$  \dfrac{ \partial^5 E_X }{ \partial X^5}\, (X,0)$),  assuming cylindrical symmetry 
% 
 \begin{equation}
	 \begin{aligned}
		 E_X (X,r)
		   &  =    E_X (X,0) - \dfrac{r^2 }{ 4} \dfrac{\partial^2 E_X }{ \partial X^2} \,(X,0)
		      + \dfrac{r^4 }{64} \dfrac{\partial^4 E_X }{ \partial X^4} \,(X,0)\\
		E_r(X,r)
		   & =   - \dfrac{r }{ 2} \dfrac{\partial E_X }{ \partial X}\, (X,0) 
		     + \dfrac{r^3 }{ 16} \dfrac{\partial^3 E_X }{ \partial X^3} \,(X,0)
		     - \dfrac{r^5 }{ 384} \dfrac{\partial^5 E_X }{ \partial X^5} \,(X,0)
	 \end{aligned}
 	\label{eq2-5-1}
 \end{equation}
\newpage %%%%

\noindent By differentiation with respect to $ X $ and $ r$,  up to the second
order, these expressions provide the derivatives of $ \vec  E(X,r)$.  Finally a conversion
from the $ (X,r) $ coordinates to the $ (X,Y,Z) $ Cartesian coordinates of 
\zgou\ is performed, thus providing the expressions 
$  \dfrac{ \partial^{i+j+k} \vec  E }{ \partial X^i\partial Y^j\partial Z^k} $ 
needed in the eqs.~(\ref{eq2-2-12}). 

\subsubsection{Extrapolation from analytically defined axial fields } \label{sec2.5.2}

This procedure assumes cylindrical symmetry with respect to the $ X$-axis.
 The longitudinal field component $ E_X(X,r=0) $ $ (r=(Y^2+Z^2)^{1/2}) $,
along this axis are derived from differentiation of an adequate 
model of the electric potential $ V(X) $ (e.g.~in \textsl{EL2TUB\index{EL2TUB}, 
UNIPOT\index{UNIPOT}}). 
The longitudinal and radial field components $ E_X(X,r)$,  $ E_r(X,r) $ and 
their derivatives off-axis 
$  \dfrac{ \partial^{i+j}E_X }{ \partial X^i\partial r^j} $ and 
$  \dfrac{ \partial^{ i+j} E_r }{ \partial X^i\partial r^j} $  are obtained by 
Taylor expansions to the fifth order in $ r $ assuming cylindrical 
symmetry (see eq.~(\ref{eq2-5-1})), and then transformed to the $ (X,Y,Z) $ 
Cartesian frame of \zgou\ in order to provide the derivatives 
$ \dfrac{ \partial^{i+j+k} \vec  E }{ \partial X^i\partial Y^j\partial Z^k} $ 
needed in eq.~(\ref{eq2-2-12}).

\subsubsection{3-D Analytical models of fields} \label{sec2.5.3}

In analytical elements (e.g.~\textsl{WIENFILT\index{WIENFILT}, ELMULT\index{ELMULT},
 EBMULT\index{EBMULT}}), the three 
components of $ \vec  E$,  namely $ E_X $, $ E_Y $, $ E_Z $, and their
derivatives with respect to $ X$, $Y $ or $ Z $ are derived at any step along trajectories, 
from the analytical expressions of field models that give $ \vec  E(X,Y,Z)$. 

%\vfill\eject

\paragraph{Multipoles and skewed multipoles}

\noindent A right electric multipole is considered to have the same effect 
as the equivalent skewed magnetic multipole. Therefore, the 
calculation of the right electric or electromagnetic multipoles 
(\textsl{ELMULT\index{ELMULT}, EBMULT\index{EBMULT}})   uses the 
same eq.~(\ref{eq2-3-5}) together with the rotated process described in 
section~\ref{sec2.3.5}. The same method is used, for rotating 
arbitrary multipole components
around the $ X $-axis, whatever the angle of rotation. 

\subsection{Calculation of  $ \vec E$ from field maps} \label{sec2.6}

\paragraph{1-D axial map, with cylindrical symmetry} 

\noindent The only type of field map treated in the actual version is the 
1-D axial map, with cylindrical symmetry. The same procedure as 
for the case of magnetic fields is involved (see section~\ref{sec2.4.1}). 

\section[SPIN TRACKING]{SPIN TRACKING \protect\cite{Biblio7}}\label{sec3}   %%% [7]

%%% chgt de numerotation des equations pour ne pas avoir 3.0.1 %%%
%% \renewcommand\theequation{\thesubsection.\arabic{equation}}
\renewcommand\theequation{\thesection.\arabic{equation}}
\makeatletter
\@addtoreset{equation}{section}
\makeatother
%%%

The depolarization of a particle beam travelling in a 
magnetic field $ \vec  B $ takes its origin in the spin \index{Spin} 
precession undergone by each particle. This motion of the spin $ \vec  S $ 
is governed by the Thomas-BMT first order differential 
equation~\cite{Biblio8}       %%%%[8] 


\begin{gather}
	\dfrac{d\vec  S }{ dt} = \dfrac{q }{ \gamma m} \vec  S\times\vec  \Omega
	     \label{eq3-1}  \\
\intertext{where}
	\vec  \Omega  = (1+\gamma G)\vec  b + G(1-\gamma )\vec  b_{\paral} \label{eq3-2} 
\end{gather}

\noindent$ q$, $m$, $\gamma$ and $ G $ are respectively the charge, rest
mass, Lorentz relativistic factor, and anomalous magnetic moment of the 
particle. $ \vec  b_{\paral} $ is the component of $ \vec  b $ which is
parallel to the velocity $ \vec  v $ of the particle. 

\noindent These equations are normalized by introducing the same notation 
as previously. Let $ b=\parallel\vec  b\parallel $ and $ v=\parallel\vec v\parallel$;  
$ ds=vdt $ is the differential path, $ \dfrac{\gamma mv }{ q} = B\rho $ is the
rigidity of the particle; 
$ \vec  S^{\,\prime} = \dfrac{d\vec  S }{ ds} = \dfrac{1 }{ v}\dfrac{d\vec  S }{ dt} $ 
is the derivative of the spin with respect to the path. 

\noindent Introducing also $ \vec  B= \dfrac{\vec  b }{ B\rho} $ and 
$ \vec B_{\paral} = \dfrac{\vec  b_{\paral} }{ B\rho} $, and

\begin{equation}
	\vec  \omega  = \dfrac{\vec  \Omega }{ B\rho}  = (1+\gamma G)\vec  B +
	G(1-\gamma )\vec  B_{\paral}
	\label{eq3-3}
\end{equation}
%
eq.~(\ref{eq3-1}) can be re-written in a normalized way

 \begin{equation}
	 \vec  S^{\,\prime}  = \vec  S \times  \vec  \omega
 	\label{eq3-4}
 \end{equation}
 
\noindent This equation is then solved in the same way as the reduced Lorentz 
equation~(\ref{eq2-2-3}). 
From the values of the magnetic factor $ \vec  \omega (M_0) $ and the spin 
$\vec  S(M_0) $ 
of the particle at position $ M_0 $ of its trajectory, the spin $ \vec  S(M_1)$ 
at position $ M_1 $, following a displacement $ ds$ (fig. 2), is given by the 
Taylor expansion

 \begin{equation}
	 \vec  S(M_1)=\vec  S(M_0)+ \dfrac{d\vec  S }{ ds} (M_0)\, ds
	 + \dfrac{d^2\vec  S }{ds^2} \,(M_0) \dfrac{ds^2 }{ 2} 
	 + \dfrac{d^3\vec  S }{ ds^3} \,(M_0) \dfrac{ds^3 }{ 3!}
	+ \dfrac{d^4\vec  S }{ ds^4}\, (M_0) \dfrac{ds^4 }{ 4!}
 	\label{eq3-5}
 \end{equation}
 
\noindent The derivatives $ \vec  S^{(n)} = \dfrac{d^n\vec  S }{ ds^n} $ of 
$\vec  S $ at $ M_0 $ are obtained by differentiating eq.~(\ref{eq3-4})

 \begin{equation}
	 \begin{aligned}
		 \vec  S^{\,\prime}  
		      &  =\vec  S\times\vec  \omega \\
		\vec  S^{\,\prime\prime} 
		      &  =\vec  S^{\,\prime} \times\vec  \omega +\vec  S\times\vec  \omega ^\prime \\
		\vec  S^{\,\prime\prime\prime}
		      &  =\vec  S^{\,\prime\prime} \times\vec  \omega +2\vec  S^{\,\prime} \times\vec  \omega ^\prime 
		           +\vec S\times\vec  \omega^{\prime\prime} \\
		\vec  S^{\quaprime} 
		      & =\vec S^{\,\prime\prime\prime} \times\vec  \omega 
		          +3\vec  S^{\,\prime\prime} \times\vec \omega^\prime 
		          +3\vec  S^{\,\prime} \times\vec  \omega^{\prime\prime} 
		          +\vec S\times\vec  \omega^{\prime\prime\prime}
	 \end{aligned}
 	\label{eq3-6}
 \end{equation}
 %
  where the derivatives $ \vec  \omega^{(n)} $ are obtained from eq.~(\ref{eq3-3}). 
  
\noindent The last point consists in getting $ \vec  B_{\paral} $ and its
derivatives. 
This can be done in the following way. 
Let $ \vec  u=\dfrac{\vec  v }{ v} $ be the normalized velocity of the particle,
then,

\begin{equation}
	\begin{aligned}
		\vec  B_{\paral} 
		     & = (\vec  B \cdot\vec  u)\, \vec  u \\
		\vec  B^{\,\prime}_{\paral}  
		     & = (\vec B^{\,\prime} \cdot\vec  u+\vec  B\cdot\vec  u^{\,\prime} )\,\vec  u
		       +(\vec  B\cdot\vec  u)\,\vec u^{\,\prime} \\
		\vec B^{\,\prime\prime}_{\paral}  
		     & = (\vec  B^{\,\prime\prime} \cdot\vec  u+2\vec B^{\,\prime} \cdot\vec  u^{\,\prime} 
		       +\vec  B\cdot\vec  u^{\,\prime\prime} )\, \vec  u
		       +2(\vec B^{\,\prime} \cdot\vec  u+\vec  B\cdot\vec  u^{\,\prime} )\,\vec  u^{\,\prime} 
		       +(\vec  B\cdot\vec u)\,\vec  u^{\,\prime\prime}\\
		\text{etc.}
	\end{aligned}
	\label{eq3-7}
\end{equation}


\noindent The quantities $ \vec  u$,  $ \vec  B $ and their n-th derivatives
as involved in these equations are picked up from eqs.~(\ref{eq2-2-6}, \ref{eq2-2-7}).


\newpage


\section{SYNCHROTRON RADIATION \protect\cite{FM}}\label{secN4}\index{synchrotron radiation} 


%%% on a de nouveau une numerotation des equations 4.1.1 %%%
\renewcommand\theequation{\thesubsection.\arabic{equation}}
\makeatletter
\@addtoreset{equation}{subsection}
\makeatother
 

The ray-tracing procedures\footnote{Also implemented in the post-processor  \textbf{zgplot}}\index{zgplot} provide the ingredients necessary
for the determination of the electric field radiated by the particle subject to
acceleration, as shown in Fig.~\ref{newfig5}.

%%%%%%%%%%%%%%figure%%%%%%%%%%%%%%
\vspace{1cm}
\begin{figure}[H]
%\vspace{4.5 truecm}
%%%Figure 6
\centering
\includegraphics[width=16cm]{NewFig5.ps} 
{\setlength{\captionwidth}{15cm}
\hangcaption[NewFig 6]{\label{newfig5}A scheme of the reference frame in 
\zgou\ together with the vectors entering
in the definition of the electric field radiated by the accelerated particle:\\
$(x,y)$: horizontal plane;~$z$: vertical axis.\\
$\vec{R}(t)$ = particle position in the fixed frame $(O, x, y, z)$;\\
$\vec{X}$ (time-independent) = position of the observer in the  $(O, x, y, z)$ frame;\\
$\vec{r}(t) = \vec{X} - \vec{R}(t)$ = position of the particle with respect to
the observer;\\
$\vec{n}(t)$ = (normalized) direction of observation = $\vec{r}(t)/|\vec{r}(t)|$;\\
 $\vec{\beta}$ = normalized velocity vector of the particle $\vec{v}/c = 
 (1/c) d\vec{R}/dt$.} }
\end{figure}
%

\subsection{Calculation of the electric field $\mathcal{E}(\vec{n}, \tau)$} \label{secN4.1}

The expression for $\mathcal{E}(\vec{n}, \tau)$ as seen by the observer in the long
distance approximation is~\cite{JDJ}
\begin{equation}
\mathcal{E}(\vec{n}, \tau) = 
	\frac{q}{4\pi\varepsilon_0c}\, 
	\frac{\vec{n}(t) \times \left[
		\left(\vec{n}(t)- \vec{\beta}(t) \right) 
		\times d\vec{\beta}/dt \right]}%
	{r(t) \left(1 - \vec{n}(t)\cdot\vec{\beta}(t) \right)^3}
 \label{eqN4.1}
\end{equation}
%\end{equation} \label{eqN4.1}
%
where $t$ is the time in which the particle motion is described and $\tau$ is the
observer time. Namely, when at position $\vec{r}(t)$ with respect to the observer [or as
well at position $\vec{R}(t) = \vec{X} - \vec{r}(t)$ in the ($O, x, y, z$) frame] the
particle emits a signal which reaches the observer at time $\tau$, such that $\tau = t +
r(t)/c$ where  $r(t)/c$ is the delay necessary for the signal to travel from the
emission point to the observer, which also leads by differentiation to the well-known
differential relation

\begin{equation}
d\tau/dt = 1 - \vec{n}(t) \cdot \vec{\beta}(t)  \label{eqN4.2}
\end{equation} 
%\end{equation} \label{eqN4.2}

\noindent The vectors $\vec{R}(t)$ and $\vec{\beta}(t) = \frac{v}{c} \vec u$ (Eq.~\ref{eq2-2-2}) that describe the motion are obtained from the ray-tracing (Eqs.~\ref{eq2-2-4}). The acceleration is calculated  from~(Eq.~\ref{eq2-2-1})
\begin{equation}
d\vec{\beta}/dt = (q/m)~\vec{\beta}(t) \times \vec{b}(t) \label{eqN4.3}
\end{equation} %\label{eqN4.3}

\noindent Then, given the observer position $\vec{X}$ in the fixed frame, it is possible
to calculate
\begin{equation}
\vec{r}(t) = \vec{X} - R(t) \text{ and } \vec{n}(t) = \vec{r}(t)/ |\vec{r}(t)| \label{eqN4.4}
\end{equation} %\label{eqN4.4}

\section*{The calculation of $\vec{n} - \vec{\beta}$ and $1 - \vec{n} \cdot \vec{\beta}$}
 
Owing to computer precision the crude computation of $\vec{n} -
\vec{\beta}$ and $ 1 -\vec{n}\cdot \vec{\beta}$ may lead to
$$
	\vec{n} - \vec{\beta} = 0 \text{ and } - \vec{n}\cdot \vec{\beta} = 0
$$
since the preferred direction of observation is generally almost parallel to
$\vec{\beta}$ (exactly parallel in the sense of computer precision), while $\beta
\approx$ 1 as soon as particle energies of a few hundred times the rest mass are
concerned.

\noindent It is therefore necessary to express $\vec{n} - \vec{\beta}$ 
and $1 -\vec{n} \cdot
\vec{\beta}$ in an adequate software form for achieving accurate  computation.

\noindent The expression for $\vec{n}$ is

\begin{multline} \label{eqN4.5}
	\vec{n} = (n_x, n_y, n_z) = (\cos \Psi\,\cos \phi, \cos \Psi \,\sin 
		\phi, \sin \Psi)  \\
	= \left[1 - 2 (\sin^2\phi/2 + \sin^2 \Psi/2) + 4 \sin^2\phi/2 \sin^2\Psi/2, 
		\sin \phi (1 - 2\sin^2\Psi/2), \sin \Psi \right]
\end{multline}
%
where $\phi$ and $\Psi$ are the observation angles, given by 

\begin{equation}
	\phi = \text{Atg} \left( \frac{r_y}{ r_x}\right)
	\text{ and }  \Psi = \text{Atg}\left( \frac{r_z}{\sqrt{r_x^2 + r_y^2}}\right) \label{eqN4.6}
\end{equation} %\label{eqN4.6}
%
with $\vec{r} = (r_x, r_y, r_z)$, while $\vec{\beta}$ can be written under the form

\begin{multline} \label{eqN4.7}
	\vec{\beta} = (\beta_x, \beta_y, \beta_z) = 
		\left[ \sqrt{(\beta^2 - \beta^2_y - \beta_z^2)},\beta_y, \beta_z 
		\right] \\
	= \left[ \sqrt{(1 - 1/\gamma^2 - \beta_y^2 - \beta_z^2)}, \beta_y, 
		\beta_z \right] = (1 - a/2 + a^2/8 - a^3/16 +...,\beta_y, \beta_z) 
\end{multline}
%
where $a = 1/ \gamma^2 + \beta^2_y + \beta^2_z$. This leads to

\begin{gather*}
	\vec{n}_x = 1 - \varepsilon_x 
		\text{ and } \vec{\beta}_x = 1 - \xi_x  \\
\intertext{with}
\varepsilon_x = 2 (\sin^2\phi/2 + \sin^2\Psi/2) - 4 \sin^2\phi/2  \sin^2\Psi/2 \\
\intertext{and}
\xi_x = a/2 - a^2/8 + a^3/16 +...
\end{gather*}

\noindent All this provides, on the one hand, 

\begin{equation}
\vec{n} - \vec{\beta} = (-\varepsilon_x + \xi_x, n_y - \beta_y, n_z - \beta_z)~,  \label{eqN4.8}
\end{equation}   %\label{eqN4.8}
%
whose components are combinations of terms of the same order of magnitude
($\varepsilon_x$ and $\xi_x \sim 1/\gamma^2$ while $n_y, \beta_y, n_z$ and $\beta_z \sim
1/\gamma$) and, on the other hand,

\begin{equation}
1 - \vec{n} \cdot \vec{\beta} = \varepsilon_x + \xi_x - n_y\beta_y - n_z\beta_z -  \label{eqN4.9}
\varepsilon_x\xi_x~,
\end{equation}  %\label{eqN4.9}
%
that combines terms of the same order of magnitude ($\varepsilon_x, \xi_x, n_y\beta_y$
and $n_z\beta_z \sim 1/\gamma^2$), plus $\varepsilon_x\beta_x \sim 1/\gamma^4$.

\noindent The precision of these expressions is
directly related to the order at which the series

$$
	\xi_x = a/2 - a^2/8 + a^3/16 +... \qquad(a = 1/\gamma^2 + \beta_y^2 +\beta^2_z)
	$$
is pushed, however the convergence is   fast since $ a \sim 1/\gamma^2 << 1$.

\subsection{Calculation of the Fourier transform of the electric field}\label{secN4.2}

The Fourier transforms
$$
	FT_\omega  [ \mathcal{E}(\tau)] = \int \mathcal{E} (\tau) e^{-i\omega\tau} d\tau~$$
of the $\sigma$ and $\pi$ electric field components provide the spectral angular
brightness
\begin{equation}
	\partial^3P/\partial\phi\, \partial\Psi\, \partial\omega 
		= 2 r^2 \left| FT_\omega \left( \mathcal{E}(\tau) \right)  \label{eqN4.10}
		\right|^2 / \mu_0 c
\end{equation}  %\label{eqN4.10}
%
They are calculated in a regular way, without using the FFT technic, namely from 

\begin{equation}
	FT_\omega \left[ \mathcal{E} (\tau) \right] 
		\approx \sum \mathcal{E}(\tau_n)\, e^{-i\omega\tau_n} \, \Delta\tau_n  \label{eqN4.11}
\end{equation}    %\label{eqN4.11}
%
for two reasons. On the one hand, the number of integration steps ds that define the
trajectory (Eqs.~\ref{eq2-2-4}), is fully arbitrary and therefore in general not of order $2^n$.
On the other hand, the integration step defines a constant time differential element 
$\Delta t_n = ds/ \beta c$ which results in the observer differential time 
element $ \Delta \tau_n$, which is
also the differential element of the Fourier transform, being non-constant, since both
are related by eq.~\ref{eqN4.2} in which $\vec{\beta}$ and $\vec{n}$ 
vary as a function of the number $n$ of integration steps.

\noindent Another major point is that  $ \Delta \tau_n$ may reach drastically small values 
in the region of the central peak of the electric impulse emitted in 
a dipole ($1 - \vec{n}(t) \cdot \vec{\beta} (t) \to
1/2\gamma^2$), while the total integrated time $\sum_{k=0 \to N} \Delta \tau_k$ may be several
orders of magnitude larger. In terms of the physical phenomenon, the total duration of the electric 
field impulse as seen by the observer corresponds to the time delay $ \sum \Delta \tau_n$
that separates photons emitted at the
entrance of the magnet from photons emitted at the exit, but the significant  part of it
(in terms of energy density) which can be represented by the width 
$ 2\tau_c = \dfrac{2(1 +\gamma^2\psi^2)^{3/2}~2\rho }{ 3\gamma^3~c}$
of the peak of
radiation \cite{after}, is a very small fraction of $ \sum_{k=0 \to N} \Delta \tau_k$.

\noindent The consequence is that, once again in relation with computer precision, the
differential  element $\Delta \tau_n$ involved in the computation of 
eq.~\ref{eqN4.11} cannot be derived from such relation as 
 $\Delta\tau_n = \sum_{k=0 \to n} \Delta\tau_k - \sum_{k=0 \to n-1} \Delta \tau_k$ 
but instead must be stored as such beforehand.


%%%%%%%%%%%%%%%%% previous part 4 %%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\section{DESCRIPTION OF THE AVAILABLE PROCEDURES} \label{sec4}

\subsection{Introduction} \label{4.1} 


This chapter gives a detailed description of how the \zgou\ 
procedures work, and their associated keywords. It has been 
split into several sections. Sections~\ref{sec4.2} to~\ref{sec4.5} explain the 
underlying content and functioning of all available keywords. 
Section~\ref{sec4.6} is dedicated to the description of some general 
procedures that may be accessed by means of special data or flags 
(such as negative integration steps), or through the available 
keywords (such as multiturn tracking with \textsl{REBELOTE\index{REBELOTE}}). 

\subsection{Definition of an Object} \label{sec4.2}

The description of the object, \emph{i.e.}, initial coordinates of the 
beam, must be the first element of the input data to \zgou. 
 \bigskip

\noindent Several types of automatically generated objects are available, 
as described in the following pages.

\newpage

\subsubsection*{MCOBJET: - Monte Carlo Generation of a 6-D Object} \label{MCOBJET} \index{MCOBJET}
\index{Monte Carlo}\index{negative charge}\index{negative momentum}

\noindent \textsl{MCOBJET} generates a set of up to 200 random initial
conditions. It is generally used in conjunction with the keyword \textsl{REBELOTE\index{REBELOTE}},
which allows 
generating an arbitrarily high number of initial conditions. 
 \bigskip

\noindent The first datum is the reference rigidity (negative value 
allowed)
$$ BORO = \dfrac{p_0 }{ q} \text{ (kG.cm)} $$

\noindent Depending on the value of the next datum, \textsl{KOBJ}, the 
\IMAX ($\leq 200$) particles have their initial random 
conditions $ Y$, $T$, $Z$, $P$, $X$ and $ D $ (relative momentum)  generated 
on 3~different types of supports, as described below. 

\noindent Next come the data
$$ KY,\quad KT,\quad KZ,\quad KP,\quad KX,\quad KD $$
that specify the type of probability density for each one of the 
6~coordinates.

\noindent $KY$, $KT$, $KZ$, $KP$, $KX$ can take the following values:
\begin{enumerate}
\item uniform density, $p(x) =1$ if  $-\delta x \leq x \leq \delta x$, $p(x) = 0$ elsewhere,
\item Gaussian density, $p(x) = \dfrac{1}{\delta x \sqrt{2\pi}} 
	e^{- \frac{x^2}{2 \delta x^2}}$,
\item parabolic density, $p(x) = \dfrac{3}{4 \delta x} 
	(1- \dfrac{x^2}{\delta x^2})$ if $-\delta x \leq x \leq \delta x$, $p(x) = 0$ elsewhere.
\end{enumerate}

\noindent $KD$ can take the following values:
\begin{enumerate}
\item uniform density, $p(D) =1$ if  $-\delta D \leq D \leq \delta D$, $p(D) = 0$ elsewhere,
\item exponential density, $p(D) = N_0 \exp (C_0 + C_1 l + C_2 l^2 + C_3 l^3)$
	with $0 \leq l \leq 1$ and $-\delta D \leq D \leq \delta D$,
\item $p(D)$ is determined by a kinematic relation, namely, with $T=$ 
horizontal angle, $D= \delta D \ast T$.
\end{enumerate}

\noindent Next come the central value for the random sorting, 
$$    Y_0,\quad    T_0,\quad    Z_0,\quad P_0,\quad  X_0, \quad D_0 $$
%
namely, the probability density laws $p(x)$ ($x= Y, T, Z, P$ or $X$) 
and $p(D)$ described above apply to the variables $x-x_0$
( $\equiv Y- Y_0$, $T-T_0$, ...) and $D- D_0$ respectively. Negative 
value for $D_0$ is allowed (see section~\ref{sec4.6.7}).
 \bigskip

\noindent\textbf{KOBJ  =  1}: Random  generation of \IMAX particles  
in a hyper-window with widths
(i.e., the half-extents for uniform or parabolic distributions ($KY, 
KT, ... =1$ or 3) and the r.m.s.~width for Gaussian distributions ($KY, 
KT, ... =2$))
$$   \delta Y,\quad   \delta T,\quad   \delta Z,\quad   \delta P,\quad   \delta X,\quad  \delta D $$

\noindent Then follow the cut-off values, in units of the 
r.m.s.~widths $\delta Y$, $\delta T$, ... (used only for  Gaussian distributions 
$KY, KT, ... =2$)
$$
	N_{\delta Y},\quad N_{\delta T},\quad N_{\delta Z},\quad N_{\delta P},\quad N_{\delta X},\quad N_{\delta D}
$$	 
\noindent The last data are the parameters 

$$ N_0,\quad C_0,\quad C_1,\quad C_2,\quad C_3 $$ 
%
 needed for generation of the $ D $ coordinate upon option
 $ KD  =  2$ (unused if $ KD = 1,~3$) and a set of three integer seeds for initialization of random sequences,
 
 $$ IR1,\quad   IR2, \quad  IR3 \quad \text{(all $\simeq 10^6 $)}$$
%

\medskip

\noindent All particles generated by \textsl{MCOBJET\index{MCOBJET}}  are tagged with
a (non-S) character, for further statistic purposes 
(e.g., with \textsl{HISTO\index{HISTO}} and \textsl{MCDESINT\index{MCDESINT}}).  
\medskip

\noindent\textbf{KOBJ  =  2}: Random  generation of 
$ IY \ast   IT  \ast IZ \ast  IP  \ast  IX  \ast  ID $ particles    
(maximum 200) in a  hyper-grid.  The input data are the number of bars    in 
each coordinate

 \begin{gather*}
	 IY,\quad IT,\quad IZ,\quad IP,\quad IX, \quad ID \\
%
\intertext{the spacing of the bars} 
	PY,\quad PT,\quad PZ,\quad PP,\quad PX, \quad PD \\
%
\intertext{the width of each bar} 
	\delta Y,\quad \delta T,\quad \delta Z,\quad \delta P,\quad \delta X,\quad \delta D  \\
%
\intertext{the cut-offs, used with Gaussian densities (in units of the r.m.s. widths)}
	N_{\delta Y},\quad N_{\delta T},\quad N_{\delta Z},\quad N_{\delta P},\quad N_{\delta X},\quad N_{\delta D}
 \end{gather*}
%\medskip

\noindent This is illustrated in Fig.~\ref{fig5}.

\medskip

\noindent The last two sets of data in this option are the parameters 

 \begin{gather*}
	N_0,\quad C_0,\quad C_1,\quad C_2,\quad C_3 
 \end{gather*}
%
 needed for generation of the $ D $ coordinate upon option \mbox{KD=  2}  
(unused if \mbox{KD= 1, 3}) and a set of three integer seeds for initialization 
of random sequences, $ IR1$,   $ IR2$,   and $ IR3$ (all $\simeq 10^6 $).

%\medskip

\noindent All particles generated by \textsl{MCOBJET\index{MCOBJET}}  are tagged with
a (non-S) character, for further statistic purposes (see \textsl{HISTO\index{HISTO} \textrm{and}  
MCDESINT\index{MCDESINT}}).  

\medskip

\noindent\textbf{KOBJ  = 3:} Distribution of \textsl{IMAX} particles inside a
6-D ellipsoid defined by the three sets of data (one set per 
2-D phase-space)

$$
\begin{array}{*{4}{r<{,}}r}
 \alpha_ Y  &   \beta_ Y  
            &  \dfrac{ \varepsilon}{\pi}\,  \varepsilon_ Y  
            &  N_{\varepsilon_ Y} [ 
            & N'_{\varepsilon_ Y}, \text{ if } N_{\varepsilon_ Y} < 0] \\
\alpha_ Z   &  \beta_ Z  
            &  \dfrac{ \varepsilon }{ \pi}  \varepsilon_ Z 
            & N_{\varepsilon_ Z}[ 
            & N'_{\varepsilon_ Z}, \text{ if } N_{\varepsilon_ Z} < 0] \\
\alpha_ X   & \beta_ X 
            &  \dfrac{\varepsilon }{ \pi}  \varepsilon_ X 
            & N_{\varepsilon_ X}[ 
            & N'_{\varepsilon_ X}, \text{ if } N_{\varepsilon_ X} < 0] 
\end{array}           
$$            
%
where $\alpha$, $\beta$ are the ellipse parameters and $\varepsilon/ 
\pi$ the emittance, corresponding to a frontier given, e.g., in the ($Y, T$) plane by 
$\dfrac{1 + \alpha^2_Y}{\beta_Y} Y^2 + 2 \alpha_Y YT + \beta_Y T^2 = 
\varepsilon_Y / \pi$ (idem for the ($Z, P$) 
or ($X, D$) planes). $N_{\varepsilon_ Y}$, $N_{\varepsilon_ Z}$ and 
$N_{\varepsilon_ X}$ are the sorting cut-offs (used only for Gaussian 
distributions, $KY, KT, ...=2$).

\noindent The sorting is uniform in surface (for $KY=1$, or $KZ=1$ 
or $KX=1$) or Gaussian ($KY=2$ or $KZ=2$), and so on, as described 
above. A uniform sorting has the ellipse above for support. A 
Gaussian sorting has the ellipse above for r.m.s.~frontier, leading 
to $\sigma_Y = \sqrt {\beta_Y \varepsilon_Y / \pi}$, 
$\sigma_T = \sqrt {\dfrac{(1+\alpha_Y^2)}{\beta_Y} \varepsilon_Y / \pi}$, 
and similar relations for $\sigma_Z$, $\sigma_X$.

\noindent If $N_\varepsilon$ is negative, thus the sorting fills the 
elliptical ring that extends from $\left| N_\varepsilon \right|$ to 
$N'_\varepsilon$ (rather than the inner region determined by the $N_\varepsilon$ 
cut-off, as addressed above).
\newpage
\vfill
%%%%%%%%%%%%%%figure %%%%%%%%%%%%%
 \begin{figure}[H]
  % \vspace*{19 truecm}
\centerline{\includegraphics[width=15cm,angle=-90]{Fig5.ps}}  %% now 6
	\hangcaption[Fig5]{\label{fig5}Scheme of the input parameters to \textsl{MCOBJET} 
	when \KOBJ = 3, 4\\
   A: A distribution of the $ Y $ coordinate\\ 
B: 2-D grid in ($ Y, Z $) space.} 
 \end{figure}
 \vfill 

\newpage

 
\subsubsection*{OBJET:  - Generation of an Object} \label{OBJET} \index{OBJET}
\index{negative charge}\index{negative momentum}

\textsl{OBJET} is dedicated to the determination of the initial
coordinates, in several ways.  
\medskip

\noindent The first datum is the reference rigidity (negative value 
allowed)
 
$$ \text{\textsl{BORO}} = \dfrac{p_0 }{ q}  $$

\noindent At the object, the beam is defined by a set of particles (maximum~200) with 
the initial conditions ($ Y$, $T$, $Z$, $P$, $X$, $D$)  where $ D $ 
is the relative momentum. 

\noindent Depending on the value of the next datum \textsl{KOBJ}, these initial
conditions may be generated   in six different ways:   
\bigskip

\noindent\textbf{KOBJ  =  1}:  Defines a grid in the $ Y$, $T$, $Z$, $P$, $X$, $D$
 space. One gives the number of points desired,
 
 \begin{gather*}
	 IY,\quad IT,\quad IZ,\quad IP, \quad IX, \quad ID\\
\intertext{(maximum 21 in each coordinate: $ IY\leq 21 \ldots ID\leq 21) $ and the
		sampling size} 
	 PY,\quad PT,\quad PZ,\quad PP,\quad PX, \quad PD  
 \end{gather*}


\noindent\zgou\  then generates 
$ IY  \ast  IT  \ast  IZ \ast   IP \ast IX \ast  ID $ ($\leq  200$) initial conditions with the 
following coordinates

$$
  \begin{array}{*{5}{r<{,}}}
	  0  &  \pm PY &   \pm 2  \ast   PY & \ldots & \pm IY/2  \ast   PY \\
	  0  &  \pm PT &   \pm 2 \ast   PT  & \ldots &  \pm IT/2  \ast   PT \\
	  0  &  \pm PZ &   \pm 2 \ast  PZ   & \ldots &  \pm IZ/2 \ast PZ \\
	  0  &  \pm PP &   \pm 2  \ast PP  & \ldots  &  \pm IP/2  \ast  PP \\
	  0  &  \pm PX &   \pm 2  \ast  PX & \ldots  &  \pm IX/2 \ast   PX \\
 	  0  &  \pm PD &   \pm 2  \ast  PD & \ldots  &  \pm ID/2 \ast   PD 
 \end{array}
 $$

\noindent In this option relative momenta will be classified automatically for
the purpose of the use of \IMAGES\index{IMAGES} for momentum analysis.


\noindent The particles are tagged with an index \textsl{IREP}  eventually
indicating a symmetry with respect to the ($ X$,$Y$) plane, as explained in option 
\mbox{\KOBJ= 3}. If two trajectories have mid-plane symmetry, only one of them will be 
ray-traced, while the other will be deduced using the mid-plane 
symmetries. This is done for the purpose of saving computing time. It may 
be incompatible with the use of some procedures (e.g.~\textsl{MCDESINT\index{MCDESINT}}, which 
involves random processes). 

\noindent The last datum is the relative momentum of the problem, 
$ \mathcal{D} $ : the reference 
rigidity of the beam is $ \mathcal{D} \ast$ \textsl{BORO}, resulting in the
rigidity of a particle 
of initial condition $ I\ast PD $, for instance, to be $ (\mathcal{D}+I\ast
PD)\ast \text{\textsl{BORO}}$. 
\bigskip

\noindent\textbf{KOBJ = 2:}  Next data: \textsl{IMAX\index{IMAX}},  
\textsl{IDMAX\index{IDMAX}}. Initial coordinates
are entered explicitly for each 
trajectory.  \IMAX\index{IMAX}  is the total number of particles (\IMAX$\leq 200$).  
These may be classified in groups of equal number for each value of momentum, in order to 
fit the requirements of image calculations by \textsl{IMAGES\index{IMAGES}}. 
 \IDMAX\index{IDMAX} is the 
number of groups of momenta.  The  following initial 
conditions defining a particle are specified for each one of the \IMAX\index{IMAX}
 particles
 $$ Y,\quad T,\quad Z,\quad P, \quad X, \quad D,\quad ^\prime A^\prime $$
%
 where $ D\ast \text{\textsl{BORO}} $ is the rigidity (negative value 
 allowed) and $ ^\prime A^\prime $ is a
(arbitrary) tagging character.  


\noindent The last record \textsl{IEX\index{IEX}} (I=1, \textsl{IMAX\index{IMAX}})  contains 
\IMAX  $\times 1$ (which indicates that the particle will be
tracked) or \mbox{-2}  (indicates that the particle will not be tracked).  

\noindent This option \mbox{\KOBJ= 2}   may be be useful for the
definition of objects including kinematic  effects.  
\bigskip

\noindent\textbf{KOBJ $=  \pm 3$:} Next data:  \textsl{IMAX\index{IMAX}}, \textsl{IDMAX\index{IDMAX}}  
as explained for \mbox{\KOBJ= 2}.\\
This option allows the reading of initial conditions from an
external input file.  This file must be formatted so as to fit the following 
\FORTRAN sequence 

\begin{alltt}
\footnotesize
	      OPEN (UNIT = NL, FILE = FNAME, STATUS = `OLD')
	      DO 1 I = 1, IMAX
	        READ (NL,100) LET (I), IEX(I), (FO(J,I),J=1,6), (F(J,I),J=1,6), I, IREP(I),
     100        FORMAT (1X, A1, 1X, I2, 6E16.8, / , 6E16.8, 2I3, / )
        1     CONTINUE
\end{alltt} 

\noindent where the meaning of the parameters is the following   
\medskip
 
\begin{tabular}{>{\sl}l!{:}p{10cm}}
LET(I) & one-character string (for tagging)  \\
 IEX(I) &  flag, see \KOBJ = 2  \\
 FO(1-6,I) &  coordinates $ D$, $Y$, $T$, $Z$, $P $ and path length of the 
particle number $I$,  at the origin. $ D\ast \text{\textsl{BORO}} $ = rigidity \\
F(1-6,I) & idem, at the current position.
\end{tabular}
\medskip

\noindent\textsl{IREP}   is an index which indicates a symmetry with
respect to median plane.  For instance, if $ Z(I+1)=-Z(I), $ then normally 
\textsl{IREP}$(I+1)=$ \textsl{IREP}$(I)$.
Consequently the coordinates of particle $ I+1 $ will not be deduced from 
ray-tracing but instead from those of 
particle $ I $ by simple symmetry.  This results in gain of computing time.

\noindent If \mbox{\KOBJ$=+3$}, further ray-tracing starts from the current coordinates
$ F(J,I)$.  
If \mbox{\KOBJ$=-3$}, further ray-tracing starts from the initial coordinates $ FO(J,I)$.
\bigskip

\noindent\KOBJ $= \pm 3 $    can be used directly for reading
files filled by \textsl{FAISCNL}.\\
If more than 200 particles are to be read from a file, use 
\IMAX\index{IMAX}$\leq 200$  in conjunction with \textsl{REBELOTE\index{REBELOTE}}.   
\bigskip

\noindent\textbf{KOBJ = 4}: Same as \KOBJ = 1    except for the $ Z $
symmetry.  The initial 
$ Z $ and $ P $ conditions are the following 

$$
  \begin{array}{*{5}{r<{,}}}
	  0  &  \pm PZ &   \pm 2  \ast   PZ & \ldots & \pm (IZ-1)   \ast   PZ \\
	  0  &  \pm PP &   \pm 2 \ast   PP  & \ldots &  \pm (IP-1)  \ast   PP 
  \end{array}
 $$


\noindent This object results in shorter outputs when studying problems with 
$Z $ symmetry.  
\bigskip

\noindent\textbf{KOBJ = 5:} Mostly dedicated to the calculation of first order
transfer matrices, in conjunction with \textsl{MATRIX\index{MATRIX}}.  The input data are the step
sizes 
\smallskip
$$ PY,\quad PT,\quad PZ,\quad PP, \quad PX, \quad PD $$

\noindent The code generates  11 particles 
$$ 0,\quad \pm PY,\quad \pm PT,\quad \pm PZ,\quad \pm PP, \quad \pm PX, \quad \pm PD $$

\noindent These values should be small enough, so that the paraxial ray
approximation be valid. 

\noindent The last data are the initial coordinates of the reference 
trajectory [normally $(YR, TR, ZR, PR, XR, DR) = (0, 0, 0, 0, 0, 1)$]. 
The reference 
rigidity  is $ \mathcal{DR}\ast \text{\textsl{BORO}}$ 
(negative value allowed).  
\bigskip

\noindent\textbf{KOBJ = 6:}  Mostly dedicated to the calculation of first, second
and higher order transfer coefficients, in conjunction with \textsl{MATRIX\index{MATRIX}}. 
The input data are the step sizes 

$$ PY,\quad PT,\quad PZ,\quad PP, \quad PX, \quad PD $$
 
 \noindent to allow the building up of an object containing 61 particles.  The
last data are the initial coordinates of the reference 
trajectory [normally $(YR, TR, ZR, PR, XR, DR) = (0, 0, 0, 0, 0, 1)$]. 
The reference 
rigidity of the beam  is $ \mathcal{DR}\ast \text{\textsl{BORO}}$.  
\bigskip

\newpage

\noindent\textbf{KOBJ  =  7:} Object with kinematics 

\noindent The data and functioning are the same as for \mbox{\KOBJ= 1}, except for the 
following  
\begin{itemize}
\item[$\bullet$]  $ ID $ is not used,  
\item[$\bullet$]  $ PD $ is the kinematic coefficient, such that for particle
number $ I$,  the initial relative momentum $ D_I $ is calculated from the initial angle 
$T_I $ following
$$ D_I = \mathcal{D}+ PD \ast  T_I $$
 while $ T_I $ is in the range
$$ 0,\quad \pm PT,\quad \pm 2\ast PT,\quad \ldots,\quad \pm IT/2\ast PT $$
 as stated under \KOBJ = 1
\end{itemize}
\newpage
\subsubsection*{OBJETA:  - Object From Monte Carlo 
              Simulation of Decay Reaction \protect \cite{Biblio9}}  %%% [9]
 \label{OBJETA} \index{OBJETA}\index{Monte Carlo}
 
This generator simulates the reactions 

\begin{gather*}
     M_1+M_2 \longrightarrow  M_3+M_4  \\
\intertext{and then} 
     M_4 \longrightarrow  M_5 + M_6 
\end{gather*}
%
where  $ M_1 $ is the mass of the incoming body; $ M_2 $ is the mass
of the target;  $ M_3 $ is an outgoing body;  $ M_4 $ is the rest mass of the
decaying body; $ M_5 $ and $ M_6 $ are decay products. Example: 

  \begin{gather*}
	  p+d \longrightarrow^3 \text{He}  + \eta  \\
	 \eta  \longrightarrow  \mu^ ++ \mu^-
  \end{gather*}
   
\noindent The first input data are the reference rigidity 

$$ \text{\textsl{BORO}} = \dfrac{p_0 }{ q} $$

\noindent an index \textsl{IBODY} which specifies the particle to be ray-traced, namely
M3 (\textsl{IBODY} = 1),  M5 (\textsl{IBODY} = 2) or M6 (\textsl{IBODY} = 3).  In this last case, 
initial conditions for M6 must be generated by a first run of \textsl{OBJETA\index{OBJETA}} with 
\mbox{\textsl{IBODY} = 2};  they are then stored in a buffer array, and restored as initial conditions
at the next occurrence of \textsl{OBJETA\index{OBJETA}} with \mbox{\textsl{IBODY} = 3}. Note that
\zgou\ by default assumes positively charged particles.  
\bigskip

\noindent Another index, \KOBJ specifies the type of
distribution for the initial transverse coordinates $ Y$, $Z $;   
namely either uniform (\KOBJ = 1) or Gaussian 
(\KOBJ = 2).  The other three coordinates $ T$, $P$ and $ D $ are 
deduced from the kinematic of the reactions.   
\bigskip

\noindent The next data are the number of particles to be generated, 
\textsl{IMAX\index{IMAX}}, and the masses involved  in the two previous
reactions. 
 
 $$ M_1,\quad M_2,\quad M_3,\quad M_4,\quad M_5,\quad M_6 $$
%
 and the kinetic energy $ T_1 $ of the incoming body ($M_1$). 
 
\noindent Then one gives the central value of the distribution for each
coordinate 

\begin{gather*}
	Y_0,\quad T_0,\quad Z_0,\quad P_0,\quad D_0    \\
\intertext{and the width of the distribution around the central value }
	 \delta Y,\quad \delta T,\quad \delta Z,\quad \delta P,\quad \delta D \\
\intertext{so that only those particles in the range }
	Y_0-\delta Y\leq Y\leq Y_0+\delta Y\qquad \ldots \qquad D_0-\delta
	D\leq D\leq D_0+\delta D  \\
\intertext{will be retained.  The longitudinal initial coordinate is uniformly
	sorted in the range }
	 -XL \leq  X_0 \leq  XL 
\end{gather*}
 
\noindent The random sequences involved may be initialized with different
values of the 
two integer seeds $ IR_1 $ and $ IR_2 $ ($\simeq 10^6 $). 

\newpage

\subsection{Declaration of options} \label{sec4.3}

These options allow the control of procedures that affect certain 
functions of the code. Some options are normally declared right after 
the object definition (e.g.~\textsl{SPNTRK\index{SPNTRK}} - spin tracking, 
\textsl{MCDESINT\index{MCDESINT}} -
in-flight decay), the others are normally declared at the end of the data pile (e.g. 
\textsl{END\index{END}} -- end of a problem, 
\REBELOTE\index{REBELOTE} -- for tracking more than 200~particles, 
\textsl{FIT\index{FIT}} -- fitting procedure). 

\newpage

\subsubsection*{BINARY: Binary/Formatted data converter}  \label{BINARY} \index{BINARY}

This procedure translates field map data files from ``BINARY'' to 
``FORMATTED'' -- in the \FORTRAN sense, or the other way.
\bigskip

\noindent The keyword is followed, next line, by NF ($\leq
20$), the number of files to be translated.

\noindent Then follow, line per line, the NF names of the files to be 
translated.

\noindent Iff a file name begins with the prefix ``B\_'', it is 
presumed ``binary'', and hence converted to ``formatted'', and given 
the same name after suppression of the prefix ``B\_''. Conversely, 
iff the file name does not begin with ``B\_'', the file is 
presumed ``formatted'' and hence translated to ``binary'', and is 
given the same name after addition of the prefix ``B\_''.

\noindent In its present state, the procedure \textsl{BINARY} 
supports only files with the standard \textsl{TOSCA}\index{TOSCA} magnet code 
output format (see the keyword \textsl{TOSCA}\index{TOSCA}).
\newpage

\subsubsection*{FIN or END : End of Input Data List}  \label{FIN} \index{FIN} \label{END} \index{END}

The end of a problem, or of a set of several problems piled up in
the data file, should be stated by means of the keywords \textsl{FIN} or
\textsl{END}.  
\bigskip

\noindent Any information following these keywords will be ignored. 

\newpage

\subsubsection*{FIT:  Fitting  Procedure}  \label{FIT} \index{FIT}

 The keyword \textsl{FIT} allows the automatic adjustment of up to 20 
variables\index{variable}, for fitting up to 20 constraints\index{constraint}. It has been realized 
after existing routines used in the matrix transport code BETA 
\cite{Biblio10}. %%% [10]
Any physical parameter of any element (\emph{i.e.}~keyword) may 
be varied. Available constraints  are:  any of the $6 \times 6$
coefficients of the first order transfer matrix $ \lbrack R_{ij}\rbrack $ as defined in the
keyword \textsl{MATRIX\index{MATRIX}}, and its horizontal $ (R_{11 }R_{22} -R_{12} R_{21}) $ and
vertical $ (R_{33} R_{44}- R_{34} R_{43}) $ determinants; any of the
$6\times 6 \times6 $ coefficients of the second order array $ \lbrack T_{ijk}\rbrack $ 
as defined in \textsl{MATRIX\index{MATRIX}} ; any of the $ 2 \times 4 $ coefficients of the beam 
matrix as defined by

$$ \lbrack \sigma_{ ij}\rbrack  = 
\begin{pmatrix}
	\sigma_{11} &  \sigma_{12} &   &  \\
	 \sigma_{21} &  \sigma_{22} &  & \\
	             &               &  \sigma_{33} & \sigma_{34} \\
	             &               & \sigma_{43} & \sigma_{44} 
\end{pmatrix}
$$
%
 and any trajectory coordinates $ F(J,I) $ as defined in \textsl{OBJET} 
($ I $  =  particle number, $ J $  = coordinate number = 1 to 6 for 
respectively $ D$, $Y$, $T$, $Z$,$ P $ or $ S= $path length). 

\paragraph{\textit{VARIABLES}}\index{variable}

\noindent The first input data in \textsl{FIT\index{FIT}} are the number of variables
\textsl{NV}, and for each one of them, the following parameters  

\begin{tabular}{ll}
$ IR = $ &number of the varied element in the structure \\
$ IP =  $ &number of the physical parameter to be varied in this element \\
$ XC =  $ &coupling parameter. Normally $ XC=0$.  If $ XC\not= 0$, coupling will occur (see below).\\
$ DV = $ &allowed relative range of variation of the physical parameter $ IP $.
\end{tabular}

\paragraph{Numbering of the elements (\textsl{IR}): } 

\noindent The elements (\textsl{DIPOLE\index{DIPOLE}, QUADRUPO\index{QUADRUPO},} etc.) are numbered
following their sequence in the \zgou\ input data file, for the purpose of 
the \textsl{FIT\index{FIT}} procedure. The number of any element just identifies to 
its position in the data sequence. However, a simple way 
to get $ IR $ is to make a preliminary run: \zgou\ will then
print the whole structure in zgoubi.res with all elements numbered.  
%\bigskip

\paragraph{Numbering of the physical parameters (\textsl{IP}): }

\noindent In the elements  \textsl{DIPOLE\index{DIPOLE}}, \textsl{AIMANT\index{AIMANT}} 
and \textsl{EBMULT\index{EBMULT}}, \textsl{ELMULT\index{ELMULT}}, \textsl{MULTIPOL\index{MULTIPOL}}, the
numbering of the physical parameters just follows their sequence, as it is shown here after 
for \textsl{DIPOLE}: the left column below represents the input data, the 
right one the corresponding numbering to be used for the \textsl{FIT\index{FIT}} procedure. 
\begin{center}
{\renewcommand{\arraystretch}{1}
	\begin{tabular}{ll}
	\textbf{Input  data}  &  \textbf{Numbering  for  FIT}\\
      \textsl{DIPOLE}                      \\
	\textsl{NFACE,  IC,  IL}       &  1, 2, 3 \\
	\textsl{IAMAX,  IRMAX}         &  4, 5    \\
	$B_0$, $N$, $B$, $G$  &  6, 7, 8, 9\\
	\textsl{AT, ACENT, RM, RMIN, RMAX} &  10, 11, 12, 13, 14 \\
	$\lambda$ , $\xi$     &  15,16    \\
	$NC$, $C_0$, $C_1$, $C_2$, $C_3$, $C_4$, $C_5$ shift
	                      &  17, 18, 19, 20, 21, 22, 23, 24\\
	$\omega$, $\theta$, $R_1$, $U_1$, $U_2$, $R_2$ 
	                      & 25, 26, 27, 28, 29, 30 \\
	etc.                 & etc.
	\end{tabular}   }
\end{center}

\newpage %%%

\noindent For all other keywords, the parameters are numbered in the 
following way 
\begin{center}
{\renewcommand{\arraystretch}{1}
	\begin{tabular}{ll}
	KEYWORD      &   \\
	first line   & 1, 2, 3,...\\
	second  line &  10, 11, 12, 13,...\\
	this  is  a  comment &  a line of comments is skipped\\
	next line    & 20, 21, 22,...  \\
	and  so  on... & 30, 31, 32, 33,... 
	\end{tabular}    }
\end{center}


\noindent The examples of \textsl{QUADRUPO\index{QUADRUPO}} (quadrupole) and 
\textsl{TOSCA\index{TOSCA}} (Cartesian mesh field map) are given below.

\begin{center}
{\renewcommand{\arraystretch}{1}
	\begin{tabular}{ll}
	\textbf{Input  data}  &  \textbf{Numbering  for  FIT}\\
	\textsl{MULTIPOL}        \\
    $IL$                                                    &     1\\
    $XL$, $R_0$, $B$                                        & 10, 11, 12 \\
    $X_E$, $\lambda_E$                                      & 20, 21 \\
    \textsl{NCE}, $C_0$, $C_1$, $C_2$, $C_3$, $C_4$, $C_5$  & 30, 31, 32, 33, 34, 35, 36 \\
    $X_S$, $\lambda_S$, $S_2$, $S_3$, $S_4$, $S_5$, $S_6$   & 40, 41 \\
    \textsl{NCS}, $C_0$, $C_1$, $C_2$, $C_3$, $C_4$, $C_5$  &  50, 51, 52, 53, 54, 55, 56 \\
   \textsl{XPAS}                                            &  60\\
   \textsl{KPOS, XCE, YCE, ALE }                            & 70, 71, 72, 73 \\
   \\
   \textsl{TOSCA}  \\
   \textsl{IC, IL}    &  1, 2\\
   \textsl{BNORM}     &  10 \\
   \textsl{TIT}       &  This is  text \\
   $IX$,  $IY$, $IZ$  &  20, 21  \\
   \textsl{FNAME}     & This is  text \\
   $ID$, $A$, $B$, $C$  [$A^\prime$, $B^\prime$, $C^\prime$, etc if $ID \geq  2$]
             &  30, 31, 32, 33 [34, 35, 36, etc if $ID\geq 2$]  \\
   \textsl{IORDRE}    &  40   \\
   \textsl{XPAS}      & 50    \\
   \textsl{KPOS, XCE, YCE, ALE } 
             & 60,61,62,63
\end{tabular}  }
\end{center}             
             
%\newpage

\paragraph{Coupled variables  ($XC$)} 

\noindent  Coupling a variable parameter to any other parameter in the
structure is possible. This is done by giving $XC$ a value of the form $ r \cdot pp $ where
the integer part $ r $ is the number of the coupled element in the structure 
(equivalent to $ IR$, see above), and the decimal part $ pp $ is the number of its 
parameter of concern (equivalent to $ IP$,  see above) (if the parameter
number is in the range 1,...,9, then $ pp $ 
must take the form $ 0p $). For example, $ XC=20 \cdot 01 $ is a request for coupling with the
parameter number~1 of element number~20 of the structure, while $ XC=20 \cdot 10 $
is a request for coupling with the parameter number~10 of element~20.  
\bigskip

\noindent An element of the structure which is coupled (by means of $ XC\not=0) $ to a variable 
declared in the data list of the \textsl{FIT\index{FIT}} keyword, needs not appear as one of the $ NV $ 
variables in that data list (this would be redundant information).  
\bigskip

\noindent$ XC $ can be either positive or negative. If $ XC>0$,  then the
coupled parameter will be given the same value as the variable parameter  
(for example, symmetric 
quadrupoles of a symmetric triplet will be given the same field). If $ XC<0$, 
then the coupled parameter will be given a variation opposite to that of the
variable, so that the sum of the two parameters stays constant (for example, an optical 
element can be shifted while preserving the length of the structure, by coupling 
together its upstream and downstream drift spaces).  
\bigskip
 
\paragraph{Variation range  ($DV$)} 

\noindent For a parameter $ IP $ of initial value $ p $, the \textsl{FIT}\index{FIT} procedure is
allowed to explore 
the range $ p(1\pm DV)$.   
\bigskip

\paragraph{\textit{CONSTRAINTS}} \index{constraint}

\noindent The next input data in \textsl{FIT\index{FIT}} are the number of constraints,
\textsl{NC}, and for each one of them the following parameters.

\begin{center}
	\begin{tabular}{lcp{10cm}}
	$IC$        &  = &  type of the constraint (see table below).\\
	$I$, $J$    & =  &  constraint (\emph{i.e.}~$R_{ij}$, or determinants; 
	                    $T_{ijk}$; $\sigma_{ ij}$; trajectory and coordinate numbers)\\
	$IR$       &  =  &  number of the element in the \zgou\ input data file, right after which 
	                    the constraint applies   \\
	$V$        &  =  &  desired value of the constraint\\
	$W$        &  =  &  weight of the constraint (smaller $W$ for higher weight)
	\end{tabular}
\end{center}

%\newpage

\begin{table}[H]
	\renewcommand{\multirowsetup}{\centering}
	\settowidth{\LL}{\textbf{Beam matrix}}
	\begin{center}
    {\renewcommand{\arraystretch}{1}
			\begin{tabular}{|>{\bfseries}p{\LL}|c|c|c|c|}
			\hline
			 \multirow{2}{\LL}{\textbf{Type of constraint}}
			    & \multicolumn{4}{c|}{\rule{0cm}{5mm}
			    \textbf{Parameters defining the constraint}}  \\[-2mm]
			\cline{2-5}
			    & \rule{0cm}{5mm}$\mathbf{IC}$ 
			    & $\mathbf{I}$ & $\mathbf{J}$ & \textbf{Constraint}  \\
			\hline
			 Beam matrix & \rule{0cm}{5mm}0 & 1 - 4 & 1 - 4 & $\sigma_{IJ}$   \\
			  &  &  &  &   \\
			\multicolumn{1}{|c|}{\textbf{First order}}  
			    &   & 1 - 6 & 1 - 6 & $  R_{IJ} $  \\
			\multicolumn{1}{|c|}{\textbf{transfer}} & 1 & 7 & any & Horizontal determinant  \\
			\multicolumn{1}{|c|}{\textbf{coefficients}}  &    & 8 & any  &  Vertical determinant \\
			  &  &  &  &   \\
			\multicolumn{1}{|c|}{\textbf{Second order}}  
			    & 2  & 1 - 6 & 11 - 66 & $  T_{I,j,k} $  \\
			 \multicolumn{1}{|c|}{\textbf{transfer}} &  &  &  & $  (j= [J/10] ,k=J-10 [J/10] ) $  \\
			 \multicolumn{1}{|c|}{\textbf{coefficients}}  &  &  &  &   \\
			&  &  &  &   \\
			Trajectory coordinate 
			    & 3 & 1 - IMAX & 1 - 6 & $  F(J,I) $  \\
			\hline
		\end{tabular}  }
	\end{center}
		\hangcaption{This table shows the constraints available, depending on the values 
		        of $IC$, $I$ and $J$. [ ] denotes the integer part. When 
				$IC= 3$, $I$ designates the particle number and $J$ the coordinate 
				number (i.e., $D$, $Y$, $T$, $Z$, $P$ or $X$).}
%\protect\label{}
\end{table}

\noindent The coefficients 
$ \sigma_{11}(\sigma_{ 33}) = $ horizontal (vertical) dimension of the beam,
and 
$ \sigma_{ 22}(\sigma_{ 44}) = $ horizontal (vertical) divergence of the beam
are calculated by means of the procedures described in \textsl{IMAGE\index{IMAGE}}. \\
%
The fitting of the $ \lbrack \sigma_{ij}\rbrack $ matrix
coefficients supposes the tracking of a relevant population of particles within an 
adequate emittance.  
\bigskip

\noindent The coefficients $ R_{ij} $ and $ T_{ijk} $ are calculated following
the procedures described in \textsl{MATRIX\index{MATRIX}}, option \mbox{\textsl{IFOC} = 0}. 
The fitting of the $ \lbrack R_{ij}\rbrack $ matrix coefficients or
determinants supposes the tracking of particles having initial coordinates 
sampled as described in \textsl{MATRIX\index{MATRIX}} (these particles are normally defined with 
\textsl{OBJET\index{OBJET}}, \mbox{\textsl{KOBJ} = 5 or 6}). The same is true for the $ T_{ijk} $
second order coefficients (Initial coordinates normally defined with \textsl{OBJET}, 
\mbox{\textsl{KOBJ} = 6}).  
%\bigskip

\paragraph{\textit{OBJECT DEFINITION}}

\noindent Use \textsl{OBJET}, \KOBJ = 5 for constraint type $IC =0$ and 
$IC = 1$, and \KOBJ =6 for $IC=2$.

\noindent For constraint type $IC = 3$, the object is normally defined 
with keyword \textsl{OBJET}. If \KOBJ $\not= 1$, any of the 1 to 
\textsl{IMAX} trajectories can be constrained. If \KOBJ = 2, only 
the first seven trajectories can be constrained.


\paragraph{\textit{THE FITTING PROCEDURE \protect\cite{Biblio10}}}    %%%%[10]

\noindent The procedure is a direct sequential minimization of the quadratic
sum of all errors (\emph{i.e.}, differences between desired and actual values of the $NC$ 
constraints), each normalized by its specified weight $ W $ (the smaller $ W$,
the stronger the constraint). 

\noindent The step sizes for the variation of the physical parameters depend
on their initial  values, and cannot be accessed by the user. At each iteration, the 
optimum value of the step size, as well as the optimum direction of variation,
is determined for each one of the $NV$ variables. Then follows an iterative
global variation of all $NV$ variables, until the minimization fails which results in a
next iteration on the optimization of the step sizes. 

\newpage

\subsubsection*{GASCAT: Gas Scattering} \label{GASCAT}\index{GASCAT}

Modification of particle momentum and velocity vector, performed at each integration step, 
under the effect of scattering by residual gas.


\newpage

\subsubsection*{MCDESINT: Monte Carlo Simulation   of In-Flight Decay \protect\cite{Biblio11}}
              %%% [11]
\label{MCDESINT}\index{MCDESINT}\index{Monte Carlo}

 As soon as \textsl{MCDESINT}  appears in a structure
(normally, after \textsl{OBJET\index{OBJET}} or after \textsl{CIBLE\index{CIBLE}}),
 in-flight decay simulation starts. 
It must be preceded by \textsl{PARTICUL\index{PARTICUL}} for the definition of mass $ M_1 $ 
and \textsl{COM} 
lifetime $\tau_1$. 

\noindent The two-body decay simulated is 
 $$ 1 \longrightarrow  2+3 $$

\noindent The decay is isotropic in the center of mass. 
1~is the incoming particle, with mass $ M_1 $, momentum $ p_1=\gamma_1 M_1\beta_ 1c $ (relative 
momentum $ D_1= \dfrac{p_1 }{ q} \dfrac{1 }{\text{\textsl{BORO}}} $ with \BORO   = reference
rigidity, see \textsl{OBJET\index{OBJET}}),  and position $ Y_1,Z_1 $ in the \zgou\ frame. 
2~and 3 are decay products with respective masses and momenta $ M_2, $ $ M_3 $ and 
$ p_2=\gamma_ 2M_2\beta_2c$,  $ p_3=\gamma_ 3M_3\beta_ 3c$.  

\noindent The decay length  $ s_1 $ of particle~1 is related to its center of 
mass lifetime $ \tau_ 1 $ by 
$$ s_1=c\tau_ 1 \sqrt{ \gamma^ 2_1 -1} $$

\noindent The path length $ s $ up to the decay point is then calculated from
a random number $ 0<R_1\leq 1 $ by using the exponential decay formula
$$ s = - s_1 \ell n R_1 $$

\noindent After decay, particle~2  will  be ray-traced with assumed positive
charge, while particle~3 is abandoned.  Its scattering angles in the center of mass 
$ \theta^\ast $ and $\phi$ are generated from two other random numbers $0<R_2\leq 1 $ 
and $ 0<R_3\leq 1 $ by

 \begin{alignat*}{2}
	 \theta^ \ast 
	       & =   2\pi (R_2 - 0.5) & \qquad & (-\pi   <\theta^\ast \leq \pi ) \\
	\phi 
	       & =   2\pi R_3         & \qquad &  (0<\phi \leq 2\pi ) 
 \end{alignat*}
%
$\phi$ is a relativistic invariant, and $\theta$ in the laboratory
frame (Fig.~\ref{fig6}) is given by    

$$ \tan \theta = \dfrac{1 }{ \gamma_1}\, 
    \dfrac{ \sin \theta^ \ast }{\dfrac{\beta_1 }{ \beta^ \ast_ 2}+ \cos \theta^\ast} 
    $$
%
 where, $ \beta^ \ast_ 2 $ and momentum $ p_2 $ are given by 

 \begin{align*}
	 \gamma^\ast_ 2 
	         & = \dfrac{M^2_1 + M^2_2 - M^2_3 }{ 2M_1} \\
	\beta^\ast_ 2 
	         & =  \left( 1- \dfrac{1 }{ \gamma^ 2} \right)^{1/2} \\
	\gamma_2
	         & =   \gamma_1\gamma^ \ast_ 2 
	         	\left(1+\beta_1 \beta^\ast_ 2 \cos \theta^ \ast \right) \\
	p_2 
	         & = M_2 \sqrt{ \gamma^2_2 -1} 
 \end{align*}
 
\noindent Finally, $\theta$ and $\phi$ are transformed into the angles $ T_2 $
and $ P_2 $ in the \zgou\ frame, and the relative momentum takes the value 
$ D_2= \dfrac{p_2 }{ q} \dfrac{1}{\text{\textsl{BORO}}} $ (where \textsl{BORO}   
is the reference rigidity, see \textsl{OBJET\index{OBJET}}), while the starting position of 
$M_2 $ is $ Y_2=Y_1 $ and $ Z_2=Z_1 $.   
\bigskip

\noindent The decay simulation by \zgou\ obeys the following procedures.
In optical elements and field maps, after each integration step \textsl{XPAS}, the actual 
path length of the particle, $ F(6,I) $, is compared to its limit path length $ s$. 
 If $s $ is passed, then the particle is considered as having decayed at 
 $ F(6,I) - \dfrac{\text{\textsl{XPAS}} }{ 2} $, 
at a position obtained by a linear translation from the position at $ F(6,I)$.
[Presumably, the smaller \textsl{XPAS},  the smaller the error on position
and angles at the decay point].  
\bigskip
 %%%%%%%%%%%%%%figure%%%%%%%%%%%%%%
\begin{figure}[H]
%\vspace{18 truecm}
%%%Figure 6
\centerline{\includegraphics[width=17cm]{Fig6.ps}}
{\setlength{\captionwidth}{15cm}
\hangcaption[Fig6]{\label{fig6}%
At position $ M(X_1,Y_1,Z_1) $, particle~1 decays into 2 and 3; \zgou\ then calculates the trajectory of~2, while 
3 is abandoned. \\ 
$\theta$ and $\phi$ are the scattering angles of particle 2 relative to the 
direction of  the incoming particle 1; they transform to $ T_2 $ and $ P_2 $ 
in \zgou\ frame.}       }
\end{figure}

\noindent In   \textsl{ESL\index{ESL}}   and  \textsl{CHANGREF\index{CHANGREF}},  
$ F(6,I) $ is compared to $ s $ at the
end of the element. If the decay occurs inside the element, the particle is considered as having 
decayed at its actual limit path length $ s$,  and its coordinates 
at $ s $ are recalculated by translation.  
\bigskip

\noindent The limit path length of all particles  ($I=1$, \textsl{IMAX\index{IMAX}})   is stored in
the array  \textsl{FDES}$(6,I)$, for further statistical purposes. For the same purpose 
(e.g., use of \textsl{HISTO\index{HISTO}}), any particle of type~2 (resulting from decay of~1) 
will be tagged with an $ S $ standing for ``secondary''. When a particle decays, 
its coordinates $ D$, $Y$, $T$, $Z$, $P $ at the decay point are stored in  
\textsl{FDES}$(J,I)$, \mbox{$ J=1,\, 5$}.  
\bigskip

\noindent  NOTE on negative drifts: \\
The use  of  negative  drifts  with  \textsl{MCDESINT\index{MCDESINT}}  is  allowed 
and correct. 
For instance,  negative drifts  may  occur  in  a  structure   for 
some  of  the  particles  when  using  \CHANGREF\index{CHANGREF} (due to  the  $ Z$-axis 
rotation  or  negative  \textsl{XCE)},  or  when  using  \textsl{DRIFT}  with 
$XL<0$. 
Provision  has  been  made  to  take  it  into  account during  the \textsl{MCDESINT\index{MCDESINT}}
 procedure,  as follows. 

\noindent If, due   to  a  negative  drift,   a  secondary  particle  reaches 
back the  decay spot of the  primary  particle  from which it originated, then 
that  primary  particle  is  regenerated  with its original coordinates 
at  that  spot. Then   the   secondary   particle   is   abandoned   while 
ray-tracing  resumes  in  a  regular way  for the primary  particle which  
is again susceptible of decay  at  the  same  time-of-flight. This  procedure  is made 
possible  by  prior storage  of  the  coordinates of the primary 
particles (in array \textsl{FDES}$(J,I)$) each  time  a  decay  occurs. 

\noindent Negative steps (\textsl{XPAS}$<0$) in
optical elements are not compatible with  \textsl{MCDESINT\index{MCDESINT}}.  
 \newpage

\subsubsection*{ORDRE: Higher Order Taylor Expansions in lenses} \label{ORDRE} \index{ORDRE}

 The position $ \vec  R $ and velocity $ \vec  u $ of a particle are
obtained from Taylor expansions as described in eq.~(\ref{eq2-2-4}). By default, these 
expansions go to the fourth order derivative of $ \vec  u$, 

\begin{align*}
	\vec  R_1 
	     & = \vec  R_0 + \vec  u_0ds +...+ \vec u^{(4)}_0 \, \dfrac{ds^5 }{ 5!} \\
	\vec  u_1 
	     & = \vec  u_0 + \vec  u^{\,\prime}_0 \, \dfrac{ds^2 }{ 2!}
	        + \ldots + \vec  u^{(4)}_0\, \dfrac{ds^4 }{ 4!}   
\end{align*}
%
 which corresponds to third order derivatives of $ \vec  B $, since (eq.~(\ref{eq2-2-6}))
 
 $$ 
 \vec  u^{(4)} = \vec  u^{\,\prime\prime\prime}_1  \times  \vec  B 
 + 3\vec u^{\,\prime\prime}_1  \times  \vec  B^{\,\prime}  
 + 3\vec  u^{\,\prime}_1  \times \vec  B^{\,\prime\prime}  
 + \vec  u_1  \times   \vec  B^{\,\prime\prime\prime}
$$
%
 and to the third order derivatives of $ \vec  E $ (eq.~(\ref{eq2-2-10})).
However the $ \vec  B^{\,\prime\prime\prime} $ 
or $ \vec  E^{\,\prime\prime\prime} $ term may be zero in second order type
optical elements, for instance in a sharp edge quadrupole. Also, in 
several elements, not more than the first and second order 
derivatives of the fields are used. 
\bigskip

\noindent The purpose of \textsl{ORDRE}, option $ IO=5$,  is to allow
expansions of $ \vec  R $ 
and $ \vec  u $ up to the term $ \vec  u^{(5)} $ for the following optical
elements

\begin{center}
	\textsl{QUADRUPO, SEXTUPOL, OCTUPOLE, DECAPOLE, DODECAPO,
	MULTIPOL, ELMULT, EBMULT}\index{QUADRUPO}\index{SEXTUPOL}\index{OCTUPOLE}
	\index{DECAPOLE}\index{DODECAPO}\index{MULTIPOL}\index{ELMULT}\index{EBMULT} 
\end{center}

\noindent The use of \textsl{ORDRE} with $ IO=4 $ is equivalent to the default 
functioning.  
\bigskip

\noindent\textbf{NOTE}: see also the option \textsl{IORDRE\index{IORDRE}} in field map
declarations (\textsl{DIPOLE, TOSCA\index{TOSCA}}, etc.).  
 \newpage

\subsubsection*{PARTICUL: Particle Characteristics}  \label{PARTICUL} \index{PARTICUL}

\textsl{PARTICUL} allows the definition of several characteristics of
the particles (mass, charge, gyromagnetic factor and life-time in the 
center of mass), that are needed in several procedures, as follows 
\bigskip           

\begin{tabular}{>{\sl}l!{:}l}
  MCDESINT & mass,  COM  life-time\\
  SPNTRK   & mass,  gyromagnetic factor \\
  SYNRAD   & charge \\
  Electric and Electro-Magnetic elements
           & mass, charge 
\end{tabular}
\bigskip           

\noindent The declaration of \textsl{PARTICUL} must \textbf{precede} these
keywords. 

\noindent Note that, in the case of electric or electro-magnetic 
optical elements, the mass and charge are needed in order to compute 
the particle velocity $v$, as involved in eq.~\ref{eq2-2-3}.

 \newpage

\subsubsection*{REBELOTE: Jump To the Beginning of Zgoubi Input Data File} \label{REBELOTE} 
\index{REBELOTE}\index{multiparticle}\index{multiturn tracking}\index{acceleration}
\index{synchrotron motion}

As soon as \REBELOTE is encountered in the input data file,
the code execution jumps back to the beginning of the data file to start a new
run, and so on up to \textsl{NPASS}\index{NPASS} times. When the following random procedures 
are used: \textsl{MCOBJET\index{MCOBJET}, OBJETA\index{OBJETA}, MCDESINT\index{MCDESINT}, 
SPNTRK\index{SPNTRK}}
\mbox{(\textsl{KSO} = 5)},
their random seeds are not reset, and therefore independent statistics 
will add up. \REBELOTE is dedicated either to Monte Carlo\index{Monte Carlo} calculations when more 
than 200~particles are to be tracked (due to \mbox{\textsl{IMAX\index{IMAX}}  $\leq 200$}, 
see \textsl{MCOBJET\index{MCOBJET}}), 
or to the tracking in circular machines (e.g.~Synchrotron 
accelerators). The option index $ K $ is then used to either generate new 
initial coordinates ($ K=0 $ see section~\ref{sec4.6.4}), when using \textsl{MCOBJET\index{MCOBJET}}
 or
any other generator of random initial coordinates, or in order that the 
final coordinates at the last run be taken as the initial 
coordinates of the next  ($K=99 $ --- see section~\ref{sec4.6.5}).  
\bigskip

\noindent\textbf{Monte Carlo simulations}: normally $ K=0$.  \textsl{NPASS}\index{NPASS} runs
through the same structure will follow, resulting in the calculation of 
$(1+\text{\textsl{NPASS}})  \ast  \text{\textsl{IMAX}}$ trajectories.  
\bigskip

\noindent\textbf{Circular machines}: normally $ K=99$.  \textsl{NPASS} turns in
the same structure will follow, resulting in the tracking of \textsl{IMAX\index{IMAX}} 
particles over $1+\text{\textsl{NPASS}}$ turns (Note: for the simulation of 
accelerators and synchrotron motion, see \textsl{SCALING}). 
\bigskip

\noindent Output prints over \textsl{NPASS} runs might result in a
prohibitively big file. They may be inhibited by means of the option 
\mbox{\textsl{KWRIT}$= 0$}.  
\bigskip

\noindent\REBELOTE provides statistical calculations and related 
informations on particle decay \textsl{(MCDESINT\index{MCDESINT})}, spin tracking 
\textsl{(SPNTRK\index{SPNTRK})}, stopped particles (\textsl{CHAMBR\index{CHAMBR},
 COLLIMA\index{COLLIMA}}). 
 \newpage

\subsubsection*{RESET: Reset Counters and Flags}  \label{RESET} \index{RESET}

 Piling up problems in \zgou\ input data file is allowed, with 
normally no particular precaution, except that each new problem 
must begin with a new object definition (with \textsl{MCOBJET\index{MCOBJET}, OBJET\index{OBJET}}, 
etc.). Nevertheless, when calling upon certain keywords, flags, 
counters or integrating procedures are involved. 
It may therefore be necessary to reset them. This is the purpose 
of \textsl{RESET\index{RESET}} which normally appears right after the object definition 
and causes each problem to be treated as a new and 
independent one.  
\bigskip

\noindent The keywords or procedures of concern and the effect of 
\textsl{RESET} are the following 
\bigskip

\begin{tabular}{>{\sl}l!{:}p{13cm}}
  CHAMBR 
       & \textsl{NOUT} = number of stopped particles = 0;  \textsl{CHAMBR} option  switched  off \\
  COLLIMA 
       & \textsl{NOUT} = number of stopped particles = 0\\
  HISTO 
       &  Histograms are emptied\\
  INTEG 
       & \textsl{NRJ} = number of particles out of range = 0 (\textsl{INTEG} is the numerical 
           integration subroutine; \textsl{NRJ} is incremented when a particle 
            goes out of a field map)\\
   MCDESINT 
       & Decay in flight option switched off \\
  SCALING 
       &  Scaling options disabled\\
  SPNTRK 
       & Spin tracking option switched off
\end{tabular}
 \newpage

\subsubsection*{SCALING: Time Scaling of Power Supplies and R.F. Cavity} \label{SCALING} \index{SCALING} 
\index{synchrotron motion}

\textsl{SCALING} acts as a function generator dedicated to varying the
field of optical elements, or the frequency in \textsl{CAVITE\index{CAVITE}}. It is normally intended
to be declared right after the object definition, and used in conjunction 
with \textsl{REBELOTE\index{REBELOTE}}, for the simulation of multiturn tracking with acceleration
\index{acceleration} cycles.  
\bigskip

\noindent\textsl{SCALING} acts on families of elements, a family being
designated by a specific name, cataloged as such in the Program, and which coincides with 
the keyword of the corresponding element. For instance, declaring \textsl{MULTIPOL\index{MULTIPOL}} 
as to be varied will result in the same timing law being applied to all 
\textsl{MULTIPOL\index{MULTIPOL}}'s declared in the \zgou\ optical structure data file. Subsets can be selected by labeling\index{LABEL} keywords in the data file (section~\ref{sec4.6.8}) and adding the corresponding label(s) in the \textsl{SCALING} declarations. The family name of concern, as well as the field versus timing scaling law of that 
family (or frequency versus timing in the case of \textsl{CAVITE\index{CAVITE}}) are given as
input data to the keyword \textsl{SCALING\index{SCALING}}. Up to 10 families can be declared
as subject to a scaling law; a scaling law can be made of up to 10~successive timings; 
between two successive timings, the variation law is linear.  
\bigskip

\noindent An example of data formatting is given in the following  
\bigskip

{\renewcommand{\arraystretch}{1}
\noindent\begin{tabular}{lll}
  \textsl{SCALING}    &          & - Scaling \\
  1    4              &          &  Active. 4 families of elements are concerned\\
  \textsl{QUADRUPO} \textsl{QF}&          & - Quadrupoles labeled 'QF' (field at pole tip = $B_o $)\\
  2                   &          & 2 timings  \\
  18131.E-3           & 24176.E-3 \qquad 
                                 &    B increases (linearly) from 18131E-3$\ast B_o $ 
                                 to 24176E-3$\ast B_o $ \\
  1                   & 6379     &  from turn 1 to turn 6379\\
  \textsl{MULTIPOL} \textsl{QD}&          &- Multipoles labeled 'QD' (field of multipole component i at pole tip=
                                  $ B_io$) \\
  2   \\                      
  18131.E-3           &24176.E-3 & $ B_i $ increases from 18131E-3$\ast B_io $ to 
                                  24176E-3$\ast  B_io $ \\
  1                   & 6379     & from turn 1 to turn 6379\\
  \textsl{BEND}       &          &- All \textsl{BEND}'s (Bending magnets) \\
  2    \\
  18131.E-3           &24176.E-3 &  Same scaling \\
  1                   & 6379  \\
  \textsl{CAVITE}     &          &- Accelerating cavity (reference frequency=$ f_{RFo}$) \\
  2  \\
  1    1.22           &1.33352   &The synchronous rigidity $(B\rho )_s $ increases from 
                                  $ (B\rho )_{s_o} $ \\
  1    1200           & 6379     &to 1.22 $\ast (B\rho)_{s_o} $ and to 1.33352 $ (B\rho )_{s_o} $ \\
                      &          &from turn 1 to 1200 and to 6379 
\end{tabular} }                   
 \bigskip

\noindent The timing is in unit of turns. In this example, TIMING = 1 to 6379 
(turns). Therefore, at turn number $ N$, $B $ and $ B_i $ are updated in the 
following way. Let \textsl{SCALE}(\textsl{TIMING} $ = N$) be the updating scale factor

\begin{align*}
   \text{SCALE}(N) & = 18.131 \dfrac{24.176-18.131 }{ 1+6379-1} (N-1)  \\
\intertext{and then}
     B(N)   &  = \text{\textsl{SCALE}}(N)B_o \\ 
     B_i(N) &  = \text{\textsl{SCALE}}(N)B_io \\
\intertext{The cavity R.F. is calculated by}
     f_{RF} & = \dfrac{hc }{\mathcal{L}} \, 
              \dfrac{q(B\rho )_s }{ (q^2(B\rho )^2_s + (Mc^2)^2)^{1/2}} 
\end{align*}
%
where the rigidity is updated in the following way. Let $ (B\rho)_{s_o} $ be the 
initial rigidity (namely, $ (B\rho )_{s_o}= $ \BORO as defined in the keyword
\textsl{OBJET} for instance). Then, at turn number $ N$,   

\begin{alignat*}{2}
	\text{if }   1 & \leq N\leq 1200 \,          
	            & \text{\textsl{SCALE}}(N)  & =1+ \dfrac{1.22-1 }{ 1+1200-1}\, (N-1) \\
	 \text{if }   1200 & \leq N\leq 6379 \,           
	            & \text{\textsl{SCALE}}(N)  & =1.22+ \dfrac{1.33352-1.22 }{ 1+6379-1200}\,(N-1200)    
\end{alignat*}
 
 \noindent and then,

$$ (B\rho )_s(N) = \text{\textsl{SCALE}}(N)\cdot (B\rho )_{s_o} $$
%
from which value the calculations of $ f_{RF}(N) $ follow. 
\\
\\
Families amenable to scaling are,  AIMANT, BEND, CAVITE, DECAPOLE, DIPOLE, DODECAPO, MULTIPOL, OCTUPOLE, POISSON, QUADISEX, QUADRUPO, SEXQUAD, SEXTUPOL, SOLENOID, TOSCA, UNDULATOR.

\newpage

\subsubsection*{SPNTRK: Spin Tracking} \label{SPNTRK} \index{SPNTRK}

The keyword \textsl{SPNTRK} permits switching on the spin tracking
option. It also permits the attribution of an initial spin component to each one of the 
\IMAX\index{IMAX} particles of the beam, following a distribution that depends 
on the option index \textsl{KSO}. It must be preceded by \textsl{PARTICUL\index{PARTICUL}} for
the definition of the mass and gyromagnetic factor.  
\medskip

\noindent\textbf{KSO = 1  (respectively 2, 3):} the \IMAX\index{IMAX} particles
of the beam are given a longitudinal (1,0,0) spin component (respectively 
transverse horizontal (0,1,0), vertical (0,0,1)).  
\medskip

\noindent\textbf{KSO = 4:} initial spin components are entered explicitly for
each one of the \IMAX\index{IMAX} particles of the beam.  
\medskip

\noindent\textbf{KSO = 5:} random generation of \IMAX\index{IMAX} initial spin
conditions as described in Fig.~\ref{fig7}.  
Given a mean polarization axis (S) defined by its angles $ T_0 $ and $ P_0 $, 
and a cone of angle~A with respect to this axis, the \IMAX\index{IMAX} spins are sorted randomly in a 
Gaussian distribution

$$ p(a) = \exp \left[- \frac{(A-a)^2 }{ 2\delta A^2} \right]/ \delta A\,  \sqrt{2\pi}   $$
%
and within a cylindrical uniform distribution around the (S) 
axis. Examples of simple distributions available by this mean are 
given in Fig.~\ref{fig8}.  


%%%%%%%%%%%%%%figure%%%%%%%%%%%%%%
\begin{figure}[H]
%\vspace{11 truecm}
%%%Figure 7
\centerline{\includegraphics[height=10cm]{Fig7.ps}}
{\setlength{\captionwidth}{15cm}
\hangcaption[Fig7]{\label{fig7}Spin distribution as obtained with option \textsl{KSO} = 5.\\
          The spins are distributed within an annular strip 
         $\delta A$ (standard deviation)  
          at an angle $A$ with respect to the 
         axis of mean polarization (S) defined by $T_0$  and $P_0$.} 
}\end{figure}
%%%%%%%%%%%%%%figure%%%%%%%%%%%%%%
%\figureh 5cm   \figurev 7cm  
\begin{figure}[H]
%\vspace{8.5 truecm}
%%%Figure 8
\centerline{\includegraphics[width=15cm]{Fig8.ps}}
{\setlength{\captionwidth}{14cm}
\hangcaption[Fig8]{\label{fig8}Examples of the use of	\textsl{KSO} =5. \\
A: Gaussian	distribution around	a mean vertical	polarization axis, 
 obtained   with	$T_0$  = arbitrary,	$P_0 = \pi /2$,	$A = 0$ and $\delta A \not=  0$.\\
B: Isotropic distribution in the median	plane, obtained	with 
 $P_0 =	\pm	 \pi /2$, 
$A = \pi /2$,	and	$\delta	A =	0$.} }
 \end{figure}
\newpage

\subsubsection*{SYNRAD: Synchrotron Radiation}\label{SYNRAD}\index{SYNRAD}\index{synchrotron radiation}

\noindent The keyword \textsl{SYNRAD} enables (or disables) the calculation of 
synchrotron radiation (SR) electric field and brightness. It must be 
preceded by \textsl{PARTICUL}\index{PARTICUL} for the definition of 
the charge.
\bigskip

\noindent\textsl{SYNRAD} is supposed to appear a first time at the 
location where SR~calculations should start, with the first data \textsl{KSR} set 
to~1. It results in on-line storage of the electric field vector and 
other relevant quantities in zgoubi.sre \index{zgoubi.sre}, as step by step integration 
proceeds. The observer position ($XO$, $YO$, $ZO$) is specified next 
to \textsl{KSR}.
\bigskip

\noindent Data stored in zgoubi.sre:
 
 \begin{tabular}{l} 
 ($ELx$, $ELy$, $ELz$):  electric field vector $\vec\mathcal{E}$ 
 						(eq.~\ref{eqN4.1}) \\
 $(btx, bty, btz) = \vec\beta= \dfrac{1}{c} \times$ particle velocity \\
$(gx, gy, gz) = \dfrac{d\vec\beta}{dt} =$ particle acceleration (eq.~\ref{eqN4.3}) \\					
$\Delta \tau =$ observer time increment (eq.~\ref{eqN4.2}) \\
$t' = \tau  - r(t')/c = $ retarded (particle) time \\
$(rtx, rty, rtz) : \vec R(t)$, particle to observer vector (eq.~\ref{eqN4.4}) \\
$(x, y, z) =$ particle coordinates\\
$ds=$ step size in the magnet (fig. 2)\\
$NS=$ step number\\
$I=$ particle number\\
$LET(I)=$ tagging letter\\
$IEX(I)=$ stop flag (see section~\ref{sec4.6.6})
\end{tabular}
\bigskip


\noindent\textsl{SYNRAD} is supposed to appear a second time at the 
location where SR~calculations should stop, with \textsl{KSR} set 
to~2. It results in the output of the angular brightness
$\int_{\nu_1}^{\nu_2} \partial^3 P / \partial \phi \, \partial \psi 
\, \partial \nu$ (after eq.~\ref{eqN4.11}) following Fourier transform 
of the electric field (eq.~\ref{eqN4.11}). The spectral range of 
interest and frequency sampling : $\nu_1$, $\nu_2$, $N$, is specified 
next to \textsl{KSR}.
\bigskip

\noindent Note that \textsl{KSR} = 0 followed by a dummy line of 
data allows temporary inhibition of SR~procedures.
\newpage

\subsection{Optical Elements and related numerical procedures} \label{sec4.4}

\subsubsection*{AIMANT:   Generation of a Dipole Magnet 2-D Map}\label{AIMANT}\index{AIMANT}

The keyword \textsl{AIMANT} provides an automatic
generation of a dipole median plane field map in polar coordinates. A more recent and improved version will be 
found in \textsl{DIPOLE\index{DIPOLE}}. The extent of the map is defined by the 
following parameters, as shown in Figs.~\ref{fig9}A and~\ref{fig9}B. 

 \begin{tabular}{>{\sl}l!{:}l}
	 AT &  total angular aperture\\
	 RM & mean radius used for the positioning of field boundaries\\
	 RMIN, RMAX
	    &  minimum and maximum radial boundaries of the map 
 \end{tabular}
\bigskip

\noindent The 2 or 3 effective field boundaries (EFB) inside the map are
defined from  geometric boundaries, the shape and position of which are determined by the 
following parameters.  


\begin{tabular}{l!{:}l}
	 \textsl{ACENT} 
	    & arbitrary  angle, used for the positioning of the EFB's. \\
	$\omega$ &  azimuth of an EFB with respect to  \textsl{ACENT}\\
	$\theta$ & angle of a boundary with respect to its azimuth (wedge angle)\\ 
	$R_1$, $R_2$  &  radius of curvature of an EFB\\
	$U_1$, $U_2$  &  extent of the linear part of the EFB. 
\end{tabular}
\bigskip

\noindent At  any node  of the map mesh, the value of the $Z$ 
component of the field is calculated as 

 \begin{equation}
	 B_Z =  \mathcal{F} \ast  B_0 \ast  
	      \left(1+N \ast  
	           \left( \frac{R-RM }{ RM}\right) 
	           + B \ast  \left(\frac{R-RM }{ RM} \right)^2 
	           + G \ast  \left(\frac{R-RM }{ RM} \right)^3 
	      \right) 
 	\label{eq4-4-1}
 \end{equation}
%
 where  $ N$, $B $ and $ G $ are  respectively  the first, second and
third order field indices and $ \mathcal{F}$ is the fringe field 
coefficient, while the $X$ and $Y$ components of the field are 
assumed to be zero on the map mesh. 

\subsubsection*{Calculation of the Fringe Field Coefficient} 

With  each EFB a realistic extent of the fringe field, $\lambda$, 
is associated (Figs.~\ref{fig9}A and~\ref{fig9}B),  
and a fringe field coefficient $ F$ is 
calculated. In the following $\lambda$ stands for either $ \lambda_ E $
(Entrance), $ \lambda_ S $ (Exit) or $ \lambda_ L $ (Lateral EFB). 

\noindent If a node of the map mesh is at a distance of the EFB larger than
$\lambda$, then $ F=0 $ outside the field map and $ \mathcal{F}=1 $ inside.  
If a node is inside the fringe field zone, then $  F$   is calculated as follows. 

\noindent Two options are available, for the calculation of $ F$, depending
on the value of $\xi$. 

\noindent\textbf{If } $\mathbf{\xi  \geq 0}$, $ F $ is a  second
order type fringe field (Fig.~\ref{fig11}) given by 


\begin{gather}
	\begin{alignedat}{2}
		F & = \dfrac{1 }{ 2} \, \dfrac{(\lambda -s)^2 }{ \lambda^2-\xi^ 2} \quad 
		         & \text{if } &  \xi  \leq  s \leq \lambda \\
		F & = 1- \dfrac{1 }{ 2} \, \dfrac{(\lambda -s)^2 }{ \lambda^2-\xi^ 2}\quad 
		        & \text{if } &  -\lambda  \leq  s \leq  -\xi 
	\end{alignedat} \label{eq4-4-2}\\
\intertext{where $ s $ is the distance to the EFB, and} 
	 \begin{alignedat}{2}
		 F & = \dfrac{1 }{ 2} + \dfrac{s }{ \lambda +\xi} \quad
		        & \text{if } & 0 \leq  s \leq  \xi  \\
	    F  & = \dfrac{1 }{ 2} - \dfrac{s }{ \lambda +\xi}\quad  
		       &\text{if } &  -\xi  \leq  s \leq  0  
	 \end{alignedat} \label{eq4-4-3}
\end{gather}
 
\noindent This simple model allows a rapid calculation of the fringe field,
but may lead to erratic behavior of the field when extrapolating out of the median plane, 
due to the discontinuity of $ d^2B/ds^2 $ at $ s=\pm \xi $ and $ s=\pm \lambda $. 
For more accuracy it is better to use the next option. 

\newpage
%%%%%%%%%%%%%%figure%%%%%%%%%%%%%%
\begin{figure}[H]
%\vspace{21 truecm}
%%%Figure 9
\centering
            \includegraphics[width=12cm]{Fig9a.ps}
            \vfill
            \includegraphics[width=12cm]{Fig9b.ps}
\hangcaption[Fig9]{\label{fig9}A: Parameters used to define the field map and 
geometric boundaries. \\
  B: Parameters used to define the field map and fringe fields.}  
\end{figure}  
\newpage

\noindent\textbf{If $\mathbf{\xi  = -1}$},  $ F $ is an exponential type
fringe field (Fig.~\ref{fig11}) given by~\cite{Biblio12}  %%%   [12]

 \begin{gather}
	 F = \dfrac{1 }{ 1+ \exp  P(s)}
 	\label{eq4-4-4} \\
\intertext{where $ s $ is the distance to the EFB, and }
    P(s) = C_0
       +C_1 \left(  \dfrac{s }{ \lambda} \right) 
       +C_2 \left( \dfrac{s }{ \lambda} \right)^2 
       + C_3 \left( \dfrac{s }{ \lambda} \right)^3 
       +C_4 \left( \dfrac{s }{ \lambda} \right)^4 
       + C_5 \left(\dfrac{s }{ \lambda} \right)^5 \label{eq4-4-5}
\end{gather}
%
The values of the coefficients $ C_0 $ to $ C_5 $ should be such that the 
derivatives of $ B_Z$ with respect to $ s $ be negligible at $ s=\pm \lambda $, so as not
to perturb the extrapolation of $ \vec B $ out of the median plane  (this restriction 
no longer holds in the improved version \textsl{DIPOLE\index{DIPOLE}}).  

\noindent It is also possible to simulate a shift of the EFB, by giving a non
zero value to the parameter \textsl{SHIFT}.  $ s $ is then changed to $ s  -$~\textsl{SHIFT} in the 
previous equation.   This allows small variations of the total 
magnetic length. 

\noindent Let $ F_E $ (respectively $ F_S$, $F_L$)   be the fringe field
coefficient attached to the entrance (respectively exit, lateral) EFB following eqs.\ above. At any
node of the map mesh, the resulting value of the fringe field coefficient (eq.~\ref{eq4-4-1}) is 
(Fig.~\ref{fig12})  

$$ \mathcal{F}= F_E \ast  F_S \ast  F_L $$
%
 ($F_L=1 $ if no lateral EFB is requested). 

\subsubsection*{The Mesh of the Field Map} 

The magnetic field is calculated at the nodes of a mesh with polar
coordinates, in the median plane.  The radial step is given by 
 \begin{align*}
	 \delta R & = \dfrac{\text{\textsl{RMAX - RMIN}} }{\text{\textsl{IRMAX}}-1} \\
\intertext{ and the angular step by} 
	\delta \theta  & = \dfrac{AT }{ \text{\textsl{IAMAX}}-1} 
 \end{align*}
%
\noindent where, \textsl{RMIN} and  \textsl{RMAX}   are the lower and upper
radial limits of the field map, and $ AT $ is its total angular aperture (Fig.~\ref{fig9}B).  
 \textsl{IRMAX} and  \textsl{IAMAX} are the total number of nodes in the radial and 
 angular directions. 
 

 
 \subsubsection*{Simulating Field Defects and Shims } 
 
  Once the initial map is calculated, it is possible to modify it by
means of the parameter \textsl{NBS}, so as to simulate field defects or shims. 
\bigskip

\noindent\textbf{If} $\mathbf{NBS = -2}$, the map is globally modified by a
perturbation proportional to $ R-R_0 $, where $ R_0 $ is an arbitrary radius, 
with an amplitude $ \Delta B_Z/B_0 $, so that $ B_Z $ at the nodes of the mesh is replaced by 

$$ B_Z \ast  \left( 1+ \frac{\Delta B_Z }{ B_0} \,
                 \frac{R-R_0 }{\text{\textsl{RMAX}} - \text{\textsl{RMIN}}} \right) $$


\noindent\textbf{If} $\mathbf{NBS = -1}$, the perturbation is proportional to
$ \theta -\theta_ 0 $, and $ B_Z $ is replaced by 

$$ B_Z \ast  \left(1+ \frac{\Delta B_Z }{ B_0}\, \frac {\theta -\theta_ 0 }{ AT}\right) $$


\newpage

%%%%%%%%%%%%%%figure%%%%%%%%%%%%%%
\begin{figure}[H]
  \centering
%%%Figure 10
  \includegraphics[width=9cm]{Fig10.ps}
  \vfill
%%%Figure 11
  \includegraphics[width=9cm]{Fig11.ps}
\caption{\label{fig11}Second order type fringe field (leftt plot) and exponential type fringe field (right plot).}
\end{figure}

\vfill
\begin{figure}[H]
%\vspace{10 truecm}
%%%Figure 12
\centerline{\includegraphics[width=12cm]{Fig12.ps}}
{\setlength{\captionwidth}{15cm}
\hangcaption[Fig12]{\label{fig12} Effective value of $\mathcal{F}$ for overlapping fringe
fields $ F_1 $ and $ F_2 $ centered at $ O_1 $ and $ O_2 $. }}
\end{figure}

\newpage


\noindent\textbf{If } $\mathbf{NBS \geq 1}$, then \textsl{NBS} shims are introduced at
positions $ \dfrac{R_1+R_2 }{ 2}$, $\dfrac{\theta_ 1+\theta_ 2 }{ 2} $  
(Fig.~\ref{fig13}) \cite{Biblio13}  %%    [13]

\noindent The initial field map is modified by shims with second order
profiles given by 

$$ \theta  = \left(\gamma  + \frac{\alpha }{ \mu} \right) 
       \,\beta  \, \frac{X^2 }{\rho^ 2} $$
%
 where $ X $ is shown in  Fig.~\ref{fig13},  
 $ \rho =\dfrac{R_1+R_2 }{ 2}$ is 
the central radius, $\alpha$ and $\gamma$ are the angular limits of the shim, 
$\beta$ and $\mu$ are parameters. 

\noindent At each shim, the value of $ B_Z $ at any node of the initial map is
replaced by 

$$ B_Z \ast  \left(1+F\theta  \ast  FR \ast  \frac{\Delta B_Z }{ B_0} \right)
$$
%
 where $ F\theta =0 $ or $ FR=0 $ outside the shim, and $ F\theta =1$ and $ FR=1 $ inside.  

\subsubsection*{Extrapolation Off Median Plane} 

The vector field $ \vec  B $ and its derivatives in the median plane are 
calculated by means of a second or fourth order polynomial 
interpolation, depending 
on the value of the parameter \textsl{IORDRE\index{IORDRE}} (\textsl{IORDRE}=2, 25 or 4, 
see section~\ref{sec2.4.2}). 
The transformation from polar to Cartesian coordinates is performed 
following eqs.~(\ref{eq2-4-8} or \ref{eq2-4-9}). Extrapolation off median phase is then performed 
by means of Taylor expansions following the procedure described in section~\ref{sec2.3.2}.  


\vfill 

%%%%%%%%%%%%%%figure%%%%%%%%%%%%%%
\begin{figure}[H]
%\vspace{20 truecm}
%%%Figure 13
\centerline{\includegraphics[height=10cm]{Fig13.ps}}
{\setlength{\captionwidth}{14cm}
\hangcaption[Fig13]{\label{fig13}A second order profile shim.  The shim is centered at 
$ \dfrac{(R_1+R_2) }{ 2} $ and $ \dfrac{(\theta_ 1+\theta_ 2) }{ 2} $.}   }
\end{figure}




\newpage

\subsubsection*{AUTOREF: Automatic transformation to a new reference frame}\label{AUTOREF}
\index{AUTOREF} 

\textsl{AUTOREF} positions the new reference frame following 3~options:
\bigskip

\noindent\textbf{If} $\mathbf{I = 1}$, \textsl{AUTOREF} is equivalent to 

$$ \text{\textsl{CHANGREF}} \lbrack XCE=0, YCE=Y(1), ALE=T(1)\rbrack $$
\index{CHANGREF}%
 so that the new reference frame is at the exit of the last element,
with particle~1 at the origin with its horizontal angle set to $ T=0$.   
\bigskip

\noindent\textbf{If} $\mathbf{I=2}$, it is equivalent to

$$ \text{\textsl{CHANGREF}} \lbrack XW, YW, T(1)\rbrack $$
%
 so that the new reference frame is at the position $ (XW, YW) $ of
the waist (calculated automatically in the same way as for 
\textsl{IMAGE\index{IMAGE}}) of the three rays number 1, 4 and 5 (compatible for instance
with \textsl{OBJET\index{OBJET}, KOBJ}  =  5, 6 together with the 
use of \textsl{MATRIX})\index{MATRIX} while $T(1)$ is set to zero.  
\bigskip

\noindent\textbf{If} $\mathbf{I=3}$,  it is equivalent to 

$$\text{\textsl{CHANGREF}} \lbrack XW,YW,T(I1)\rbrack $$
%
 so that the new reference frame is at the position $ (XW, YW) $ of
the waist (calculated automatically in the same way as for 
\textsl{IMAGE}) of the three rays number I1, I2 and I3 specified as data,  while $T(1)$ is set to zero.
 
\newpage


\subsubsection*{BEND: Bending magnet}\label{BEND}  \index{BEND}

\textsl{BEND}  is one of the several keywords available for the
simulation of dipole magnets. It presents the interest of easy handling, and is well adapted to 
the simulation of regular dipoles such as sector magnets with wedge 
angles. 

\noindent The first input data are the magnet length $ XL $ and the
field $ B_o $, such that   in absence of fringe field the deviation $\theta$ verifies
$ XL = 2 \frac{\text{\textsl{BORO}}}{B_o} \sin({\theta}{2})$ (\textsl{BORO}  = reference rigidity, 
defined in \textsl{OBJET\index{OBJET}}). 

\noindent Then follows the description of the entrance and exit EFB's and
fringe fields. The model is the same as for \textsl{DIPOLE\index{DIPOLE}}.   
The wedge angles $W_E $ 
(entrance) and $W_S $ (exit) are defined with respect to the sector magnet, 
with the signs described in Fig.~\ref{fig14}.  
Within a distance $ \pm X_E(\pm X_S) $ on both sides of the entrance (exit) EFB, 
the fringe field model is used; 
elsewhere, the field is supposed to be uniform. 

\noindent If $\lambda_{E} $ (resp. $\lambda_{S} $) is zero sharp edge field model is assumed at entrance (resp. exit) of the magnet and $X_E$ (resp. $X_S$) is set to zero.  In this case, the wedge angle vertical first order focusing effect (if $\vec  B1$ is non zero) is simulated at magnet entrance and exit by a kick $P_2 = P_1 - Z_1 \tan (\epsilon / \rho)$ applied to each particle ($P_1$, $P_2$ are the vertical angles upstream and downstream the EFB, $Z_1$ the vertical particle position at the EFB, $\rho$ the local horizontal bending radius and $\epsilon$ the wedge angle experienced by the particle ; $\epsilon$ depends on the horizontal angle T).


\noindent Magnet (mis-)alignement is assured by \textsl{KPOS}, with special features allowing some degrees of automatism useful for periodic structures (section~\ref{sec4.6.2}).

%\vfill
%%%%%%%%%%%%%%%figure%%%%%%%%%%%%%%
\begin{figure}[H]
  %\vspace{12 truecm}
  %%%Figure 14
  \centerline{\includegraphics[height=12cm,angle=-90]{Fig14.ps}}
  {\setlength{\captionwidth}{8cm}
	\hangcaption[Fig14]{\label{fig14}Geometry and parameters in \textsl{BEND}. XL~=~length, $ B_o$~=~field, $ \theta$~=~deviation. The particular case of parallel face bend is illustrated here, obtained by setting $T_E = T_S = \theta/2$.}
   }
\end{figure}
\vfill
\newpage


\subsubsection*{BREVOL: 1-D Uniform Mesh Magnetic Field Map} \label{BREVOL}\index{BREVOL}

\textsl{BREVOL}  reads a 1-D axial field map from a storage data file,
whose content must fit the following \FORTRAN reading sequence   
\bigskip


{\footnotesize
\begin{verbatim}
	      OPEN (UNIT = NL, FILE = FNAME, STATUS = `OLD' [,FORM='UNFORMATTED'])
	      DO 1 I = 1, IX
	        IF (BINARY) THEN 
	              READ(NL) X(I), BX(I)
	        ELSE
	              READ(NL,*) X(I), BX(I)
	        ENDIF
	1     CONTINUE
\end{verbatim}}
\medskip

\noindent where $IX$ is the number of nodes along the (symmetry) $X$-axis, $X(I)$
their coordinates, and $BX(I)$ the values of the $X$ component of the field. $BX$ is 
normalized with \textsl{BNORM} prior to ray-tracing. For binary files, \textsl{FNAME}
must begin with \mbox{`B\_ '}, `BINARY' will then be set to `.TRUE.'. 
\bigskip

\noindent $X$-cylindrical symmetry is assumed, resulting in $BY$ and $BZ$ taken to 
be zero on axis. $ \vec {B} {(X,Y,Z)} $ and its derivatives along a
particle trajectory are calculated by means of a 5-point polynomial fit followed by second 
order off-axis Taylor series extrapolation (see sections~\ref{sec2.3.1}, \ref{sec2.4.1}).  
\bigskip

\noindent Entrance and/or exit integration boundaries may be defined in the same way 
as in \textsl{CARTEMES\index{CARTEMES}} by means of the flag $ID$ and coefficients
$A$, $B$, $C$, etc. 

\newpage

\subsubsection*{CARTEMES: 2-D Cartesian Mesh Magnetic Field Map With 
Mid-Plane Symmetry}\label{CARTEMES} 

\textsl{CARTEMES} \index{CARTEMES} was originally dedicated to the reading 
and processing of
the measured median plane field maps of the QDD spectrometer  SPES2 at Saclay.  However, it can be
used for the reading of any other 2-D median plane maps, provided that the format of the
field data storage file fits the following \FORTRAN sequence 


{\footnotesize
\begin{verbatim}
	      OPEN (UNIT = NL, FILE = FNAME, STATUS = `OLD' [,FORM='UNFORMATTED'])
              IF (BINARY) THEN 
                READ(NL) (Y(J), J=1, JY)
              ELSE
                READ(NL,FMT='(10F8.2)') (Y(J), J=1, JY)
              ENDIF
              DO 1 I=1, IX
	        IF (BINARY) THEN 
	          READ(NL) X(I), (BMES(I,J), J=1, JY)
	        ELSE
	          READ(NL,FMT='(10F8.1)') X(I), (BMES(I,J), J=1, JY) 
                ENDIF
        1     CONTINUE
\end{verbatim}}

\noindent where, $IX$  and $JY$  are the number of longitudinal
and transverse nodes of the uniform mesh, and $X(I)$, $Y(J)$ their coordinates.  
\textsl{FNAME} 
 is the file containing the field data. For binary files, \textsl{FNAME} must begin with
\mbox{`B\_ '}, `BINARY' will then be set to `.TRUE.'.  
\bigskip

\noindent The measured field \textsl{BMES} is normalized with \textsl{BNORM},

$$ B(I,J) = \text{\textsl{BMES}}(I,J) \times  \text{\textsl{BNORM}} $$

\noindent The vector field, $ \vec  B $, and its derivatives out of the median
plane are calculated by means of a second or fourth order polynomial 
interpolation, depending on 
the value of the parameter \textsl{IORDRE\index{IORDRE}} (\textsl{IORDRE} = 2, 25 or 4, 
see section~\ref{sec2.4.2}). 
\bigskip

\noindent Entrance and/or exit integration boundaries can be defined with 
the flag $ID$, as follows (Fig.~\ref{fig15}).
\bigskip

\noindent \textbf{If  $\mathbf{ID = 1}$:} the integration in the field 
is stopped on a boundary with equation $A'X + B'Y + C'=0 $, and 
then the trajectories are extrapolated linearly onto the exit end of the 
map.
\medskip

\noindent \textbf{If  $\mathbf{ID = -1}$:} an entrance boundary is 
defined, with equation $A'X + B'Y + C'=0 $, up to which  trajectories are 
first extrapolated linearly from the map entrance end, prior to being 
integrated in the field.
\medskip

\noindent \textbf{If  $\mathbf{ID \geq 2}$:} one entrance boundary, and 
$ID-1$~exit boundaries are defined, as above. The integration in the 
field stops on the last ($ID - 1$) exit boundary. No extrapolation onto 
the map exit end is performed in this case.

\newpage

%%%%%%%%%%%%%%figure%%%%%%%%%%%%%%
\begin{figure}[H]
%\vspace{19 truecm}
%%%Figure 15
\centerline{\includegraphics[height=15cm,angle=-90]{Fig15.ps}}
\caption[Fig15]{\label{fig15}$OXY $ is the coordinate system of the mesh.
Integration boundaries may be defined, using $ ID\not= 0 $: particle coordinates are
extrapolated linearly from the entrance face of the map, onto the boundary 
$A'X+B'Y+C'=0$; after ray-tracing inside the 
map and stopping on the boundary $AX+BY+C=0$, coordinates are
extrapolated linearly onto the exit face of the map if $ID=2$, or 
stopped on the last ($ID-1$) boundary if $ID >2$.}
\end{figure}
\vfill
\newpage

\subsubsection*{CAVITE: Accelerating Cavity}  \label{CAVITE}\index{CAVITE}
\index{acceleration}\index{synchrotron motion}

\textsl{CAVITE}  provides an analytical simulation of a (zero length)
accelerating cavity; it can be used in conjunction with  keywords \REBELOTE\index{REBELOTE} 
and \textsl{SCALING} for 
the simulation of multiturn tracking with synchrotron acceleration (see section~\ref{sec4.6.4}). 
It must be preceded by \textsl{PARTICUL} for the definition 
of mass $ M $ and charge $ q$.   
\bigskip

\noindent\textbf{If $\mathbf{IOPT  =  0}$:}   \textsl{CAVITE} is switched off.  
\bigskip

\noindent\textbf{If $\mathbf{IOPT  =  1}$:}  \textsl{CAVITE} simulates the R.F.~cavity of a 
synchrotron 
accelerator. Normally the keyword \textsl{CAVITE} appears \textbf{at the end} of the optical 
structure (the periodic motion over $IT  = 1$, \textsl{NPASS} + 1 \index{NPASS}
turns is simulated by means of the keyword \textsl{REBELOTE\index{REBELOTE}}, option 
\mbox{K  =  99} and the R.F.\ and magnetic fields timings by means of
\textsl{SCALING} --- see section~\ref{sec4.6.4}). The synchrotron motion of any of the 
\IMAX\index{IMAX} particles of a beam is obtained by solving the following mapping 

$$ \left\{ 
\begin{array}{l}
	\phi_ 2-\phi_ 1= 2\pi \, f_{RF}\, 
	     \left(  \dfrac{\ell}{ \beta c} - \dfrac{\mathcal{L} }{ \beta_sc} \right) \\
	W_2-W_1 = q\hat  V\, \sin\phi_ 1  
\end{array}
\right. $$
%
 where
  
{\renewcommand{\arraystretch}{1}
 \begin{tabular}{>{$}l<{$}!{=}l}
	\phi        &  R.F. phase; $\phi_ 2-\phi_ 1=$ variation  of $\phi$ between two  traversals\\
	W           &   kinetic  energy;  $W_2-W_1=$ energy  gain  at  a traversal  of \textsl{CAVITE}\\
	\mathcal{L} & length  of  the  synchronous  closed orbit  (to  be  calculated  by  prior 
	              ray-tracing,\\
	 \multicolumn{1}{c}{  }           & see  the  bottom  NOTE) \\
	\ell        &  orbit length  of  the  particle  between  two  traversals\\
	\beta_ sc   &  velocity  of  the (virtual)  synchronous  particle\\
	\beta c     &  velocity  of  the  particle \\
	\hat  V     &  peak R.F.\ voltage\\
	q           &  particle  electric  charge.   
 \end{tabular}}
\bigskip

\noindent The R.F.\ frequency $ f_{RF} $ is a multiple of the synchronous 
revolution frequency, and is obtained from the input data, following 

$$ f_{RF} = \frac{hc }{\mathcal{L}}\, \frac{q(B\rho )_s }{ (q^2(B\rho)^2_s+(Mc)^2)^{1/2}} $$
%
 where
  
 \begin{tabular}{l!{=}l}
   $h$ & harmonic  number  of  the  R.F\\
   $M$ &  mass  of  the  particle \\
   $c$ & velocity  of light.
  \end{tabular}
\bigskip

\noindent The current rigidity $ (B\rho )_s $ of the synchronous particle is
obtained from the timing law specified by means of \textsl{SCALING} following 
$ (B\rho)_s= \text{\textsl{BORO}}\cdot \text{\textsl{SCALE(TIMING)}} $ 
(see  \textsl{SCALING}  for the meaning and calculation of the scale 
factor \textsl{SCALE(TIMING)}). If \textsl{SCALING\index{SCALING}} is 
not used, $ (B\rho )_s $ is assumed to keep the constant value \BORO
given in the object description (see \textsl{OBJET\index{OBJET}} for instance). \

\noindent The velocity $ \beta c $ of a particle is calculated from its
current rigidity

$$ \beta  = \frac{q(B\rho ) }{ \sqrt{ q^2(B\rho )^2+(Mc)^2}} $$
%
 The velocity $ \beta_ sc $ of the synchronous particle is obtained
in the same way from

$$ \beta_ s = \frac{q(B\rho )_s }{ \sqrt{ q^2(B\rho )^2_s + (Mc)^2}} $$
%
 The kinetic energies and rigidities involved in these formulae are related by

$$ q(B\rho ) = \sqrt{ W(W+2Mc^2)} $$
%
 Finally, the initial conditions for the mapping, at the first 
turn, are the following  
\begin{itemize}
\item[-] For the (virtual) synchronous particle
%
\begin{align*}
	\phi_ 1 &  = \phi_ s = \text{synchronous phase}  \\
	(B\rho )_{1s} & = \text{\textsl{BORO}}  
\end{align*}

\item[-] For any of the $ I=1$,  \IMAX\index{IMAX}  particles of the beam 
%
\begin{align*}
	\phi_{1I} & = \phi_ s = \text{synchronous  phase} \\
	(B\rho )_{1I} & =\text{\textsl{BORO}} \ast  D_I
\end{align*}
%
where the quantities \BORO and $ D_I $ are given in the object description. 
\end{itemize}

\paragraph{Calculation of the coordinates} 

\noindent Let   $ p_I= \left[p^2_{XI}+p^2_{YI}+p^2_{ZI} \right]^{1/2} $ be the momentum of particle 
$ I $ at the exit of the cavity, while \\ %%%%% adjustment cesure peu satisfaisant !!
$ p_{I_0}= \left[p^2_{XI_0}+p^2_{YI_0} + p^2_{ZI_0}\right]^{1/2} $ is its 
momentum at the entrance. The kick in momentum is assumed to be 
fully longitudinal, resulting in the following relations between 
the coordinates at the entrance (denoted by the index zero) and at the exit 

 \begin{align*}
	 p_{XI} 
	      & = \left[p^2_I-(p^2_{I_0}-p^2_{XI_0}) \right]^{1/2} \\
	p_{YI} & = p_{YI_0},\quad \text{and} \quad  p_{ZI}= p_{ZI_0} \quad\text{(longitudinal  kick)} \\ 
	X_I &  = X_{I_0},\quad Y_I=Y_{I_0}\quad  \text{and} 
	        \quad Z_I=Z_{I_0} \quad\text{(zero  length cavity)}   
 \end{align*}
%
and for the angles (see Fig.~\ref{fig1})  
%
\begin{equation*}
	\left. 
	\begin{aligned}
		T_I & =  \text{Atg} \left( \dfrac{p_{YI}}{ p_{XI}} \right) \\
		P_I &  =  \text{Atg} \left(\dfrac{P_{ZI}}{(p^2_{XI}+p^2_{YI})^{1/2}} \right) 
	\end{aligned}
	 \right\rbrace \quad \text{(damping  of the  transverse  motion)}
\end{equation*}  
%\vfill\eject

\noindent\textbf{If $\mathbf{IOPT  =  2:}$} the same simulation of a synchrotron R.F.\ cavity, 
as for $\mathbf{IOPT  =  1}$, is performed, except that the keyword 
\textsl{SCALING\index{SCALING}} (family \textsl{CAVITE\index{CAVITE}}) is not taken into 
account in this option : the increase in kinetic energy at each traversal, 
for the synchronous particle, is

$$ \Delta W_s= q\hat  V \,\sin\phi_ s $$
%
where the synchronous phase $ \phi_ s $ is given in the input data.
From this, the calculation of the law $ (B\rho )_s $ and the R.F.\ frequency 
$f_{RF} $ follows, according to the formulae given in \mbox{\textsl{IOPT}  =  1}. 
\bigskip

\noindent\textbf{If $\mathbf{IOPT  =  3}$:} acceleration without synchrotron motion. 
Any particle will be given a kick

$$ \Delta W = q\hat  V\, \sin\phi_ s $$
%
where $ \hat  V $ and $ \phi_ s $ are input data.  
\bigskip

\noindent NOTE: Calculation of the closed orbit. \\
Due to the fringe fields, the horizontal closed orbit may not 
coincide with the ideal axis of the optical elements. One way to 
calculate it at the beginning of the structure (\emph{i.e.}\ where the 
initial particle coordinates have to be defined) is to ray-trace 
a single particle over a significantly high number of turns, 
starting with the initial condition $ (Y_0=T_0=Z_0=P_0=0)$,  and so as to 
obtain a statistically well-defined phase-space ellipse. The 
initial conditions of the closed orbit then correspond to the 
coordinates $ Y_c $ and $ T_c $ of the center of this ellipse. Next, 
ray-tracing over one turn a particle starting with the initial condition 
($Y_c $, $ T_c $, $ Z_0=P_0=0$)  will provide the length $\mathcal{L}$ 
(namely, the $ F(6,1) $ coordinate) of the closed orbit. 

\newpage

\subsubsection*{CHAMBR:  Long Transverse Aperture Limitation}\label{CHAMBR}

\textsl{CHAMBR}\index{CHAMBR} causes the identification, counting and stopping of 
particles that reach the 
transverse limits of the vacuum chamber.  The chamber can be either rectangular 
(\textsl{IFORM} = 1) or elliptic (\textsl{IFORM} = 2). The chamber is centered
at $ YC$, $ZC $ and has transverse dimensions $\pm YL $ and  
$\pm  ZL $ such that any particle will be stopped if its coordinates $ Y,Z $ verify 

\begin{align*}
	(Y-YC)^2\geq  YL^2  \text{ or }   (Z-ZC)^2 \geq  ZL^2 
	   &   \quad \text{if}\quad  \text{\textsl{IFORM}}=1  \\
	\dfrac{ (Y-YC)^2 }{ YL^2} + \dfrac{(Z-ZC)^2 }{ ZL^2} \geq 1  
	  &   \quad \text{if}\quad  \text{\textsl{IFORM}}=2  
\end{align*}

\noindent The conditions introduced with \textsl{CHAMBR\index{CHAMBR}} are valid
along  the optical structure until the next occurrence  of the keyword \textsl{CHAMBR}.  Then, if
$ IL=1 $ the aperture is possibly modified by introducing new values of $ YC$,  $ ZC$, 
 $YL $ and $ ZL $, or, if $ IL=2 $ the chamber ends and information is 
printed concerning those particles that have been stopped.  
\bigskip

\noindent The testing is done in magnets at each integration step, between the
\textsl{EFB}'s. For instance, in \textsl{QUADRUPO\index{QUADRUPO}} there will be 
no testing from $-X_E $ to 0 and 
from $ XL $ to $ XL+X_S $, but only from 0  to $ XL $;  in \textsl{DIPOLE\index{DIPOLE}}, there is no 
testing as long as the \textsl{ENTRANCE EFB} is not reached, and testing is stopped as 
soon as the \textsl{EXIT} or \textsl{LATERAL EFB}'s are passed.  
\bigskip

\noindent In polar coordinate magnets, $ Y $  stands for the radial
coordinate (e.g. with \textsl{DIPOLE\index{DIPOLE}}, see Figs.~\ref{fig3}C and~\ref{fig9}).  
 Therefore, centering \textsl{CHAMBR\index{CHAMBR}} at $ YC=RM $ simulates a chamber curved with radius 
 $ RM $, and having a radial acceptance $ RM\pm YL $.  The testing  is done in  \textsl{ESL}  
 (\textsl{DRIFT}) at the beginning and the end, and only for positive drifts.  There 
is no testing in \textsl{CHANGREF\index{CHANGREF}}.  
\bigskip

\noindent When a particle is stopped, its index \textsl{IEX\index{IEX}}  (see \textsl{OBJET\index{OBJET}} and 
section~\ref{sec4.6.6}) is set to the value -4, and its actual path length is stored in the array 
\textsl{SORT} for  eventual further statistical purposes. 

\newpage

\subsubsection*{CHANGREF: Transformation to a New Reference Frame} \label{CHANGREF}\index{CHANGREF}

\CHANGREF transports the particles to a new reference frame.  It can be used anywhere 
in a structure.  The new coordinates of the particles  $ Y_2$,  $ T_2$,  $ Z_2$ and 
$ P_2 $ and the path length $ S_2 $ are deduced from the old ones  $ Y_1$,   
$ T_1$,  $ Z_1$,  $ P_1 $ and $ S_1 $ by


\begin{align*}
	T_2 &=  T_1- \text{\textsl{ALE}} \\
	Y_2 & = \dfrac{ (Y_1-YCE) \cos T_1+XCE \sin T_1}{\cos  T_2} \\
	DL^2 & =(XCE-Y_2 \sin \text{\textsl{ALE}})^2 
	         +(YCE-Y_1+Y_2 \cos \text{\textsl{ALE}})^2 \\
	Z_2  & = Z_1+DL\mathrm{tg} P_1 \\ 
	S_2 & = S_1+ \dfrac{DL }{ \cos P_1} \\
	P_2 & = P_1  
\end{align*}
%
 where, $ XCE $ and $ YCE $ are shifts in the horizontal plane along,respectively, 
$ X$- and $ Y$-axis, and \textsl{ALE}  is a rotation around the $ Z$-axis. $ DL $
is given the sign of $ XCE-Y_2 \sin(\text{\textsl{ALE}})$.  This keyword may for instance be used
for positioning optical elements, or for setting a reference frame at the entrance
or exit of field maps. \\
Effects of \CHANGREF on spin tracking, 
particle decay and gas-scattering are taken into account (but not on synchrotron radiation).
\vfill
%%%%%%%%%%%%%%figure%%%%%%%%%%%%%%
\begin{figure}[H]
%\vspace{10.5 truecm}
%%%Figure 16
\centerline{\includegraphics[height=15cm,angle=-90]{Fig16.ps}}
\caption{\label{fig16}Scheme of the \CHANGREF procedure. }
\end{figure}
\vfill

\newpage

\subsubsection*{CIBLE or TARGET: Generate a Secondary Beam From Target Interaction} 
\label{CIBLE}\label{TARGET}
\index{CIBLE} \index{TARGET}

 The reaction is $ 1+2 \longrightarrow  3+4 $ with the following parameters 
$$
\begin{array}{lllll}
	\text{Laboratory momentum} & p_1\equiv  0 &  p_2 &   p_3 &    p_4 \\
	\text{Rest mass}           &   M_1        &   M_2 & M_3 &    M_4 \\ 
	\text{Total energy in laboratory} & M_1c^2 &  W_2 &    W_3 &   W_4 
\end{array}
$$
%
 The geometry of the interaction is shown in Fig.~\ref{fig17}.   
\medskip

\noindent The angular  sampling at the exit of the target consists of the $ NT$ 
coordinates 0,  $ \pm TS$,  $ \pm 2\ast TS$...   $\pm (NT-1)\ast TS/2 $ 
in the median plane, 
and the $ NP $ coordinates 0, $ \pm PS$,  $ \pm 2\ast PS$... $ \pm (NP-1)\ast PS/2$ 
in the vertical plane.  
\medskip

\noindent The position of $ B $ downstream is deduced from that of $ A $
upstream  by a transformation equivalent to two transformations using \textsl{CHANGREF\index{CHANGREF}},
 namely
 \begin{gather*}
	 \text{\textsl{CHANGREF}}(XCE=YCE=0,\quad  ALE=\beta )  \\
\intertext{followed by} 
	 \text{\textsl{CHANGREF}}(XCE=YCE=0,\quad ALE=\theta -\beta ). 
 \end{gather*}

 
\noindent Particle  4 is abandoned, while particle 3 continues. The energy
loss $ Q $ is related to the variable mass $ M_4 $ by
$$ Q=M_1+M_2-(M_3+M_4)\qquad \text{and} \qquad dQ=-dM_4 $$

\noindent The momentum sampling of particle 3 is derived from conservation of
energy and 
momentum, according to 

\begin{align*}
	M_1c^2+W_2 & =  W_3+W_4  \\
	p^2_4 & =  p^2_2 +p^2_3 -2p_2p_3 \cos (\theta -T) 
\end{align*}


%%%%%%%%%%%%%%figure%%%%%%%%%%%%%%
\begin{figure}[H]
%\vspace{17 truecm}
%%%Figure 17
\centerline{\includegraphics[height=15cm,angle=-90]{Fig17.ps}}
{\setlength{\captionwidth}{14cm}
\hangcaption[Fig17]{\label{fig17}Scheme of the principles of \textsl{CIBLE (TARGET)}\\
 $ A, T$   =   position, angle of incoming particle 2 in the entrance reference frame\\
 $P$   =   position of the interaction\\
 $B, T$   =   position, angle of the secondary particle  in the exit reference frame\\ 
 $\theta$   =   angle between entrance and exit frames\\
 $\beta$   =   tilt angle of the target}     }
\end{figure}
\vfill

\newpage

\subsubsection*{COLLIMA: Collimator}\label{COLLIMA}\index{COLLIMA}

\textsl{COLLIMA}  acts as a mathematical aperture of zero length.  It causes 
the identification, counting and stopping of particles that reach the transverse limits 
of the aperture, which can be either rectangular (\textsl{IFORM} = 1) or elliptic 
(\textsl{IFORM} = 2).  The collimator is centered at $ YC$, $ZC $ and has transverse
dimensions $\pm YL $ and $\pm ZL $ such that any particle will be
stopped if its coordinates $Y$, $Z $ verify

\begin{align*}
	(Y-YC)^2\geq  YL^2  \text{ or }   (Z-ZC)^2 \geq  ZL^2 
	   &   \quad \text{if}\quad  \text{\textsl{IFORM}}=1  \\
	\dfrac{ (Y-YC)^2 }{ YL^2} + \dfrac{(Z-ZC)^2 }{ ZL^2} \geq 1  
	  &   \quad \text{if}\quad  \text{\textsl{IFORM}}=2  
\end{align*}

\noindent When a particle is stopped, its index \textsl{IEX\index{IEX}} (see \textsl{OBJET}
and section~\ref{sec4.6.6}) is set to the value -4, and its actual path length is stored in 
the array \textsl{SORT}  for eventual further statistical purposes (e.g.~with 
\textsl{HISTO\index{HISTO}}). 
\newpage

\subsubsection*{DECAPOLE:  Decapole Magnet  (Fig.~\protect\ref{fig18})} \label{DECAPOLE}  

The meaning of parameters for \textsl{DECAPOLE}\index{DECAPOLE}
 is the same as for \textsl{QUADRUPO\index{QUADRUPO}}.  
%\bigskip

\noindent In fringe field regions the magnetic field $ \vec  B(X,Y,Z) $ and
its derivatives up to fourth order are derived from the scalar potential approximated to 
the 5th order in $ Y $ and $ Z $ 

\begin{align*}
	V(X,Y,Z) &   =   V(X,Y,Z) = G \left(Y^4Z-2Y^2Z^3+ \dfrac{Z^5 }{ 5}\right)  \\
	\text{with  } G_0 &   = \dfrac{ B_0 }{ R^4_0} 
\end{align*}


\noindent Outside fringe field regions, or everywhere in sharp edge decapole 
($ \lambda_ E=\lambda_ S=0$) , $ \vec  B(X,Y,Z) $ in the magnet is given by 

\begin{align*}
	B_X &   =    0 \\
	B_Y &   =   4G_0(Y^2-Z^2)YZ \\
	B_Z &   =    G_0(Y^4-6Y^2Z^2+Z^4)
\end{align*}
\vfill

%%%%%%%%%%%%%%figure%%%%%%%%%%%%%%
\begin{figure}[H]
%\vspace{12 truecm}
%%%Figure 18
\centerline{\includegraphics[width=12cm,angle=-90]{Fig18.ps}}
\caption{\label{fig18}Decapole magnet}
\end{figure}
\vfill

\newpage

\subsubsection*{DIPOLE:  Generation of a Dipole Magnet 2-D Map} \label{DIPOLE}

\noindent\textsl{DIPOLE} \index{DIPOLE} is a recent, simpler and improved version of 
\textsl{AIMANT\index{AIMANT}}.  
\bigskip

\noindent The keyword \textsl{DIPOLE} provides an automatic generation of a dipole 
field map in polar coordinates. The extent of the map is defined by the 
following parameters, as shown in Figs.~\ref{fig9}A and~\ref{fig9}B.
\bigskip

 \begin{tabular}{>{\sl}l!{:}l}
	 AT &  total angular aperture\\
	 RM & mean radius used for the positioning of field boundaries\\
	 RMIN, RMAX
	    &  minimum and maximum radii 
 \end{tabular}
\bigskip
 
\noindent The 2 or 3 effective field boundaries (EFB) inside the map are
defined from geometric boundaries, the shape and position of which are determined by the 
following parameters. 
\bigskip

\begin{tabular}{l!{:}l}
	 \textsl{ACENT} 
	    & arbitrary inner angle, used for EFB's positioning  \\
	$\omega$ &  azimuth of an EFB with respect to  \textsl{ACENT}\\
	$\theta$ & angle of an EFB with respect to its azimuth (wedge angle)\\ 
	$R_1$, $R_2$  &  radius of curvature of an EFB\\
	$U_1$, $U_2$  &  extent of the linear part of an EFB. 
\end{tabular}
\bigskip


\noindent At  any node  of the map mesh, the value of the field is calculated as 
 \begin{equation}
	 B =  \mathcal{F} \ast  B_0 \ast  
	      \left(1+N \ast  
	           \left( \frac{R-RM }{ RM}\right) 
	           + B \ast  \left(\frac{R-RM }{ RM} \right)^2 
	           + G \ast  \left(\frac{R-RM }{ RM} \right)^3 
	      \right) 
 	\label{eq3-3-1}
 \end{equation}
%
 where  $ N$, $B $ and $ G $ are  respectively  the first, second and
third order field indices and $ \mathcal{F}$ is the fringe field coefficient, while the 
$X$ and $Y$ components of the field are 
assumed to be zero on the  mesh plane. 

\paragraph{Calculation of the Fringe Field Coefficient} 

\noindent With  each EFB a realistic extent of the fringe field, $\lambda$ 
(normally equal to the gap size), is associated and a fringe field coefficient
$ F $ is calculated. In the following $\lambda$ stands for either $ \lambda_ E $
(Entrance), $ \lambda_ S $ (Exit) or $ \lambda_ L $ (Lateral EFB).  
\bigskip

\noindent$ F $ is an exponential type fringe field (Fig.~\ref{fig11}) 
given by \cite{Biblio12}     %%% [12]

$$ F = \frac{1 }{ 1+ \exp P(s)} $$
%
 where $ s $ is the distance to the EFB, and 

$$
    P(s) = C_0
       +C_1 \left(  \dfrac{s }{ \lambda} \right) 
       +C_2 \left( \dfrac{s }{ \lambda} \right)^2 
       + C_3 \left( \dfrac{s }{ \lambda} \right)^3 
       +C_4 \left( \dfrac{s }{ \lambda} \right)^4 
       + C_5 \left(\dfrac{s }{ \lambda} \right)^5 $$
       
\noindent It is also possible to simulate a shift of the \textsl{EFB}, by giving a non
zero value to the parameter \textsl{SHIFT}.  $ s $ is then changed to $ s -$\textsl{SHIFT} in the 
previous equation.   This allows small variations of the total magnetic length.  
\bigskip

\noindent Let $ F_E $ (respectively $ F_S$, $F_L$)  be the fringe field
coefficient attached to the entrance (respectively exit, lateral) EFB. At any node of the map 
mesh, the resulting value of the fringe field coefficient (eq.~\ref{eq3-3-1}) is

$$  \mathcal{F} = F_E  \ast  F_S \ast   F_L $$
%
($F_L=1 $ if no lateral EFB is requested). 

\paragraph{The Mesh of the Field Map} 

\noindent The magnetic field is calculated at the nodes of a mesh with polar
coordinates, in the median plane.  The radial step is given by 

 \begin{align*}
	 \delta R & = \dfrac{\text{\textsl{RMAX}} - \text{\textsl{RMIN}} }{\text{\textsl{IRMAX}}-1} \\
	\intertext{and the angular step by} 
	 \delta \theta  & = \dfrac{AT }{\text{\textsl{IAMAX}}-1} 
 \end{align*}
 %
\noindent where, \RMIN  and \RMAX   are the lower and upper
radial limits of the field map, and $ AT $ is its total angular aperture (Fig.~\ref{fig9}B).  
 \textsl{IRMAX}  and \textsl{IAMAX} are 
the total number of nodes in the radial and angular directions. 

\paragraph{Simulating Field Defects and Shims }

\noindent Once the initial map is calculated, it is possible to modify it by
means of the parameter \textsl{NBS}, so as to simulate field defects or shims. 
\bigskip

\noindent\textbf{If $\mathbf{NBS = - 2}$,} the map is globally modified by a
perturbation proportional to $ R-R_0 $, 
where $ R_0 $ is an arbitrary radius, with an amplitude $ \Delta B_Z/B_0 $, so
that $ B_Z $ at the nodes of the mesh is replaced by 

$$ B_Z  \ast   \left(1+ \frac{\Delta B_Z }{ B_0}\, \frac{R-R_0 }{\text{\RMAX- \RMIN}} \right) $$

\noindent\textbf{If  $\mathbf{NBS =  - 1}$,} the perturbation is proportional to
$ \theta -\theta_ 0 $, and $ B_Z $ is replaced by 

$$ B_Z \ast  \left(1+ \frac{\Delta B_Z }{ B_0} \, \frac{\theta -\theta_ 0 }{ AT}\right) $$

\noindent\textbf{If  $\mathbf{NBS \geq 1}$,} then \textsl{NBS} shims are introduced at
positions $ \dfrac{ R_1+R_2 }{ 2}$, $\dfrac{\theta_ 1+\theta_ 2 }{ 2} $ 
(Fig.~\ref{fig13}) \cite{Biblio13}   %%%   [13] 

\noindent The initial field map is modified by shims with second order profiles given by 

$$ \theta  = \left(\gamma  + \frac{\alpha }{ \mu} \right) \,\beta\, \frac{X^2 }{\rho^ 2} $$
%
 where $ X $ is shown in  Fig.~\ref{fig11}, 
 $\rho = \dfrac{R_1+R_2 }{ 2} $ is the central radius, $\alpha$ and $\gamma$ are the angular 
 limits of the shim, $\beta$ and $\mu$ are parameters. 
 
\noindent At each shim, the value of $ B_Z $ at any node of the initial map is replaced by 

$$ B_Z \ast  \left(1+F\theta  \ast  FR \ast  \frac{\Delta B_Z }{ B_0} \right)
$$
%
 where $ F\theta =0 $ or $ FR=0 $ outside the shim, and $ F\theta =1$ and $ FR=1 $ inside.  
\bigskip

\paragraph{Extrapolation Off Median Plane} 

\noindent The vector field $ \vec  B $ and its derivatives in the median plane
are calculated by means of a second or fourth order polynomial 
interpolation, depending 
on the value of the parameter \textsl{IORDRE\index{IORDRE}} (\textsl{IORDRE}=2, 25 or 4, see 
section~\ref{sec2.4.2}). 
The transformation from polar to Cartesian coordinates is 
performed following eqs (\ref{eq2-4-8} or \ref{eq2-4-9}). Extrapolation off median plane is then 
performed by means of Taylor expansions, following the procedure described 
in section~\ref{sec2.3.2}. 

\newpage

\subsubsection*{DODECAPO:  Dodecapole Magnet  (Fig.\protect~\ref{fig19})} \label{DODECAPO}  


 The meaning of parameters for \textsl{DODECAPO}\index{DODECAPO}
  is the same as for \textsl{QUADRUPO\index{QUADRUPO}}. 
%\bigskip

\noindent In fringe field regions the magnetic field $ \vec  B(X,Y,Z) $ and
its derivatives up to fourth order are derived from the scalar potential approximated to 
the 6th order in $ Y $ and $ Z $ 

\begin{align*}
	V(X,Y,Z) &   =   V(X,Y,Z) = G \left(Y^4- \dfrac{10 }{ 3} Y^2Z^2+Z^4 \right) YZ  \\
	\text{with } G_0 &   =  \dfrac{ B_0 }{ R^5_0} 
\end{align*}

\noindent Outside fringe field regions, or everywhere in sharp edge dodecapole
($ \lambda_ E=\lambda_ S=0$) , $ \vec  B(X,Y,Z) $ in the magnet is given by 

\begin{align*}
	B_X &   =   0 \\
	B_Y &   =    G_0(5Y^4-10Y^2Z^2+Z^4)Z \\
	B_Z &   = G_0(Y^4-10Y^2Z^2+5Z^4)Y  
\end{align*}
\vfill

%%%%%%%%%%%%%%figure%%%%%%%%%%%%%%
\begin{figure}[H]
%\vspace{12 truecm}
%%%Figure 19
\centerline{\includegraphics[width=12cm,angle=-90]{Fig19.ps}}
\caption{\label{fig19}Dodecapole magnet}
\end{figure}
\vfill

\newpage
\subsubsection*{DRIFT or ESL: Field-Free Drift Space}\label{ESL}\label{DRIFT}

\textsl{DRIFT}\index{DRIFT}(or \textsl{ESL}\index{ESL}) allows the
introduction of a drift space with length $ XL $ with 
positive or negative sign, anywhere in a structure.  The associated equations 
of motion are (Fig.~\ref{fig23})   

\begin{align*}
	Y_2 &   =    Y_1+XL \ast \text{tg} T  \\ 
	Z_2 &   =   Z_1 + \dfrac{XL}{\cos  T}\,  \text{tg} P  \\
	SAR_2 &   =  SAR_1+ \dfrac{XL }{\cos  T  \ast \cos  P}  
\end{align*}
\vfill

%%%%%%%%%%%%%%figure%%%%%%%%%%%%%%
\begin{figure}[H]
%\vspace{15 truecm}
%%%Figure 23
\centerline{\includegraphics[width=15cm]{Fig23.ps}}
\caption{\label{fig23}Transfer of particles in a drift space.}
\end{figure}
\vfill

\newpage
\subsubsection*{EBMULT: Electromagnetic Multipole}\label{EBMULT} \index{EBMULT}

\noindent\textsl{EBMULT} simulates an electromagnetic multipole, by addition of
electric $ (\vec  E) $ and magnetic $ (\vec  B) $ multipole components (dipole to dodecapole). 
$\vec  E $ and its derivatives 
$ \dfrac{\partial^{ i+j+k} \vec  E }{ \partial X^i\partial Y^j\partial Z^k} $ are derived 
from the general expression of the multipole scalar potential (eq.~\ref{eq2-3-5}), followed by a 
$ \frac{\pi }{2n} $ rotation  ($n= $ pole order), 
as described in section~\ref{sec2.5.3} (see also \textsl{ELMULT\index{ELMULT}}). $ \vec  B $ and its
derivatives are derived from the same general potential, as described in section~\ref{sec2.3.5} 
(see also \textsl{MULTIPOL\index{MULTIPOL}}). 

\noindent The entrance and exit fringe fields of the $ \vec  E $ and $ \vec  B$ components are treated 
separately, in the same way as described under \textsl{ELMULT\index{ELMULT}} 
 and \textsl{MULTIPOL\index{MULTIPOL}},
for each one of these two fields. Wedge angle correction is applied in sharp edge field model if $ \vec  B1$ is non zero, as in \textsl{MULTIPOL}. Any of the $ \vec  E $ or $ \vec  B $ multipole field
component can be rotated independently of the others. 

\noindent Use \textsl{PARTICUL\index{PARTICUL}}  for the definition of the particle mass and charge.
\vfill

%%%%%%%%%%%%%%figure%%%%%%%%%%%%%%
\begin{figure}[H]
%\vspace{15 truecm}
%%%Figure 20
\centerline{\includegraphics[height=12cm,angle=-90]{Fig20.ps}}
\hangcaption[Fig20]{\label{fig20}An example of $ \vec  E$, $\vec  B $ multipole: 
           the achromatic quadrupole \protect\cite{Biblio14} \\  %% [14]
          (known for its allowing null second order chromatic aberration).}
\end{figure}

\newpage

\subsubsection*{EL2TUB: Two-tube electrostatic lens} \label{EL2TUB} \index{EL2TUB}

The lens is cylindrically symmetric about the $ X $-axis. 

\noindent The length and potential of the first (resp. second) electrode 
are $ X1 $ and $ V1 $ ($ X2 $ and $ V2$).   The distance between the two 
electrodes is $ D$,   and their inner radius is $ R_0 $ (Fig.~\ref{fig22}).   
$X$-axis  cylindrical symmetry is assumed. The model of electric potential 
along the axis is~\cite{Biblio16}     %% [16]

 \begin{alignat*}{2}
	 V(X) &   = \dfrac{ V_2-V_1}{2} \: \text{th}\,
	            \dfrac{\omega x }{ R_0} 
	             \left[+ \dfrac{V_1+V_2 }{ 2} \right] 
	      & \qquad \text{if }  D & =0\\
	V(X) &  =  \dfrac{ V_2-V_1 }{ 2}\: \dfrac{1}{ 2\omega D} \: \ell n\,
	           \dfrac{\text{ch}\, \omega\,    \dfrac{x+D }{ R_0} }%
	           {\text{ch} \,\omega \,\dfrac{x-D }{ R_0}}
	           \left[+ \dfrac{V_1+V_2 }{ 2} \right]
	            & \qquad \text{if }  D &  \not= 0 
 \end{alignat*}
%
($ x $ = distance from half-way between the electrodes;
$\omega$  =  1.318; th =  hyperbolic tangent; ch  =  hyperbolic cosine)
from which the field $ \vec  E(X,Y,Z) $ and its derivatives are derived following the 
procedure described in section~\ref{sec2.5.2}  (note that they don't 
depend on the constant term $ \left[\dfrac{V_1+V_2 }{ 2} \right] $ which
disappears when differentiating). 

\noindent Use \textsl{PARTICUL\index{PARTICUL}} for the definition of the particle mass and charge.
\vfill

%%%%%%%%%%%%%%figure%%%%%%%%%%%%%%
\begin{figure}[H]
%\vspace{13 truecm}
%%%Figure 22
\centerline{\includegraphics[width=14cm]{Fig22.ps}}
\caption{\label{fig22}Two-electrode cylindrical electric lens.}
\end{figure}

\vfill

\newpage

\subsubsection*{ELMULT: Electric Multipole} \label{ELMULT}\index{ELMULT}

The simulation of an electric multipolar field $ \vec  M_E $
proceeds by addition of the dipolar $ (\vec  E1) $ to dodecapolar $ (\vec  E6) $ components, and of
their derivatives up to fourth order, following

\begin{align*}
	\vec  M_E & = \vec  E1 + \vec  E2 + \vec  E3 + \vec  E4 + \vec  E5 + \vec  E6 \\
	\dfrac{ \partial\vec  M_E }{ \partial X}  
	          & =  \dfrac{ \partial\vec  E1 }{ \partial X} +
	               \dfrac{\partial\vec  E2 }{ \partial X} + 
	               \dfrac{\partial\vec  E3 }{ \partial X} +
	               \dfrac{\partial\vec  E4 }{ \partial X} + 
	               \dfrac{\partial\vec  E5 }{ \partial X} +
	               \dfrac{\partial\vec  E6 }{ \partial X}  \\
	\dfrac{ \partial^ 2M_E}{ \partial X\partial Z} 
	          &   = \dfrac{\partial^ 2\vec  E1 }{ \partial X\partial Z} +
	               \dfrac{\partial^ 2\vec  E2 }{\partial X\partial Z} + 
	               \dfrac{\partial^ 2\vec  E3 }{ \partial X\partial Z} +
	               \dfrac{\partial^ 2\vec  E4 }{ \partial X\partial Z} + 
	               \dfrac{\partial^ 2\vec  E5 }{\partial X\partial Z} + 
	               \dfrac{\partial^ 2\vec  E6 }{ \partial X\partial Z}  \\
	\text{etc.}
\end{align*}

\noindent The independent components $ \vec  E1 $ to $ \vec  E6 $ and their
derivatives up to the second order are calculated by differentiating the general multipole potential 
(\ref{eq2-3-5})

$$ V_n(X,Y,Z)=(n!)^2 
       \left( \sum^{ \infty}_{ q=0}(-1)^q
                \dfrac{G^{(2q)}(X)(Y^2+Z^2)^q }{ 4^q q!(n+q)!} \right) 
       \left( \sum^n_{m=0} \dfrac{\sin(m\dfrac{\pi }{ 2})Y^{n-m} Z^m }{ m!(n-m)!} \right) $$
%
 where $ G(X) $ is the longitudinal gradient (see \textsl{QUADRUPO\index{QUADRUPO}}) 
\textbf{but} including a $ \frac{\pi }{ 2n} $ rotation about the $ X$-axis, so
that the so defined right electric multipole of order $ n$,  and of 
strength~\cite{Biblio14, Biblio15}   %% [14, 15]

$$ K_n = \dfrac{1 }{ 2}\, \dfrac{\gamma }{ \gamma^ 2-1}\, \dfrac{\phi_ n }{ R^n_0} $$
%
$ (\phi_ n $ = potential at the electrode, $ R_0 $ = radius at pole tip, 
$\gamma$  = relativistic Lorentz factor of the particle) has the same focusing effect 
than the right magnetic multipole of order $ n $ and strength

$$ K_n= \dfrac{B_n }{ R^{n-1}_0 B\rho} $$
%
$ (B_n $ = field at pole tip, $ B\rho $ = particle rigidity, see \textsl{MULTIPOL\index{MULTIPOL}}). 

\noindent Such $ \dfrac{\pi }{ 2n} $ rotation of the multipole components is
obtained following the procedure described in section~\ref{sec2.5.3}.  
\bigskip

\noindent The entrance and exit fringe fields are treated separately.  They
are characterized by the integration zone $ X_E $ at entrance and $ X_S $ at exit,
as for \textsl{QUADRUPO\index{QUADRUPO}}, and by the extent $ \lambda_ E $ at entrance, $\lambda_ S $ 
at exit. The fringe field extents for the dipole component are $ \lambda_ E $
and $ \lambda_ S $. The fringe field for the quadrupolar (sextupolar,  
octupolar, decapolar, dodecapolar) component is given by a coefficient $ E2 $ 
 ($E3$, $E4$, $E5$, $E6$)   at entrance, and $ S2 $ ($ S3$, $S4$, $S5$, $S6$)   at exit, 
 such that the extent is $ \lambda_ E\ast E2$  
 ($\lambda_ E\ast E3$, $\lambda_ E\ast E4$, $\lambda_ E\ast E5$, $\lambda_ E\ast E6$)  at 
entrance and $ \lambda_ S\ast S2 $  ($\lambda_ S\ast S3$, $\lambda_S\ast S4$, 
$\lambda_ S\ast S5$, $\lambda_ S\ast S6$)  at exit.  
\bigskip

\noindent If $ \lambda_ E=0 $  ($\lambda_ S=0$)  the multipole lens is
considered to have a sharp edge field at entrance (exit), and then, 
$ X_E(X_S) $ is forced to zero (for the mere purpose of saving computing time).  
\bigskip

\noindent If $ E_i=0 $  ($S_i=0$) , the entrance (exit) fringe field for
multipole component $ i $ is considered as a sharp edge field.  
\bigskip

\noindent Overlapping of fringe fields inside the element is treated
separately for each component, in the way described in \textsl{QUADRUPO\index{QUADRUPO}}. 

\noindent Moreover, any multipole component $ \vec  E_i $ can be rotated
independently by an angle $ R_{X_i} $ around the longitudinal $ X$-axis, for the simulation of 
positioning defects, as well as skewed lenses. 

\noindent Use \textsl{PARTICUL\index{PARTICUL}} for the definition of the particle mass and charge. 

%\newpage

\vfill
%%%%%%%%%%%%%%figure%%%%%%%%%%%%%%
\begin{figure}[H]
%\vspace{19 truecm}
%%%Figure 21
\centerline{\includegraphics[width=14cm]{Fig21.ps}}
{\setlength{\captionwidth}{10cm}
\hangcaption[Fig21]{\label{fig21}An electric multipole combining quadrupole $ (\vec  E2)$ and  \\
octupole $ (\vec  E4) $ component \protect\cite{Biblio15}\\ %%% [15]
 $(\vec E1=\vec  E3=\vec  E5=\vec  E6=0)$. }   
}\end{figure}
\vfill

\newpage

\subsubsection*{ELREVOL: 1-D Uniform Mesh Electric Field Map}  \label{ELREVOL}\index{ELREVOL}

\textsl{ELREVOL}  reads a 1-D axial field map from a storage data file,
whose content must fit the following \FORTRAN reading sequence  


{\footnotesize
\begin{verbatim}
	      OPEN (UNIT = NL, FILE = FNAME, STATUS = `OLD' [,FORM='UNFORMATTED'])
	      DO 1 I=1, IX
	         IF (BINARY) THEN 
	            READ(NL) X(I), EX(I)
	         ELSE
	            READ(NL,*) X(I), EX(I)
	         ENDIF 
        1     CONTINUE
\end{verbatim}}%% 
\bigskip

\noindent where $IX$ is the number of nodes along the (symmetry) $X$-axis, $X(I)$ their 
coordinates, and $EX(I)$ the values of the $X$ component of the field. $EX$ is 
normalized with \textsl{ENORM} prior to ray-tracing.  
\bigskip

\noindent$X$-cylindrical symmetry is assumed, resulting in $EY$
and $EZ$ taken to be zero on axis. $ \vec  E(X,Y,Z) $ and its derivatives along a particle
trajectory are calculated by means of a 5-points polynomial fit followed by second 
order off-axis Taylor series extrapolation (see sections~\ref{sec2.5.1} and \ref{sec2.6}).  
\bigskip

\noindent Entrance and/or exit integration boundaries may be defined in the same way 
as in \textsl{CARTEMES\index{CARTEMES}} by means of the flag $ID$ and coefficients  
$A$, $B$, $C$, $A'$, $B'$, $C'$.  
\bigskip

\noindent Use \textsl{PARTICUL\index{PARTICUL}} for the definition of the particle mass and charge. 


\newpage

\subsubsection*{MAP2D: 2-D Cartesian Uniform Mesh Magnetic Field Map - no symmetry~\cite{Pavel}} \label{MAP2D} 

\textsl{MAP2D}\index{MAP2D} reads a 2-D field map that provides the three
components $ B_X$, $ B_Y $, $ B_Z $ of the magnetic field at the nodes of a 2-D Cartesian 
uniform mesh. No particular symmetry is assumed, which allows the 
treatment of any type of field (e.g.~dipole field out of median 
plane, solenoidal field). These data should be filed with a 
format that fits the following \FORTRAN reading sequence involved 
in \zgou\ 

{\footnotesize
\begin{verbatim}
	      OPEN (UNIT = NL, FILE = FNAME, STATUS = `OLD' [,FORM='UNFORMATTED'])
	       DO 1 J=1,JY 
	          DO 1 I=1,IX
	             IF (BINARY) THEN
	                READ(NL) Y(J), Z0, X(I), BY(I,J), BZ(I,J), BX(I,J)
	             ELSE
	                READ(NL,100) Y(J), Z0, X(I), BY(I,J), BZ(I,J), BX(I,J)
	100             FORMAT (1X, 6E11.2)
	             ENDIF
      1        CONTINUE
\end{verbatim}}
\medskip

\noindent where $IX$ ($JY$) is the number of longitudinal (transverse) nodes of 
the 2-D uniform mesh, $Z_0 $ is the $Z$-elevation of the map. For 
binary files, FNAME must begin with \mbox{`B\_ '}, `BINARY' will then be 
set to `.TRUE.'. The field $ \vec  B=(B_X,B_Y,B_Z )$ is next normalized with 
BNORM, prior to ray-tracing.  
\bigskip

\noindent At each step of the trajectory of a particle, the field and its 
derivatives are calculated by a polynomial interpolation followed 
by a $ Z $ extrapolation (see sections~\ref{sec2.3.3}, \ref{sec2.4.3}). Entrance and/or 
exit integration boundaries may be defined, in the same way as for \textsl{CARTEMES\index{CARTEMES}}.

\newpage
\subsubsection*{MULTIPOL:  Magnetic Multipole} \label{MULTIPOL}\index{MULTIPOL}

The simulation of a multipolar field $ \vec  M $ by \textsl{MULTIPOL} 
  proceeds by addition of the dipolar  ($\vec  B1$),  quadrupolar ($ \vec  B2 $), sextupolar
($ \vec  B3 $), octupolar ($ \vec  B4 $) decapolar  ($\vec  B5$)  and dodecapolar  ($\vec  B6$) 
components, and of their derivatives up to fourth order.  For instance,

\begin{align*}
	\vec  M &   =   \vec B1+\vec  B2+\vec  B3+\vec  B4+\vec  B5+\vec  B6  \\ 
	\dfrac{ \partial\vec M }{ \partial X} 
	        &   = \dfrac{ \partial\vec  B1}{ \partial X} + 
	        \dfrac{\partial\vec  B2 }{ \partial X} + 
	        \dfrac{\partial\vec  B3}{ \partial X} + 
	        \dfrac{\partial\vec  B4 }{ \partial X} + 
	        \dfrac{\partial\vec  B5}{ \partial X} + 
	        \dfrac{\partial\vec  B6 }{ \partial X} \\
	\dfrac{ \partial^ 2\vec  M }{ \partial X\partial Z} 
	       & = \dfrac{ \partial^ 2\vec  B1 }{ \partial X\partial Z} + 
	       \dfrac{\partial^ 2\vec  B2 }{ \partial X\partial Z} + 
	       \dfrac{\partial^ 2\vec  B3}{ \partial X\partial Z} + 
	       \dfrac{\partial^ 2\vec  B4 }{ \partial X\partial Z}+
	       \dfrac {\partial^ 2\vec  B5 }{ \partial X\partial Z} + 
	       \dfrac{\partial^ 2\vec  B6}{ \partial X\partial Z} \\
	\text{etc. }
\end{align*}


\noindent The independent components $ \vec  B1$, $\vec  B2$, $\vec  B3$, $\vec B4$, $\vec  B5 $,  
$ \vec  B6 $  and their derivatives up to the fourth order are calculated as described under 
\textsl{QUADRUPO\index{QUADRUPO}}, \textsl{SEXTUPOL\index{SEXTUPOL}}, 
\textsl{OCTUPOLE}, \textsl{DECAPOLE} and \textsl{DODECAPO\index{DODECAPO}}   keywords
(see section~\ref{sec2.3.5}).  
\bigskip

\noindent The entrance and exit fringe fields are treated separately.  They
are characterized by the integration zone $ X_E $ at entrance and $ X_S $ at exit,
as for \textsl{QUADRUPO\index{QUADRUPO}}, and by the extent $ \lambda_ E $ at entrance, 
$\lambda_ S $ at exit. The fringe field extents for the dipole component are $ \lambda_ E $
and $ \lambda_ S $. The fringe field for the 
(sextupolar,  octupolar, decapolar, dodecapolar) component is given by a coefficient $ E2 $ 
 ($E3$, $E4$, $E5$, $E6$)  at entrance, and 
$ S2 $ ($ S3$, $S4$, $S5$, $S6$)  at exit, such that the extent is $ \lambda_ E\ast E2$
 ($\lambda_ E\ast E3$, $\lambda_ E\ast E4$, $\lambda_ E\ast E5$, $\lambda_ E\ast E6$)  at 
entrance and $ \lambda_ S\ast S2 $  ($\lambda_ S\ast S3$, $\lambda_S\ast S4$, 
$\lambda_ S\ast S5$, $\lambda_ S\ast S6$)  at exit. 
\bigskip

\noindent If $ \lambda_ E=0 $  ($\lambda_ S=0$)  the multipole lens is
considered to have a sharp edge field at entrance (exit), and then, $ X_E(X_S) $ is forced to zero 
(for the mere purpose of saving computing time).  If $ E_i=0 $  ($S_i=0$), the entrance (exit) fringe field for
multipole component $ i $ is considered as a sharp edge field.  In sharp edge filed model, the wedge angle vertical first order focusing effect (if $\vec  B1$ is non zero) is simulated at magnet entrance and exit  by a kick $P_2 = P_1 - Z_1 \tan (\epsilon / \rho)$ applied to each particle ($P_1$, $P_2$ are the vertical angles upstream and downstream the EFB, $Z_1$ the vertical particle position at the EFB, $\rho$ the local horizontal bending radius and $\epsilon$ the wedge angle experienced by the particle ; $\epsilon$ depends on the horizontal angle T).

\bigskip

\noindent Overlapping of fringe fields inside the magnet is treated separately
for each component, in the way described in \textsl{QUADRUPO\index{QUADRUPO}}.  
\bigskip

\noindent Any multipole component $ \vec  B_i $ can be rotated independently
by an angle $ R_{X_i} $ around the longitudinal $ X$-axis, for the simulation of positioning defects,
as well as skewed lenses. 

\bigskip

\noindent Magnet (mis-)alignement is assured by \textsl{KPOS}, with special features allowing some degrees of automatism useful for periodic structures (section~\ref{sec4.6.2}).



\newpage

\subsubsection*{OCTUPOLE:  Octupole magnet  (Fig.~\protect\ref{fig24}) } \label{OCTUPOLE}

 The meaning of parameters for \textsl{OCTUPOLE} \index{OCTUPOLE} is the same as for 
\textsl{QUADRUPO\index{QUADRUPO}}.  In fringe field regions the magnetic field $ \vec  B(X,Y,Z)$ and 
its derivatives up to fourth order are derived from the scalar potential 
approximated to the 8-th order in $ Y $ and $ Z $

\begin{align*}
	V(X,Y,Z) &   =   \left(G-\dfrac{G^{\prime\prime} }{ 20} \, (Y^2+Z^2)+
	              \dfrac{G^{\quaprime} }{ 960}\, (Y^2+Z^2)^2 \right) (Y^3Z-YZ^3)   \\
	\text{with } G_0 &   =  \dfrac{ B_0 }{ R^3_0} 
\end{align*}

\noindent Outside fringe field regions, or everywhere in sharp edge dodecapole
($ \lambda_ E=\lambda_ S=0$) , $ \vec  B(X,Y,Z) $ in the magnet is given by 

\begin{align*}
	B_X &   =   0 \\
	B_Y &   =   G_0(3Y^2Z-Z^3)  \\
	B_Z &   = G_0(Y^3-3YZ^2)    
\end{align*}
\vfill

%%%%%%%%%%%%%%figure%%%%%%%%%%%%%%
\begin{figure}[H]
%\vspace{12 truecm}
%%%Figure 24
\centerline{\includegraphics[height=12cm,angle=-90]{Fig24.ps}}
\caption{\label{fig24}Octupole magnet}
\end{figure}
\vfill

\newpage

\subsubsection*{POISSON: Read field data from POISSON output} \label{POISSON} \index{POISSON}

This keyword allows reading a field profile $ B(X) $ from a \textsl{POISSON} output. 
Let \textsl{FNAME} be the name of this output file (normally,
\textsl{FNAME} = outpoi.lis\index{outpoi.lis}); 
the data are read following the \FORTRAN statements hereunder 

{\footnotesize
\begin{verbatim}
	 I = 0
   11    CONTINUE
	   I = I + 1
           READ(LUN,101,ERR=10,END=10) K, K, K, R, X(I), R, R, B(I) 
   101     FORMAT(I1, I3, I4, E15.6, 2F11.5, 2F12.3)
         GOTO 11     
   10    CONTINUE
         ...
\end{verbatim}}
\medskip
 
\noindent where X(I) is the longitudinal coordinate, and B(I) is the Z
component of the field at a node (I) of the mesh. K's and R's are dummy variables 
appearing in the \textsl{POISSON} output file outpoi.lis
 but not used here. 
\bigskip

\noindent From this field profile, a 2-D median plane map is built up, with a 
rectangular and uniform mesh; mid-plane symmetry is assumed. The field at 
each node $ (X_i,Y_j) $ of the map is $ B(X_i) $, independent of $ Y_j $
(\emph{i.e.}, the distribution is uniform in the $ Y $ direction).  
\bigskip

\noindent For the rest, \textsl{POISSON} works in a way similar to \textsl{CARTEMES\index{CARTEMES}}. 

\newpage
\subsubsection*{POLARMES: 2-D Polar Mesh Field Map} \label{POLARMES} \index{POLARMES}

Similar to \textsl{CARTEMES\index{CARTEMES}}, apart from the polar 
mesh frame: $IX$ is the number of angular nodes, $JY$ the number of 
radial nodes; $X(I)$ and $Y(J)$ are respectively the angle and radius 
of a node (these parameters are similar to those entering in the 
definition of the map in \textsl{DIPOLE}\index{DIPOLE}).

\newpage

\subsubsection*{PS170: Simulation of a Round Shape Dipole Magnet} \label{PS170} \index{PS170}

\textsl{PS170} is dedicated to a `rough' simulation
of CERN's \textsl{PS170} dipole.  
\bigskip

\noindent The field $ B_0 $ is constant inside the magnet, and zero outside. 
The pole is a circle  of radius $ R_0 $, centered on $ X $ axis.  The output coordinates are
generated at the distance \textsl{XL} from the entrance (Fig.~25).  %%%
\vfill

%%%%%%%%%%%%%%figure%%%%%%%%%%%%%%
\begin{figure}[H]
%\vspace{17 truecm}
%%%Figure 25
\centerline{\includegraphics[height=15cm,angle=-90]{Fig25.ps}}
\caption{\label{fig25}Scheme of the PS170 magnet simulation.}
\end{figure}
\vfill

\newpage

\subsubsection*{QUADISEX, SEXQUAD: Sharp Edge Magnetic Multipoles} \label{QUADISEX}\label{SEXQUAD}
\index{QUADISEX} \index{SEXQUAD}

\textsl{SEXQUAD}    defines in a simple way a sharp edge field with quadrupolar, 
sextupolar and octupolar components. \textsl{QUADISEX}  adds a dipole component. The length of 
the element is $ XL $.  The vertical component $ B \equiv B_Z(X,Y,Z=0) $ of the field and its derivatives in median plane are 
calculated at each step from the following expressions 

\begin{align*}
	B &   =     B_0
	           \left(U+ \dfrac{N }{ R_0}Y + 
	                \dfrac{B }{ R^2_0} Y^2+ \dfrac{G }{ R^3_0} Y^3 \right)  \\
	\dfrac{ \partial B }{ \partial Y} 
	   &   =   B_0 \left(
	             \dfrac{N }{ R_0} + 2 \dfrac{B }{ R^2_0} Y + 3\dfrac{G }{ R^3_0}Y^2 \right) \\  
	\dfrac{ \partial^ 2B }{ \partial Y^2} 
	  &  =     B_0 \left(2 \dfrac{B }{ R^2_0} + 6\dfrac{G }{ R^3_0} Y \right) \\
	\dfrac{ \partial^ 3B }{ \partial Y^3}  
	   & =     6B_0 \,  \dfrac{G }{ R^3_0}
\end{align*}  
   %
    and then extrapolated out of the median plane by Taylor expansion in $ Z $ 
(see section~\ref{sec2.3.2}).
\bigskip

\noindent With option \textsl{SEXQUAD}, $ U=0$,  while with \textsl{QUADISEX}, $U=1 $. 

\newpage

\subsubsection*{QUADRUPO:  Quadrupole Magnet  (Fig.~\protect\ref{fig26}) } \label{QUADRUPO}  
\index{QUADRUPO}

The length of the magnet $ XL $ is the distance between the
effective field boundaries (EFB). The field at the pole tip $ R_0 $ is $ B_0 $. 

\noindent The extent of the  entrance (exit) fringe field is characterized by 
$ \lambda_ E(\lambda_ S) $.  The distance of ray-tracing on both sides of the
EFB's, in the field fall off regions, will be $\pm$  $ X_E $ at 
the entrance, and $\pm$  $ X_S $ at the exit (Fig.~\ref{fig27}),  
by prior and further automatic 
changes of frame. 

\noindent In the fringe field  regions $[ -X_E,X_E ]$  and 
$[ -X_S,X_S ]$ on both sides of the EFB's, $ \vec  B(X,Y,Z) $ and its derivatives up to
fourth order are calculated at each step of the trajectory from the analytical expressions 
of the three components $ B_X $, $ B_Y $, $ B_Z $ obtained by differentiation
of the scalar potential (see section~\ref{sec2.3.5}) approximated to the 8th order in $ Y $ 
and $ Z $. 

 \begin{gather*}
 	V(X,Y,Z)     =   \left(G- \dfrac{G^{\prime\prime} }{ 12}\, (Y^2+Z^2)+
	             \dfrac{G^{\quaprime} }{ 384}\, (Y^2+Z^2)^2-
	             \dfrac{G^{\cinqprime\prime} }{ 23040}\, (Y^2+Z^2)^3 \right)YZ  \\
	(G^\prime     =    dG/dX,\quad G^{\prime\prime} =d^2G/dX^2,...) \\
\intertext{where $ G $ is the gradient on axis \protect\cite{Biblio12}:  } %% [12]
    G(s) = \dfrac{G_0 }{ 1+ \exp  P(s)}\qquad \text{with} \quad G_0=\dfrac{B_0}{R_0} \\
\intertext{and,}
     P(s) = C_0
       +C_1 \left(  \dfrac{s }{ \lambda} \right) 
       +C_2 \left( \dfrac{s }{ \lambda} \right)^2 
       + C_3 \left( \dfrac{s }{ \lambda} \right)^3 
       +C_4 \left( \dfrac{s }{ \lambda} \right)^4 
       + C_5 \left(\dfrac{s }{ \lambda} \right)^5
       P(s)=C_0+C_1 \left(\dfrac{s }{ \lambda} \right) + C_2 \left(\dfrac{s }{ \lambda}\right)
\end{gather*}
%
 where, $ s $ is the distance to the field boundary and $\lambda$
stands for $ \lambda_ E $ or $ \lambda_ S $ 
(normally, $ \lambda  \simeq  2  \ast  R_0$). 

\noindent When fringe fields overlap inside the magnet $ (XL\leq X_E+X_S)$,  
the gradient $ G $ is expressed as 

$$ G = G_E+G_S-1 $$
%
where, $ G_E $ is the entrance gradient and $ G_S $ is the exit gradient. 

\noindent If $ \lambda_ E=0$ ($\lambda_ S=0$),  the field at entrance 
(exit) is considered as sharp edged, and then $ X_E(X_S) $ is forced to zero 
(for the mere purpose of saving computing time). 

\noindent Outside of the fringe field regions (or everywhere when 
$ \lambda_E=\lambda_ S=0$)   $ \vec  B(X,Y,Z) $ in the magnet is given by 

\begin{align*}
	B_X &   =     0 \\
	B_Y &   =    G_0Z \\
	B_Z &   =     G_0Y  
\end{align*}

\newpage

%%%%%%%%%%%%%%figure%%%%%%%%%%%%%%
\begin{figure}[H]
%\vspace{9 truecm}
%%%Figure 26
\centerline{\includegraphics[height=10cm,angle=-90]{Fig26.ps}}
\caption{\label{fig26}Quadrupole magnet}
\end{figure}
\vfill
%%%%%%%%%%%%%%figure%%%%%%%%%%%%%%
\begin{figure}[H]
%\vspace{11 truecm}
%%%Figure 27
\centerline{\includegraphics[height=10cm,angle=-90]{Fig27.ps}}
\hangcaption[Fig27]{\label{fig27}Scheme of the longitudinal field gradient $ G(X) $.\\
$ (OX) $ is the longitudinal axis of the reference frame $ (0,X,Y,Z) $ of \zgou.
The length of the element is $ XL $, but trajectories 
are ray-traced from $ -X_E $ to $ XL+X_S $, by means of prior and further
automatic changes of frame.}
\end{figure}

\newpage

\subsubsection*{SEPARA: Wien filter - analytic simulation}\label{SEPARA} \index{SEPARA}

\textsl{SEPARA}  provides an analytic simulation of an electrostatic separator. 
Input data are the length $ L $ of the element, the electric field $ E $ and
the magnetic field $ B $. The mass $ m $ and charge $ q $ of the particles are
entered by means of the keyword \textsl{PARTICUL\index{PARTICUL}}.  
\medskip

\noindent The subroutines involved in this simulation solve the following
system of three equations with three unknown variables $ S$, $Y$, $Z $ (while  $ X\equiv L $), that 
describe the cycloidal motion of a particle in $ \vec  E$,  $ \vec  B $ static
fields (Fig.~\ref{fig28}).   

\begin{align*}
	X &   =   -R  \cos \left( \dfrac{\omega S }{ \beta c} + \epsilon \right) 
	         -  \dfrac{\alpha S }{ \omega\beta c} + \dfrac{C_1 }{ \omega} \\
	Y &   =     R \sin  \left(\dfrac{\omega S }{ \beta c} + \epsilon \right) - 
	         \dfrac{\alpha }{ \omega^ 2} - \dfrac{C_2 }{ \omega}  + Y_0  \\
	Z &   =  S \sin (P_0)+Z_0   
\end{align*}
%
 where, $ S $ is the path length in the separator, $\alpha =-\dfrac{Ec^2 }{ \gamma}$ ,
   $   \omega =-\dfrac{Bc^2 }{m\gamma}$, $   C_1=\beta \sin (T_0) \cos (P_0) $ 
and $ C_2=\beta c  \cos (T_0) $ $ \cos (P_0) $ are initial conditions. 
$c$ = velocity of light, $ \beta c$ = velocity of the particle,  
$ \gamma =(1-\beta^ 2)^{-\frac{1 }{ 2}} $ 
and  $\tan \epsilon  =   (C_2+ \frac{\alpha}{\omega})/C_1 $.   $ Y_0$,   $ T_0$,  
$Z_0$,  $ P_0 $ are the initial 
coordinates of the particle in the \zgou\ reference  frame.  Here 
$\beta c $ and $\gamma$ are assumed constant, which is true as long as the change of momentum
due to the electric field remains negligible all along the separator.  
\medskip

\noindent The index $IA$ in the input data allows switching to inactive
element (thus equivalent to \textsl{ESL}), horizontal or vertical separator.  
Normally, $ E$,  $B $ and the value of $ \beta_W $ for wanted particles are related by 

$$ B(T) = - \dfrac{E\left(\dfrac{V }{ m}\right) }{ \beta_ W\cdot c\left(\dfrac{m }{ s}\right)} $$

 %\newpage
\vfill

%%%%%%%%%%%%%%figure%%%%%%%%%%%%%%
\begin{figure}[H]
%\vspace{20 truecm}
%%%Figure 28
\centerline{\includegraphics[height=15cm,angle=-90]{Fig28.ps}}
{\setlength{\captionwidth}{14cm}
\hangcaption[Fig28]{\label{fig28}Horizontal separation between a wanted particle, $ (W)$,  
and an unwanted particle, $ (U) $.  
$ (W) $ undergoes a linear motion while $ (U) $ undergoes a 
cycloidal motion.} }
\end{figure}
\vfill

\newpage

\subsubsection*{SEXTUPOL:  Sextupole Magnet (Fig.~\protect\ref{fig29})} 
     \label{SEXTUPOL} \index{SEXTUPOL}  

The meaning of parameters for \textsl{SEXTUPOL} is the same as 
for \textsl{QUADRUPO\index{QUADRUPO}}.  
\medskip

\noindent In fringe field regions the magnetic field $ \vec  B(X,Y,Z) $ and
its derivatives up to fourth order are derived from the scalar potential approximated to 
7th order in $ Y $ and $ Z $

 \begin{align*}
 	V(X,Y,Z)    & =   \left(G- \dfrac{G^{\prime\prime} }{ 16}\, (Y^2+Z^2)+
	             \dfrac{G^{\quaprime} }{ 640}\, (Y^2+Z^2)^2\right) 
	             \left(Y^2Z-\dfrac{Z^3 }{ 3} \right)   \\
\text{with } G_0 &   =  \dfrac{ B_0}{ R^2_0}
\end{align*}

\noindent Outside fringe field regions, or everywhere in sharp edge sextupole 
($ \lambda_E=\lambda_ S=0$),   $ \vec  B(X,Y,Z) $ in the magnet is given by 

\begin{align*}
	B_X &   =     0 \\
	B_Y &   =    2G_0YZ \\
	B_Z &   =     G_0(Y^2-Z^2)  
\end{align*}
\vfill

%%%%%%%%%%%%%%figure%%%%%%%%%%%%%%
\begin{figure}[H]
%\vspace{12 truecm}
%%%Figure 29
\centerline{\includegraphics[height=12cm,angle=-90]{Fig29.ps}}
\caption{\label{fig29}Sextupole magnet}
\end{figure}
\vfill

\newpage

\subsubsection*{SOLENOID: Solenoid (Fig.~\protect\ref{fig30}) } \label{SOLENOID} \index{SOLENOID} 

 The solenoidal magnet has an effective length $ XL$,  a mean radius
$ R_0 $ and an asymptotic field $ B_0=\mu_ 0NI $ \\
($ NI $  = number of Ampere-Turns, $\mu_ 0=4\pi  10^{-7} $). 
\medskip

\noindent The distance of ray-tracing beyond the effective length $ XL$,   is 
$X_E $ at the entrance, and $ X_S $ at the exit (Fig.~\ref{fig30}).   
\medskip

\noindent The field $ \vec  B(X,r)$, $r=(Y^2+Z^2)^{1/2} $, and its derivatives
up to the second order with respect to $ X$, $Y $ or $ Z $ are obtained after the method proposed 
in ref.~\cite{Biblio17}, %%% [17]
that involves the three complete elliptic integrals $K$, $E $ and $\Pi$. These 
are calculated with the algorithm proposed in the same reference. Their 
derivatives are calculated by means of recursive relations~\cite{Biblio18}.  %%[18] 
\medskip

\noindent This analytical model for the solenoidal field allows simulating an 
extended range of coil geometry provided that the coil thickness is small 
enough compared to the mean radius $ R_0 $. 
\vfill

%%%%%%%%%%%%%%figure%%%%%%%%%%%%%%
\begin{figure}[H]
%\vspace{14 truecm}
%%%Figure 30
\centerline{\includegraphics[height=15cm,angle=-90]{Fig30.ps}}
\caption{\label{fig30} Solenoidal magnet.}
\end{figure}
\vfill
\newpage

\subsubsection*{TOSCA: 2-D or 3-D Cartesian Uniform Mesh Field Map} \label{TOSCA} \index{TOSCA}

 \textsl{TOSCA} is dedicated to the reading and treatment of 2-D or 
3-D Cartesian mesh field maps as  delivered by the
\textsl{TOSCA}  magnet computer code standard output.
\bigskip

\noindent The total number of field data files to be read is given by the 
parameter $IZ$ that appears in the data list following the keyword. 
Each file contains the field components $B_X$, $B_Y$, $B_Z$ on an 
($X$, $Y$) mesh at a given $Z$ coordinate. $IZ = 1$ for 2-D~maps, and 
in this case $B_X$ and $B_Y$ are assumed to be zero. For 3-D~maps with 
mid-plane symmetry, $IZ$ should be greater than~1, and thus, the first 
data file, whose name follows in the data list, contains the median 
plane field (assuming $ Z=0 $ and  $ B_X=B_Y=0$), while the next 
files contain the next maps in increasing Z order. For 3-D~maps without 
mid-plane symmetry assumption, $IZ$ should be odd and negative, and 
thus, the total number of maps (whose names follow in the data list) 
is $|IZ|$, while the map number $[IZ/2]+1$ is the $Z = 0$ one.
\bigskip

\noindent The field map data files should be formatted following the \FORTRAN reading 
sequence below.

{\footnotesize
\begin{verbatim}
	   DO  1  K = 1, KZ
	     OPEN (UNIT = NL, FILE = FNAME, STATUS = `OLD' [,FORM='UNFORMATTED'])
	     DO  1  J = 1,  JY  
	       DO  1 I = 1, IX
                 IF (BINARY) THEN
                   READ(NL) Y(J), Z(K), X(I), BY(I,J,K), BZ(I,J,K), BX(I,J,K)
                 ELSE
	           READ(NL,100) Y(J), Z(K), X(I), BY(I,J,K), BZ(I,J,K), BX(I,J,K)
    100	           FORMAT(1X,6E11.2)
                 ENDIF
     1     CONTINUE
\end{verbatim}}
\medskip

\noindent where, $IX$  ($JY$, $KZ$) is   the number of longitudinal 
(transverse, vertical) nodes of the 3-D uniform mesh. For binary files, 
FNAME must begin with `B\_ ', `BINARY' will then be `.TRUE.'.  
\bigskip

\noindent The field $ \vec  B=(B_X,B_Y,B_Z) $ is normalized by means of 
\textsl{BNORM}in a similar way as in \textsl{CARTEMES\index{CARTEMES}}.  
\bigskip

\noindent At each step of the trajectory of a particle inside the map, the
field and its derivatives are calculated by means of a second order polynomial fit with a 
$3  \times   3   \times   3$-point parallelipipedic grid, as described in 
section~\ref{sec2.4.4}. 
\bigskip

\noindent Entrance and/or exit integration boundaries between which the trajectories
are integrated in the field may be defined, in the same way as in  \textsl{CARTEMES\index{CARTEMES}}. 

\newpage

\subsubsection*{TRANSMAT:  Matrix   Transfer}\label{TRANSMAT}\index{TRANSMAT}

\textsl{TRANSMAT} performs a matrix transfer of the particle coordinates 
in the following way 

$$ X_i = \sum_j R_{ij}X^0_j + \sum_{j,k} T_{ijk}X^0_jX^0_k $$
%
 where, $ X_i $ stands for any of the current coordinates $ Y$, $T$, $Z$, $P $, path length and dispersion, and $ X^0_i $ stands for any of the initial coordinates.
$[R_{ij}]$ ($[T_{ijk}]$) is the first order (second order) 
transfer matrix as usually involved in second order beam optics~\cite{Biblio10}.      %%% [10]  
Second order transfer is optional.  The length of the element represented by 
the matrix may be introduced for the purpose of path length updating.  
\medskip
Note : \textsl{MATRIX\index{MATRIX}} delivers $[R_{ij}]$ and $[T_{ijk}]$ matrices in a format 
suitable for straightforward use with \textsl{TRANSMAT}.
\newpage

\subsubsection*{TRAROT: Translation-Rotation} \label{TRAROT} \index{TRAROT}

This procedure transports particles into a new frame by translation and rotation. Effect on spin tracking, 
particle decay and gas-scattering are taken into account (but not on synchrotron radiation).
\newpage

\subsubsection*{UNIPOT: Unipotential Electrostatic Lens} \label{UNIPOT} \index{UNIPOT}

The lens is cylindrically symmetric about the $ X$-axis.  
\bigskip

\noindent The length of the first (resp. second, third) electrode is $ X1 $
(resp. $ X2$, $X3$). The distance between the electrodes is $ D$.  
The potentials are $ V1 $ and $V2$.  The inner radius is $ R_0 $ (Fig.~\ref{fig31}).  
The model of electric potential along the axis is~\cite{Biblio19}  %% [19]

$$ V(x) = 
    \dfrac{V2-V1 }{ 2\omega D} 
    \left[\ell n\, \text{ch} 
    	\dfrac{\omega \left(x+ \frac{X2}{ 2}+D \right) }{ R_0}\: %
       \text{ch} \dfrac{\omega \left(x+\frac{X2 }{ 2}\right) }{ R_0}  
    + \ell n\,  \text{ch} \dfrac{\omega \left(x-\frac{X2 }{ 2}-D\right) }{R_0} \:%
       \text{ch} \dfrac{\omega \left(x-\frac{X2 }{ 2}\right) }{R_0} 
     \right]  $$
%
($ x  = $ distance from the center of the central electrode;
$\omega$  = 1,318; ch = hyperbolic cosine), from which the field $ \vec  E(X,Y,Z) $ and its
derivatives are deduced following the procedure described in section~\ref{sec2.5.2}. 

\noindent Use \textsl{PARTICUL\index{PARTICUL}} for the definition of the particle mass and
charge
\vfill

%%%%%%%%%%%%%%figure%%%%%%%%%%%%%%
\begin{figure}[H]
%\vspace{14 truecm}
%%%Figure 31
\centerline{\includegraphics[height=15cm,angle=-90]{Fig31.ps}}
\caption{\label{fig31}Three-electrode cylindrical unipotential lens.}
\end{figure}
\vfill

\newpage

\subsubsection*{VENUS: Simulation of a Rectangular Dipole Magnet}  \label{VENUS}
\index{VENUS} 

\textsl{VENUS} is dedicated to a `rough' simulation
of Saturne Laboratory's  \textsl{VENUS} 
dipole.  The field $ B_0 $ is constant inside the magnet, with longitudinal 
extent $ XL $ and transverse extent $ \pm YL $;  outside these limits, $ B_0=0$ 
(Fig.~\ref{fig32}).  

\vfill
%%%%%%%%%%%%%%figure%%%%%%%%%%%%%%
\begin{figure}[H]
%\vspace{18 truecm}
%%%Figure 32
\centerline{\includegraphics[height=15cm,angle=-90]{Fig32.ps}}
\caption{\label{fig32}Scheme of \textsl{VENUS} rectangular dipole.}
\end{figure}
\vfill

\newpage

\subsubsection*{WIENFILT: Wien Filter}\label{WIENFILT} \index{WIENFILT}

\textsl{WIENFILT} simulates a Wien Filter, with transverse and
orthogonal electric and magnetic fields $ \vec  E_Y$,  $ \vec  B_Z $ or $ \vec  E_Z$, 
 $ \vec  B_Y$ (Fig.~\ref{fig28}).
 It must be preceded by \textsl{PARTICUL\index{PARTICUL}} for the definition of the particle mass and charge.  
\bigskip

\noindent The length $ XL $ of the element is the distance between its
entrance and exit EFB's. The electric and magnetic field intensities $ E_0 $ and $ B_0 $ in the 
central, uniform field region, normally verify the relation
 
 $$ B_0= - \dfrac{E_0 }{ \beta_ Wc} $$
%
 for the selection of `` wanted''  particles of velocity $\beta_Wc $. Ray-tracing in 
field fall-off regions extends over a distance $ X_E $ $ (X_S) $ beyond the
entrance (exit) EFB by means of prior and further automatic changes of frame. Four sets
of coefficients $\lambda$, $ C_0-C_5 $ allow the description of the entrance and exit fringe 
fields outside the uniform field region, following the model~\cite{Biblio12} %% [12]

\begin{gather*}
	F = \dfrac{1 }{ 1+ \exp(P(s))} \\
	\intertext{where $  P(s) $ is of the term}
	    P(s) = C_0
	       +C_1 \left(  \dfrac{s }{ \lambda} \right) 
	       +C_2 \left( \dfrac{s }{ \lambda} \right)^2 
	       + C_3 \left( \dfrac{s }{ \lambda} \right)^3 
	       +C_4 \left( \dfrac{s }{ \lambda} \right)^4 
	       + C_5 \left(\dfrac{s }{ \lambda} \right)^5 
\end{gather*}
%
and $ s $ is the distance to the EFB.  When fringe fields overlap
inside the element (\emph{i.e.} $ XL\leq X_E+X_S$),  the field fall-off is expressed as

$$ F = F_E + F_S -1 $$
%
 where $ F_E(F_S) $ is the value of the coefficient respective to the entrance (exit) EFB. 
 
\noindent If $ \lambda_ E=0 $  ($\lambda_ S=0$)  for either the electric or
magnetic component, then both are considered as sharp edge fields and $ X_E(X_S) $ is forced 
to zero (for the purpose of saving computing time).  In this case, the magnetic wedge angle vertical first order focusing effect is simulated at entrance and exit by a kick $P_2 = P_1 - Z_1 \tan (\epsilon / \rho)$ applied to each particle ($P_1$, $P_2$ are the vertical angles upstream and downstream the EFB, $Z_1$ the vertical particle position at the EFB, $\rho$ the local horizontal bending radius and $\epsilon$ the wedge angle experienced by the particle ; $\epsilon$ depends on the horizontal angle T). This is not done for the electric field, however it is advised not to use a sharp edge electric dipole model since this entails non symplectic mapping, and in particular precludes focusing effects of the non zero longitudinal electric field component.

\newpage

\subsubsection*{YMY: Reverse Signs of  $ Y $ and  $ Z $ Axis} \label{YMY} \index{YMY}

\textsl{YMY}  performs a 180$^\circ$ rotation of particle coordinates with respect to the 
$ X $-axis, as shown  in Fig.~\ref{fig33}. 
This is done by means of a change of sign of $ Y $ and $ Z $ axes,  
and therefore coordinates, as follows 

$$ Y2=-Y1,\quad T2=-T1,\quad Z2=-Z1 \quad \text{and} \quad P2=-P1 $$

\vfill
%%%%%%%%%%%%%%figure%%%%%%%%%%%%%%
\begin{figure}[H]
%\vspace{18 truecm}
%%%Figure 33
\centerline{\includegraphics[height=15cm,angle=-90]{Fig33.ps}}
\caption{\label{fig33}\mbox{The use of $ YMY $ in a sequence of two identical
dipoles of opposite signs.}}
\end{figure}
\vfill

\newpage  %%%%% 

\subsection{Output Procedures} \label{sec4.5}

 These procedures are dedicated to the printing of particle coordinates, 
histograms, spin coordinates, etc. They may be called for at any spot in the data pile. 

\newpage

 
\subsubsection*{CLORB: Beam Centroid Path; Closed Orbit}%
\label{CLORB} \index{CLORB}

\noindent \textsl{CLORB} computes the beam centroid path, from average value of particle coordinates as observed at \textsl{LABEL}'ed\index{LABEL} keywords.

\medskip
\noindent In conjunction with \textsl{REBELOTE}\index{REBELOTE}, this procedure computes the closed orbit in 
the periodic structure delimited with \textsl{REBELOTE}, by the same means.

\medskip
\noindent The \textsl{LABEL} list of concern constitutes the information contained in the data record  that 
follows the keyword  \textsl{CLORB}.


\newpage

\subsubsection*{FAISCEAU, FAISCNL, FAISCNLA:  Print/Store Particle Coordinates} \label{FAISCEAU}\label{FAISCNL}
 \label{FAISCNLA}\index{FAISCEAU} \index{FAISCNL}\index{FAISCNLA}


\textsl{FAISCEAU}  can be introduced anywhere in a structure.  It produces a print 
of  initial and actual coordinates of the particles at the location where it stands, together with their 
tagging indices and letters, following the same format as for \textsl{FAISCNL} (except 
for \textsl{SORT(I)}   which is not printed) .  
\bigskip

\noindent\textsl{FAISCNL} has a similar effect, except that the information is stored in a 
dedicated file \textsl{FNAME} (standard name is \textsl{FNAME} = `zgoubi.fai' \index{zgoubi.fai}
for post-processing with \textbf{zgplot}\index{zgplot}).  This file may further on be read by means of  \textsl{OBJET}, 
option \mbox{\KOBJ= 3}, or used for other purposes such as graphics (see Part~D of the Guide).  The data written to that file are formatted and  ordered 
according to the \FORTRAN sequence below

{\footnotesize
\begin{verbatim}
	  OPEN (UNIT = NL, FILE = FNAME, STATUS = `NEW')
	  DO  1  I=1, IMAX
	    WRITE(NL,100) LET(I),IEX(I),(FO(J,I),J=1,6),(F(J,I),J=1,6),I(I),IREP(I),SORT(I),DUM,DUM,RET(I), DPR(I), IPASS
100	    FORMAT(1X, A1, 1X, I2, 1P, 6E16.8, /, 6E16.8, 2I3, /,1X, 5E16.8, I6)
    1     CONTINUE
\end{verbatim}}
\medskip

\noindent The meaning of these parameters is the following (see the keyword \textsl{OBJET})
\bigskip


{\renewcommand{\arraystretch}{1}
 \begin{tabular}{>{\sl}l!{:}l}
	$LET(I) $  & one-character string, for tagging particle number $I$  \\
	$IEX$, $I$, $IREP(I)$   &  flag, particle number, index  \\
	 $FO(1-6, I)$  &  coordinates $D$, $Y$, $T$, $Z$, $P$ and path
	                 length at the origin of the structure\\
	 $F(1-6, I)$  &  idem, at the current position\\
     $SORT(I)$ & path length at which the particle has eventually been stopped\\
      \multicolumn{1}{c}{  }       & (see \textsl{CHAMBR} or \textsl{COLLIMA})\\
     $DUM$  &  dummy\\
     $RET(I)$, $DPR(I)$ & synchrotron phase space coordinates; \textsl{RET} =phase (radian),\\
      \multicolumn{1}{c}{  }     &   \textsl{DPR} = momentum dispersion (MeV/c) (see \textsl{CAVITE}).\\
    \textsl{IPASS}  &  turn number (see \textsl{REBELOTE\index{REBELOTE}})
     \end{tabular}}
\bigskip

\noindent\textsl{FAISCNLA} has an effect similar to \textsl{FAISCNL}, with two 
more features. On the first data line, \textsl{FNAME} may be followed 
by a series of up to 10 \textsl{LABEL}'s \index{LABEL} proper to the elements of the data 
file at the exit of which the print should occur; if there is no 
label, the print occurs by default at the location of \textsl{FAISCNLA}; if there are labels the 
print occurs right downstream the optical element wearing those labels
 (and no longer at the \textsl{FAISCNLA} location). The next data line 
gives a parameter $IP$: printing will occur every $IP$ other pass, if 
using \REBELOTE\index{REBELOTE} with \textsl{NPASS}\index{NPASS} $ \geq IP-1$. For 
instance the data list
\medskip

{\renewcommand{\arraystretch}{1}
\begin{tabular}{lll}
	\textsl{FAISCNLA} &  &   \\
	zgoubi.fai \index{zgoubi.fai} & \textsl{HPCKUP} & \textsl{VPCKUP}  \\
	12 &  & 
\end{tabular}}
\medskip

\noindent will result in output prints into zgoubi.fai, every 12~other 
pass, each time elements of the zgoubi.dat \index{zgoubi.dat} data list labeled either \textsl{HPCKUP}
or \textsl{VPCKUP} are encountered.

\newpage

\subsubsection*{FOCALE, IMAGE[S]: Coordinates and Beam Dimension, Localization and
Size  of  Horizontal Waist}\label{FOCALE}\label{IMAGE}\label{IMAGES}
\index{FOCALE}\index{IMAGE}\index{IMAGES}

\textsl{FOCALE}  calculates the dimensions of the beam and its mean 
transverse position, at a longitudinal distance $ XL $ from the position 
corresponding to the keyword \textsl{FOCALE}.  
\bigskip

\noindent\textsl{IMAGE}  computes the location and size
of the closest horizontal waist.  
\bigskip

\noindent\IMAGES\index{IMAGES}  has the same effect as \textsl{IMAGE\index{IMAGE}},
 but, in addition, for a 
non-monochromatic beam it calculates as many waists as there are distinct momenta in 
the beam, provided that the object has been defined with a classification of momenta 
(see \textsl{OBJET\index{OBJET}}, \KOBJ = 1, 2  for instance).  
\bigskip

\noindent Optionally, for each of these three procedures, \zgou\ can
list a trace of the coordinates in the $ X$, $Y $ and in the $ Y$, $Z $ planes.  
\bigskip

\noindent The following quantities are calculated for the $ N $ particles of
the beam (\textsl{IMAGE,   FOCALE}) or of each group    of momenta 
(\textsl{IMAGES\index{IMAGES}})  
\bigskip

\begin{itemize}
\item[$\bullet$]Longitudinal position: 
       \begin{align*}
       \text{\textsl{FOCALE}:} & \quad  X=XL  \\
       \text{\textsl{IMAGE[S]}:} & \quad   X    = - 
    \dfrac{ \sum^ N_{i=1}Y_i\ast tgT_i- 
         \left( \sum^ N_{i=1}Y_i\ast \sum^N_{i=1}tgT_i \right)\, /N }{%
        \sum^ N_{i=1}tg^2T_i- \left( \sum^ N_{i=1}tgT_i\right)^2\, /N} \\ 
            & Y   =   Y_1+X  \ast   \text{tg} T_1  
        \end{align*}    
where $ Y_1 $ and $ T_1 $ are the coordinates of the first particle
of the beam (\textsl{IMAGE, FOCALE}) or the first particle of each group of momenta 
(\textsl{IMAGES\index{IMAGES}}). 

\item[$\bullet$]Transverse position of the center of mass of the waist 
(\textsl{IMAGE[S]}) or of the beam (\textsl{FOCALE}), with respect to the reference trajectory 

$$ YM = \frac{1 }{ N} \sum^ N_{i=1}(Y_i+X  \text{tg} T_i)-Y=
      \frac{1 }{ N} \sum^ N_{i=1}Y\, M_i $$

\item[$\bullet$]FWHM of the image (\textsl{IMAGE[S]}) or of the beam 
(\textsl{FOCALE}), and  total width, respectively, $ W $ and $ WT $

\begin{align*}
	W &   =     2.35 \left( \dfrac{1 }{ N} \sum^ N_{i=1}Y\ M^2_i - Y\ M^2 \right)^{\frac{1}{2}} \\ 
	WT &   =    \max (YM_i)- \min  (YM_i)  
\end{align*}
\end{itemize}

\vfill

\subsubsection*{FOCALEZ, IMAGE[S]Z: Coordinates and Beam Dimensions, Localization 
           and Size of Vertical Waist}\label{FOCALEZ}\label{IMAGEZ}\label{IMAGESZ}
 \index{FOCALEZ}\index{IMAGEZ}\index{IMAGESZ} 
          
Similar to \textsl{FOCALE} and \textsl{IMAGE[S]}, but the calculations are performed 
with respect to the vertical coordinates $ Z_i $ and $ P_i $, in place of $Y_i $ 
and $ T_i$. 
\vfill

\newpage

\subsubsection*{HISTO: 1-D  Histogram}\label{HISTO} \index{HISTO}

Any of the coordinates used in \zgou\ may be histogrammed,
namely initial  $ Y_0$,  $ T_0$,  $ Z_0$,  $ P_0, $ $ S_0 $, $ D_0 $  or actual 
$ Y$, $T$, $Z$, $P$, $S$, $D$ particle coordinates ($ S=$ path length ;  
$ D $ may change  in decay process simulation with \textsl{MCDESINT\index{MCDESINT}}, 
or when ray-tracing in $ \vec  E $ fields), and also spin coordinates and
modulus $ S_X$, $ S_Y$,  $ S_Z $ and $ \left\Vert\vec  S \right\Vert   $.  
\bigskip

\noindent\textsl{HISTO\index{HISTO}}  can be used in conjunction with 
\textsl{MCDESINT\index{MCDESINT}}, for statistics 
on the decay process, by means of \textsl{TYP}.  \textsl{TYP} is a one-character 
variable.  If it is set equal to `S', only secondary particles will be 
histogrammed.  If it is set equal to `P', then only  primary particles will be histogrammed.  
For no discrimination  between S-econdary and P-rimary particles,  \textsl{TYP} = `Q'  must be
used.  
\bigskip

\noindent The dimensions of the histogram (number of lines and columns) may be
modified. It can be normalized with \textsl{NORM} = 1, to avoid saturation.  
\bigskip

\noindent Histograms are indexed with the parameter  $NH$.  This allows making
independent histograms of the same coordinate at several spots  
in a structure.  This is also useful when piling up problems in an input data 
file  (see also \textsl{RESET}). $NH$ is in the range 1-5.  
\bigskip

\noindent If \REBELOTE\index{REBELOTE} is used, the statistics on the $1+$\textsl{NPASS}\index{NPASS}
runs in the structure will add up. 

\vfill
\subsubsection*{IMAGE[S][Z]:  Localization and size of Vertical Waist} 

\noindent See FOCALE[Z]. 
\vfill
\newpage

\subsubsection*{MATRIX:  Calculation of Transfer Coefficients}\label{MATRIX} \index{MATRIX}

\textsl{MATRIX}  causes the calculation of the transfer coefficients of the 
structure, at the spot where it is introduced in the structure, or at the closest horizontal 
focus.  In this last case the position of 
the focus is calculated automatically in the same way as the position of the 
waist in \textsl{IMAGE}. Depending on option \textsl{IFOC},  \textsl{MATRIX} also
delivers the Twiss matrix and tune numbers in the hypothesis of a periodic structure.  
\bigskip

\noindent Depending on the value of option \textsl{IORD}, different procedures follow   
\bigskip

\begin{itemize}
\item[$\bullet$] If \textsl{IORD} = 0, \textsl{MATRIX}  is inhibited (equivalent to 
\textsl{FAISCEAU}, whatever \textsl{IFOC}). 

\item[$\bullet$] If \textsl{IORD} = 1, the first order transfer matrix 
$ [R_{ij}]$ is calculated, from a third order expansion of the coordinates, for instance 

\begin{align*}
	Y^+ &   =   \left( \dfrac{Y}{T_0} \right)\, T_0
	             + \left(\dfrac{Y }{ T^2_0} \right)\, T^2_0 
	             + \left(\dfrac{Y }{ T^3_0} \right)\, T^3_0  \\
	Y^- &   =    - \left(\dfrac{Y }{ T_0} \right)\, T_0 
	             + \left(\dfrac{Y }{ T^2_0} \right)\, T^2_0 -
	             \left(\dfrac{Y }{ T^3_0} \right)\ T^3_0 \\
	\intertext{which gives, neglecting third order terms}
	R_{11} &= \left(\dfrac{Y }{ T_0} \right) = \dfrac{Y^+-Y^- }{ 2T_0} 
\end{align*}


\item[$\bullet$] If \textsl{IORD} = 2, fifth order Taylor expansions are used for the 
calculation of the first order transfer matrix $ [R_{ij}] $ and
the second order matrix $[T_{ijk}]$.  Other higher order coefficients are also calculated. 
\end{itemize}

\noindent The next option, \textsl{IFOC}, acts as follows \par

\begin{itemize}
\item[$\bullet$] If \textsl{IFOC} = 0,  the transfer coefficients are calculated
at the position of \textsl{MATRIX\index{MATRIX}}, and with respect to particle 1 taken as a
reference (for instance, $ Y^+ $ and $ T^+ $ above are defined for particle $ I $ as 
$Y^+=Y^+(I)-Y(1)$,  and $ T^+=T^+(I)-T(1))$.  

\item[$\bullet$] If \textsl{IFOC} = 1, the transfer coefficients are calculated at the 
horizontal focus which is the closest to \textsl{MATRIX\index{MATRIX}} (determined 
automatically), while the reference direction is that of particle 1 (for 
instance, $ Y^+ $ is defined for particle $ I $ as $ Y^+=Y^+(I) -Y_{\text{focus}} $, 
and $ T^+ $ is defined as $ T^+=T^+(I)-T(1)$).  

\item[$\bullet$] If \textsl{IFOC} = 2, no change of reference frame is 
performed: the coordinates refer to the current frame. Namely, $ Y^+=Y^+(I)$, 
$ T^+=T^+(I)$,  etc. \

\item[$\bullet$] If \textsl{IFOC} = 10  +  \textsl{NPeriod}, \textsl{MATRIX\index{MATRIX}} calculates
the transfer coefficients of the structure, assuming that it is \textsl{NPeriod}-periodic,
and deduces the corresponding Twiss matrix and tune numbers. No change of 
reference is performed for this calculation. 
\end{itemize}

\noindent The object necessary for the calculation  of $ [R_{ij}]$ with \textsl{IORD} = 1 
    may be generated automatically by means of \textsl{OBJET\index{OBJET}}  with
option \mbox{\KOBJ= 5}.  When using 
\textsl{IORD} = 2, the object may be generated automatically with \textsl{OBJET}  and 
 \mbox{\KOBJ=  6}. 
 
\newpage
\subsubsection*{PLOTDATA:  Coordinate Output for PLOTDATA Graphic Software \protect\cite{BiblioPlot}}%
\label{PLOTDATA} \index{PLOTDATA}

To be documented.

\newpage
\subsubsection*{SPNPRNL, SPNPRNLA, SPNPRT: Print/Store Particle Spin Coordinates 
  }\label{SPNPRT}\label{SPNPRNL} \label{SPNPRNLA}
\index{SPNPRT}\index{SPNPRNL}\index{SPNPRNLA}

\textsl{SPNPRNL} has the same effect as \textsl{SPNPRT} (see 
below), except that the information is
stored in a  dedicated file \textsl{FNAME} (standard is \textsl{FNAME} = 
`zgoubi.spn' \index{zgoubi.spn}
for post-processing with \textbf{zgplot}\index{zgplot}). The data are formatted and ordered 
according to the  \FORTRAN sequence below

{\footnotesize
\begin{verbatim}
	      OPEN (UNIT = NL, FILE = FNAME, STATUS = `NEW')
	      DO  1  I=1, IMAX
	          WRITE (NL,100) LET(I), IEX(I), (SI(J,I)J=1,4), (SF(J,I),J=1,4), GAMMA, I
       100	  FORMAT(1X, A1, I2, 1P, 8E15.7, /, E15.7, 2I3, I6)
        1     CONTINUE
\end{verbatim}}
\medskip

\noindent The meaning of these parameters is the following 
\bigskip

 \begin{tabular}{>{\sl}l!{:}l}
	 LET(I),IEX(I)  &  tagging character and flag (see \textsl{OBJET}) \\
	 SI(1-4,I) & spin components $SX$, $SY$, $SZ$  and modulus, at the origin\\
	 SF(1-4,I)   &  idem, at the current position\\
	  GAMMA &   Lorentz relativistic factor\\
	  I  &  particle number\\
	 IMAX &  total number of particles ray-traced (see  \textsl{OBJET})\\
	 IPASS &  turn number (see \textsl{REBELOTE})\\
 \end{tabular}
\bigskip

\noindent\textsl{SPNPRNLA} has an effect similar to \textsl{SPNPRNL}, with 
one more feature. The  line next to  \textsl{FNAME}  gives a parameter $IP$ 
printing will occur every $IP$ other pass, when 
using \REBELOTE\index{REBELOTE} with \textsl{NPASS}\index{NPASS} $ \geq IP-1$. 
\bigskip

\noindent\textsl{SPNPRT} can be introduced anywhere in a structure. It produces
a listing (into zgoubi.res) of the initial and actual coordinates and modulus of the spin of the \IMAX\index{IMAX}
particles, at the location where it stands, together with their Lorentz factor $\gamma$, following the format detailed above. 
The mean values of the spin components are also printed. 


 \newpage

\subsection{Complementary Features} \label{sec4.6}  

\subsubsection{Backward Ray-tracing} \label{sec4.6.3}\index{backward ray-tracing}\index{XPAS, negative}

For the purpose of parameterization for instance, it may be interesting to ray-trace 
backward  from the image toward the object.  This can be performed by first 
reversing the position of optical elements in the structure, and then 
reversing the integration step sign in all the optical elements.  
\bigskip

\noindent An illustration of this feature is given in the following
Figure~\ref{fig36}.    


%%%%%%%%%%%%%%figure%%%%%%%%%%%%%%
\begin{figure}[H]
%\vspace{16 truecm}
%%%Figure 36
\centerline{\includegraphics[height=12cm,angle=-90]{Fig36.ps}}
\hangcaption[Fig36]{\label{fig36}A. Regular forward ray-tracing, from object to image.\\
B. Same  structure, with backward ray-tracing from image to object: negative integration step XPAS is used in  the quadrupole.}
\end{figure}


\subsubsection{Checking Fields and Trajectories in Magnets}  \label{sec4.6.1}
\index{checking field}\index{checking trajectories}

In all magnetic elements, an option index $ IL $\index{IL} is available.  It
is normally set to 0 and in this case has no effect.

\noindent $ IL=1 $ causes a print  in zgoubi.res \index{zgoubi.res} of particle 
coordinates and field
along trajectories in the magnet.  In the meantime, a calculation and summation of
the values of $ \vec  \nabla \cdot\vec  B$, 
 $ \vec  \nabla \times\vec  B $ and $ \nabla^2\vec  B $ at all 
integration steps is performed, which allows a check of the behavior of 
$ \vec  B $ in field maps (all these derivatives should normally be zero).

\noindent $ IL=2 $ causes a print   of particle coordinates and other 
informations in zgoubi.plt \index{zgoubi.plt} which can further be processed with 
\textbf{zgplot}\footnote{See Part D of the Guide.}\index{zgplot}.
\bigskip

\noindent When dealing with maps (e.g., \textsl{CARTEMES\index{CARTEMES}}, \textsl{ELREVOL
\index{ELREVOL}}), another option index $ IC $\index{IC} is available.
  It is normally set to 0 and in this case has no effect.
 
\noindent $ IC=1 $ causes a print of the field map in zgoubi.res. \index{zgoubi.res}

\noindent $ IC=2 $ will cause a print   of field maps in zgoubi.map \index{zgoubi.map}
which can further be processed with \textbf{zgplot}\addtocounter{footnote}{-1}\footnotemark.
 



 \subsubsection{Labeling keywords}\label{sec4.6.8}\index{LABEL}
 
Keywords in \zgou\ data file zgoubi.dat can be \textsl{LABEL}'ed, for the purpose of 
the execution of such procedures as  \textsl{CLORB}\index{CLORB}, \textsl{FAISCNL[A]}
\index{FAISCNL}\index{FAISCNLA}, \textsl{SCALING}\index{SCALING}. 

\noindent Each keyword accepts two \textsl{LABEL}'s, of which the first one is used for the 
above mentioned purpose.


\newpage


\subsubsection{Multiturn tracking in circular machines} \label{sec4.6.5}

Multiturn\index{multiturn} tracking \index{multiturn tracking} in circular machines can be performed by
means of the keyword \textsl{REBELOTE\index{REBELOTE}}, put at the end of the optical structure 
with its argument \textsl{NPASS}$+1$\index{NPASS} being the number of turns to be 
performed. In order that the \IMAX\index{IMAX} particles of the beam start a new 
turn with the coordinates they have reached at the end of the 
previous one, the option $ K=99 $ has to be specified in \textsl{REBELOTE\index{REBELOTE}}.
\bigskip

\noindent\textbf{Synchrotron acceleration} can be simulated, following the 
procedure below  
\begin{itemize}
\item[-] \textsl{CAVITE\index{CAVITE}} appears at the end of the structure (before
\textsl{REBELOTE\index{REBELOTE}}), with option \textsl{IOPT}$=1$ 

\item[-] the R.F.\ frequency of the cavity is given a timing law by 
means of \textsl{SCALING\index{SCALING}}, family \textsl{CAVITE}

\item[-] the magnets are given the same timing law $ B\rho (T)$,  
(where $T=1 $ to \textsl{NPASS}$+1$ is the turn number) by means of \textsl{SCALING}. \par
\end{itemize}

\noindent Eventually some families of magnets may be given a law which does 
not follow $ B\rho (T)$,  for the simulation of special processes (e.g.\ 
fast crossing of spin resonances with independent families of 
quadrupoles). 

%\noindent This is illustrated in the example~6 of Part~C.  %%%% ref




\subsubsection{Positioning of Magnets and field maps} \label{sec4.6.2} 

The last record in most magnets and field maps is the positioning flag 
\textsl{KPOS}, followed by the parameterss \textsl{XCE}, \textsl{YCE} for translation and \textsl{ALE} for rotation. The positioning works in two different ways, depending on whether they are defined in 
Cartesian $ (X, Y, Z) $ coordinates (e.g., \textsl{QUADRUPO\index{QUADRUPO}, TOSCA\index{TOSCA}}),
 or polar 
 ($R$, $\theta$, $Z$)  coordinates (\textsl{DIPOLE\index{DIPOLE}}). 
 
 \subsubsection*{Cartesian Coordinates:} 
 
 If \textsl{KPOS} $ =1$,  the $ X $-axis of the element coincides with 
the $ X $-axis of the incoming reference. 

\noindent If  \textsl{KPOS} $=2 $, the shifts   \textsl{XCE}\index{XCE}   
and   \textsl{YCE}\index{YCE}, and the tilt angle \textsl{ALE}\index{ALE}   are taken into 
account, for the positioning of the element with respect to the incoming 
reference, as shown in Fig.~\ref{fig34}.  
\textsl{KPOS} $ = 2$ can  also be used to simulate a misalignment.\index{misalignment} 
The effect is equivalent to a  \textsl{CHANGREF} transformation placed right upstream the magnet,
followed by the reverse transformation right downstream.

\noindent \textsl{KPOS} $=3 $ option is available for some magnets (e.g., \textsl{BEND}, \textsl{MULTIPOL}); it positions automatically the magnet in the  following way, convenient for periodic structures. It is effective only if a non zero dipole component $B_1$ is present; 
entrance and exit frames are shifted by \textsl{YCE} (\textsl{XCE} is not used) and tilted w.r.t. the magnet by an angle

 $\bullet$ either ALE/2 if ALE$\not =$0

 $\bullet$ or by  half the deviation $\theta/2$ such that $ L = 2 \frac{\text{\textsl{BORO}}}{B1} \sin({\theta}{2})$ if ALE=0 (L = magnet length, \textsl{BORO}  = reference rigidity as defined in \textsl{OBJET\index{OBJET}}).
\noindent This is equivalent to the sequence \textsl{CHANGREF(0,0,-$\theta$/2)},  \textsl{CHANGREF(0,YCE,0)} right upstream the magnet, followed  by \textsl{CHANGREF(0,-YCE,-$\theta$/2)}.

 \subsubsection*{Polar Coordinates} 
 
 If  \textsl{KPOS} $=1$,  the element is positioned automatically in such a way
that a particle entering with zero initial coordinates and 
$ 1+DP=B\rho /\text{\textsl{BORO}} $ 
relative momentum will reach position ($ RM$, $\frac{AT }{ 2} $) in 
the element with $ T=0 $ angle with respect to the moving frame in the polar 
coordinates system of the element (Fig.~\ref{fig35}; 
see \textsl{DIPOLE\index{DIPOLE}} and \textsl{POLARMES\index{POLARMES}}).

\noindent If  \textsl{KPOS} $=2, $ the map is positioned in such a way that the 
incoming particle will enter it at radius $ RE $ with angle $ TE $.  
The reference frame of \zgou\  is positioned in a similar way with 
respect to the map, at the exit face, by means of 
the two parameters $ RS $ (radius) and $ TS $ (angle) (see Fig.~\ref{fig9}A.).  


 \subsubsection{Coded integration step\index{XPAS, coded}} 

In several optical elements (e.g., all multipoles, \textsl{BEND}) the integration step (in general noted \textsl{XPAS}) can be coded under the form \textsl{XPAS} = b.fffE10 in order to allow two different step sizes in the uniform part of the filed (the magnet body) and in the field fall-off regions. b is an arbitrary integer and fff is a 3-digit integer; they give the number of steps respectively in the body and fringe field regions. For instance 120.012E10 requests 120 steps in the body and 12 in the fringe field regions. The maximum allowed value for fff is 999 steps.

\newpage

%%%%%%%%%%%%%%figure%%%%%%%%%%%%%%
\vfill
\begin{figure}[H]
%\vspace{8 truecm}
%%%Figure 34
\centerline{\includegraphics[height=15cm,angle=-90]{Fig34.ps}}
\caption{\label{fig34}\mbox{Positioning of a Cartesian coordinate optical element
when  \textsl{KPOS}$=2 $.}}
\end{figure}
\vfill

%%%%%%%%%%%%%%figure%%%%%%%%%%%%%%
\begin{figure}[H]
%\vspace{12 truecm}
%%%Figure 35
\centerline{\includegraphics[height=15cm,angle=-90]{Fig35.ps}}
\caption{\label{fig35}Positioning of a polar field map when  \textsl{KPOS}$=1 $.}
\end{figure}


\newpage



\subsubsection{Ray-tracing of an arbitrarily large number of particles} %
      \label{sec4.6.4}

Monte Carlo\index{Monte Carlo} multiparticle \index{multiparticle} simulations involving an 
arbitrary number of particles
can be performed by means of \textsl{REBELOTE\index{REBELOTE}}, put at the end of the optical
structure, with its argument \textsl{NPASS}\index{NPASS} being the number of passes through 
\textsl{REBELOTE\index{REBELOTE}}, and (\textsl{NPASS}$+ 1$) * \textsl{IMAX\index{IMAX}}  
the number of particles to 
be ray-traced. In order that new initial conditions  ($D$, $Y$, $T$, $Z$, 
$P$, $X$) 
 be generated at each pass, $ K=0 $ has to be specified in \textsl{REBELOTE\index{REBELOTE}}.
 
\noindent Statistics on coordinates, spins, and other histograms can be
performed by means of such procedures as \textsl{HISTO\index{HISTO}, SPNTRK\index{SPNTRK}}, 
etc. that stack the information from pass to pass. 


\subsubsection{Stopped particles: the IEX flag} \label{sec4.6.6} \index{IEX}\index{stopped particles}

As described in \textsl{OBJET\index{OBJET}}, each particle $I=1$, \textsl{IMAX\index{IMAX}}
 is attached a
value $IEX(I)$ of the \textsl{IEX} flag. Normally, $IEX(I)=1$. Under certain 
circumstances, \textsl{IEX} may take negative values, as follows

\begin{itemize}
\item[-]1 :  the trajectory happened to wander outside the limits of a field map 
\item[-]2 : too many integration steps in a field map  
\item[-]3 :  deviation happened to exceed $\dfrac{\pi}{2} $ in an optical element 
\item[-]4 :  stopped in chamber walls (by the procedures \textsl{CHAMBR, COLLIMA})  
\item[-]5 :  too many iterations in subroutine \textsl{DEPLA}  
\end{itemize}


\noindent Only in the case $IEX=-1$ will the particle not be stopped. \index{stopped}

\subsubsection{Negative rigidity} \label{sec4.6.7}  \index{negative rigidity} 
\index{negative charge}\index{negative momentum}

\zgou\ can handle negative rigidities $B\rho = p/q$. This is equivalent to 
considering either particles of negative charges ($q<0$), or counter 
going particles ($p<0$), or virtually reversed fields (w.r.t.~the field sign 
that shows in the optical element data list).

\noindent Negative rigidities may be specified in terms of 
\textsl{BORO} $<0$ or $D=B \rho / \text{\textsl{BORO}} < 0$ when 
defining the initial coordinates with \textsl{OBJET}\index{OBJET} and 
\textsl{MCOBJET}\index{MCOBJET}.
